---
title: åª’ä½“æ–‡ä»¶å­˜å‚¨è®¾è®¡æ–¹æ¡ˆ
author: wangxiao
company: å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€
date: 2025-10-08
permalink: claudedocs/ä¼å¾®åª’ä½“å­˜å‚¨è®¾è®¡
---

# åª’ä½“æ–‡ä»¶å­˜å‚¨è®¾è®¡æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

1. [å½“å‰æ–¹æ¡ˆï¼šåŸºäºSmartAdminæ–‡ä»¶ç³»ç»Ÿ](#å½“å‰æ–¹æ¡ˆåŸºäºsmartadminæ–‡ä»¶ç³»ç»Ÿ)
2. [ä¼å¾®ä¼šè¯å­˜æ¡£é›†æˆ](#ä¼å¾®ä¼šè¯å­˜æ¡£é›†æˆ)
3. [é…ç½®ä¸ä½¿ç”¨](#é…ç½®ä¸ä½¿ç”¨)
4. [æœªæ¥å¢å¼ºè§„åˆ’](#æœªæ¥å¢å¼ºè§„åˆ’)

---

## å½“å‰æ–¹æ¡ˆï¼šåŸºäºSmartAdminæ–‡ä»¶ç³»ç»Ÿ

### è®¾è®¡è¯´æ˜

**å¤ç”¨ç°æœ‰è®¾è®¡ï¼Œé›¶å¼€å‘æˆæœ¬** âœ…

SmartAdmin å·²å†…ç½®å®Œå–„çš„æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼Œæ”¯æŒæœ¬åœ°å­˜å‚¨å’Œäº‘å­˜å‚¨ï¼ˆS3å…¼å®¹åè®®ï¼‰ï¼Œæ»¡è¶³å½“å‰éœ€æ±‚ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… **file_key æŠ½è±¡**ï¼šä¸šåŠ¡å±‚ä¸æ„ŸçŸ¥å­˜å‚¨ç»†èŠ‚
- âœ… **æ¥å£è®¾è®¡**ï¼šIFileStorageService æ”¯æŒå¤šç§å­˜å‚¨åç«¯
- âœ… **é…ç½®é©±åŠ¨**ï¼šæœ¬åœ°/äº‘å­˜å‚¨ä¸€é”®åˆ‡æ¢
- âœ… **S3å…¼å®¹**ï¼šæ”¯æŒ MinIOã€é˜¿é‡Œäº‘OSSã€è…¾è®¯äº‘COSã€AWS S3

---

### æ•°æ®åº“è¡¨ç»“æ„

#### t_file (æ–‡ä»¶è¡¨)

**ä½ç½®**: `sa-base/module/support/file`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| file_id | bigint | æ–‡ä»¶ID | ä¸»é”®,è‡ªå¢ |
| folder_type | int | æ–‡ä»¶å¤¹ç±»å‹ | æšä¸¾: 1-é€šç”¨ 2-å…¬å‘Š 3-å¸®åŠ© 4-åé¦ˆ |
| file_name | varchar(255) | æ–‡ä»¶åç§° | åŸå§‹æ–‡ä»¶å |
| file_size | bigint | æ–‡ä»¶å¤§å° | å­—èŠ‚ |
| **file_key** â­ | **varchar(255)** | **æ–‡ä»¶æ ‡è¯†** | **ç”¨äºä¸‹è½½å’Œè®¿é—®** |
| file_type | varchar(32) | æ–‡ä»¶ç±»å‹ | jpg/png/pdf/mp4ç­‰ |
| creator_id | bigint | åˆ›å»ºäººID | ä¸Šä¼ äºº |
| creator_user_type | int | ç”¨æˆ·ç±»å‹ | |
| creator_name | varchar(128) | åˆ›å»ºäººå§“å | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
```sql
PRIMARY KEY (file_id)
UNIQUE KEY uk_file_key (file_key)
KEY idx_folder_type (folder_type)
KEY idx_creator (creator_id)
```

**è®¾è®¡è¯´æ˜**ï¼š
- `file_key`ï¼šæ–‡ä»¶å”¯ä¸€æ ‡è¯†ï¼Œæ ¼å¼ç”±å­˜å‚¨æœåŠ¡ç”Ÿæˆï¼ˆå¦‚: `public/notice/2025/01/uuid.jpg`ï¼‰
- `folder_type`ï¼šä½¿ç”¨æšä¸¾åŒºåˆ†ä¸šåŠ¡ç±»å‹
- ä¸šåŠ¡è¡¨åªéœ€å­˜å‚¨ `file_key`ï¼Œé€šè¿‡å®ƒè·å–æ–‡ä»¶URL

---

### å­˜å‚¨æŠ½è±¡å±‚

#### æ¥å£å®šä¹‰

```java
public interface IFileStorageService {

    /**
     * ä¸Šä¼ æ–‡ä»¶
     * @param file æ–‡ä»¶
     * @param path è·¯å¾„ï¼ˆç”± folder_type å†³å®šï¼‰
     * @return FileUploadVO (åŒ…å« fileKey)
     */
    ResponseDTO<FileUploadVO> upload(MultipartFile file, String path);

    /**
     * è·å–æ–‡ä»¶è®¿é—®URL
     * @param fileKey æ–‡ä»¶æ ‡è¯†
     * @return è®¿é—®URLï¼ˆæœ¬åœ°æ°¸ä¹…ï¼Œäº‘ç«¯ä¸´æ—¶ï¼‰
     */
    ResponseDTO<String> getFileUrl(String fileKey);

    /**
     * ä¸‹è½½æ–‡ä»¶
     */
    ResponseDTO<FileDownloadVO> download(String fileKey);

    /**
     * åˆ é™¤æ–‡ä»¶
     */
    ResponseDTO<String> delete(String fileKey);
}
```

#### å®ç°ç±»

| å®ç°ç±» | å­˜å‚¨ç±»å‹ | è¯´æ˜ |
|-------|---------|------|
| FileStorageLocalServiceImpl | local | æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ |
| FileStorageCloudServiceImpl | cloud | S3å…¼å®¹äº‘å­˜å‚¨ |

**è‡ªåŠ¨è·¯ç”±**ï¼š
```java
// æ ¹æ®é…ç½®è‡ªåŠ¨æ³¨å…¥å¯¹åº”å®ç°
@Bean
@ConditionalOnProperty(name = "file.storage.mode", havingValue = "local")
public IFileStorageService initLocalFileService() {
    return new FileStorageLocalServiceImpl();
}

@Bean
@ConditionalOnProperty(name = "file.storage.mode", havingValue = "cloud")
public IFileStorageService initCloudFileService() {
    return new FileStorageCloudServiceImpl();
}
```

---

### æ–‡ä»¶å¤¹ç±»å‹æšä¸¾

#### FileFolderTypeEnum

**ä½ç½®**: `sa-base/module/support/file/constant/FileFolderTypeEnum.java`

**ç°æœ‰æšä¸¾**ï¼š
```java
public enum FileFolderTypeEnum {
    COMMON(1, "public/common/", "é€šç”¨"),
    NOTICE(2, "public/notice/", "å…¬å‘Š"),
    HELP_DOC(3, "public/help-doc/", "å¸®åŠ©ä¸­å¿ƒ"),
    FEEDBACK(4, "public/feedback/", "æ„è§åé¦ˆ");
}
```

**æ–°å¢ä¼å¾®ä¼šè¯ç±»å‹**ï¼ˆå»ºè®®ï¼‰ï¼š
```java
/**
 * ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£
 */
WECOM_CHAT(5, "private/wecom-chat/", "ä¼å¾®ä¼šè¯å­˜æ¡£");
```

**è¯´æ˜**ï¼š
- `public/` å‰ç¼€ï¼šå…¬å¼€è®¿é—®ï¼Œæ°¸ä¹…URL
- `private/` å‰ç¼€ï¼šç§æœ‰è®¿é—®ï¼Œä¸´æ—¶URLï¼ˆäº‘å­˜å‚¨é¢„ç­¾åï¼‰

---

## ä¼å¾®ä¼šè¯å­˜æ¡£é›†æˆ

### è¡¨ç»“æ„è®¾è®¡

#### t_wecom_message_media (ä¼šè¯åª’ä½“æ–‡ä»¶è¡¨)

**æ ¸å¿ƒè®¾è®¡**: é€šè¿‡ `file_id` å…³è”é€šç”¨æ–‡ä»¶è¡¨ `t_file`

```sql
CREATE TABLE t_wecom_message_media (
  media_id bigint NOT NULL AUTO_INCREMENT COMMENT 'åª’ä½“ID',

  -- å…³è”æ¶ˆæ¯è¡¨
  message_id bigint NOT NULL COMMENT 'æ¶ˆæ¯ID(å…³è”t_wecom_message)',
  msg_id varchar(128) NOT NULL COMMENT 'ä¼å¾®æ¶ˆæ¯ID(å†—ä½™å­—æ®µ)',
  corp_id varchar(64) NOT NULL COMMENT 'ä¼ä¸šID',

  -- åª’ä½“ç±»å‹
  media_type varchar(32) NOT NULL COMMENT 'åª’ä½“ç±»å‹(image/voice/video/file/emotion)',

  -- ä¼å¾®SDKä¿¡æ¯
  sdk_file_id varchar(255) NOT NULL COMMENT 'ä¼å¾®SDKæ–‡ä»¶ID',
  md5sum varchar(64) COMMENT 'æ–‡ä»¶MD5å€¼',

  -- å…³è”é€šç”¨æ–‡ä»¶è¡¨
  file_id bigint COMMENT 'æ–‡ä»¶å­˜å‚¨ID(å…³è”t_file)',
  thumbnail_file_id bigint COMMENT 'ç¼©ç•¥å›¾æ–‡ä»¶ID(å…³è”t_file)',

  -- æ–‡ä»¶ä¿¡æ¯
  file_name varchar(255) COMMENT 'æ–‡ä»¶å',
  file_ext varchar(32) COMMENT 'æ–‡ä»¶æ‰©å±•å',
  file_size bigint COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',

  -- åª’ä½“æ–‡ä»¶å…ƒä¿¡æ¯
  duration int COMMENT 'æ—¶é•¿(ç§’,éŸ³è§†é¢‘)',
  width int COMMENT 'å®½åº¦(åƒç´ ,å›¾ç‰‡/è§†é¢‘)',
  height int COMMENT 'é«˜åº¦(åƒç´ ,å›¾ç‰‡/è§†é¢‘)',

  -- ä¸‹è½½çŠ¶æ€
  download_status tinyint NOT NULL DEFAULT 0 COMMENT 'ä¸‹è½½çŠ¶æ€(0-å¾…ä¸‹è½½ 1-ä¸‹è½½ä¸­ 2-å·²ä¸‹è½½ 3-å¤±è´¥)',
  download_time datetime COMMENT 'ä¸‹è½½å®Œæˆæ—¶é—´',
  download_error_msg varchar(500) COMMENT 'ä¸‹è½½å¤±è´¥åŸå› ',

  -- å®¡è®¡å­—æ®µ
  deleted_flag tinyint NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è¯†',
  create_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  update_time datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

  PRIMARY KEY (media_id),
  UNIQUE KEY uk_msg_media (message_id, media_type),
  KEY idx_msg_id (msg_id),
  KEY idx_sdk_file_id (sdk_file_id),
  KEY idx_file_id (file_id),
  KEY idx_download_status (download_status)
) ENGINE=InnoDB COMMENT='ä¼å¾®ä¼šè¯åª’ä½“æ–‡ä»¶è¡¨';
```

**è®¾è®¡è¯´æ˜**ï¼š
- âœ… `message_id`: ç›´æ¥å…³è”æ¶ˆæ¯è¡¨ä¸»é”®
- âœ… `file_id`: å…³è” `t_file.file_id`ï¼Œè·å–æ–‡ä»¶å­˜å‚¨ä¿¡æ¯
- âœ… `sdk_file_id`: ä¼å¾®SDKåŸå§‹æ–‡ä»¶IDï¼Œç”¨äºä¸‹è½½
- âœ… `download_status`: æ”¯æŒå¼‚æ­¥ä¸‹è½½ç®¡ç†ï¼ˆ0å¾…ä¸‹è½½â†’1ä¸‹è½½ä¸­â†’2å·²ä¸‹è½½/3å¤±è´¥ï¼‰
- âœ… `thumbnail_file_id`: å›¾ç‰‡/è§†é¢‘ç¼©ç•¥å›¾ä¹Ÿå­˜åˆ° `t_file`
- âœ… `width/height/duration`: åª’ä½“æ–‡ä»¶ç‰¹æœ‰å±æ€§

---

### å…³è”æŸ¥è¯¢ç¤ºä¾‹

#### 1. æŸ¥è¯¢æ¶ˆæ¯çš„åª’ä½“æ–‡ä»¶ï¼ˆå«æ–‡ä»¶URLï¼‰

```sql
SELECT
  m.media_id,
  m.media_type,
  m.file_name,
  m.file_size,
  m.duration,
  m.width,
  m.height,
  m.download_status,
  f1.file_key AS file_url,           -- ä¸»æ–‡ä»¶URL
  f2.file_key AS thumbnail_url        -- ç¼©ç•¥å›¾URL
FROM t_wecom_message_media m
LEFT JOIN t_file f1 ON m.file_id = f1.file_id
LEFT JOIN t_file f2 ON m.thumbnail_file_id = f2.file_id
WHERE m.message_id = ?
  AND m.download_status = 2;  -- ä»…æŸ¥å·²ä¸‹è½½çš„
```

#### 2. è·å–æ–‡ä»¶è®¿é—®URL

```java
// æŸ¥è¯¢åª’ä½“è®°å½•
WecomMessageMediaEntity media = mediaDao.selectByMessageId(messageId);

// é€šè¿‡ file_id æŸ¥è¯¢æ–‡ä»¶è®°å½•
FileEntity file = fileDao.selectById(media.getFileId());

// é€šè¿‡ file_key è·å–è®¿é—®URL
ResponseDTO<String> urlResult = fileService.getFileUrl(file.getFileKey());
String fileUrl = urlResult.getData();
```

---

### ä¸šåŠ¡ä»£ç ç¤ºä¾‹

#### ä¸‹è½½å¹¶ä¿å­˜ä¼å¾®åª’ä½“æ–‡ä»¶

```java
@Service
public class WecomMessageMediaService {

    @Resource
    private FileService fileService;

    @Resource
    private WecomMessageMediaDao messageMediaDao;

    @Resource
    private WxFinanceClient wxFinanceClient;

    /**
     * ä¸‹è½½ä¼å¾®åª’ä½“æ–‡ä»¶ @author wangxiao
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<String> downloadAndSave(Long messageId, String msgId,
                                                String sdkFileId, String mediaType) {

        // 1. æ£€æŸ¥æ˜¯å¦å·²ä¸‹è½½
        WecomMessageMediaEntity existMedia = messageMediaDao.selectBySdkFileId(sdkFileId);
        if (existMedia != null && existMedia.getDownloadStatus() == 2) {
            return ResponseDTO.ok("æ–‡ä»¶å·²å­˜åœ¨");
        }

        // 2. åˆ›å»ºåª’ä½“è®°å½•(ä¸‹è½½ä¸­)
        WecomMessageMediaEntity media = new WecomMessageMediaEntity();
        media.setMessageId(messageId);
        media.setMsgId(msgId);
        media.setSdkFileId(sdkFileId);
        media.setMediaType(mediaType);
        media.setDownloadStatus(1);  // ä¸‹è½½ä¸­
        messageMediaDao.insert(media);

        try {
            // 3. ä»ä¼å¾®ä¸‹è½½åª’ä½“æ–‡ä»¶
            byte[] mediaData = wxFinanceClient.downloadMedia(sdkFileId);

            // 4. è½¬æ¢ä¸º MultipartFile
            String fileName = generateFileName(mediaType, sdkFileId);
            MultipartFile file = new MockMultipartFile(
                "file",
                fileName,
                getContentType(mediaType),
                mediaData
            );

            // 5. ä¸Šä¼ åˆ°æ–‡ä»¶ç³»ç»Ÿ
            ResponseDTO<FileUploadVO> uploadResult = fileService.fileUpload(
                file,
                FileFolderTypeEnum.WECOM_CHAT.getValue(),
                requestUser
            );

            if (!uploadResult.getOk()) {
                throw new BusinessException("æ–‡ä»¶ä¸Šä¼ å¤±è´¥");
            }

            // 6. æ›´æ–°åª’ä½“è®°å½•
            media.setFileId(uploadResult.getData().getFileId());
            media.setFileName(fileName);
            media.setFileSize(file.getSize());
            media.setFileExt(getFileExtension(fileName));
            media.setDownloadStatus(2);  // ä¸‹è½½å®Œæˆ
            media.setDownloadTime(LocalDateTime.now());
            messageMediaDao.updateById(media);

            log.info("åª’ä½“æ–‡ä»¶ä¸‹è½½æˆåŠŸ: sdkFileId={}, fileId={}", sdkFileId, media.getFileId());
            return ResponseDTO.ok();

        } catch (Exception e) {
            // 7. æ ‡è®°ä¸‹è½½å¤±è´¥
            media.setDownloadStatus(3);
            media.setDownloadErrorMsg(e.getMessage());
            messageMediaDao.updateById(media);

            log.error("ä¼å¾®åª’ä½“ä¸‹è½½å¤±è´¥: {}", sdkFileId, e);
            return ResponseDTO.error(WecomErrorCode.MEDIA_DOWNLOAD_FAILED);
        }
    }

    /**
     * è·å–æ¶ˆæ¯çš„åª’ä½“æ–‡ä»¶åˆ—è¡¨ @author wangxiao
     */
    public ResponseDTO<List<WecomMessageMediaVO>> getMediaList(Long messageId) {

        // 1. æŸ¥è¯¢è¯¥æ¶ˆæ¯çš„æ‰€æœ‰åª’ä½“æ–‡ä»¶
        List<WecomMessageMediaEntity> mediaList = messageMediaDao.selectByMessageId(messageId);
        if (CollectionUtils.isEmpty(mediaList)) {
            return ResponseDTO.ok(Collections.emptyList());
        }

        // 2. ç»„è£…VO
        List<WecomMessageMediaVO> voList = mediaList.stream().map(media -> {
            WecomMessageMediaVO vo = new WecomMessageMediaVO();
            vo.setMediaId(media.getMediaId());
            vo.setMediaType(media.getMediaType());
            vo.setFileName(media.getFileName());
            vo.setFileSize(media.getFileSize());
            vo.setDuration(media.getDuration());
            vo.setDownloadStatus(media.getDownloadStatus());

            // è·å–æ–‡ä»¶URL
            if (media.getFileId() != null && media.getDownloadStatus() == 2) {
                FileEntity file = fileDao.selectById(media.getFileId());
                if (file != null) {
                    ResponseDTO<String> urlResult = fileService.getFileUrl(file.getFileKey());
                    vo.setFileUrl(urlResult.getData());
                }

                // è·å–ç¼©ç•¥å›¾URL
                if (media.getThumbnailFileId() != null) {
                    FileEntity thumbnail = fileDao.selectById(media.getThumbnailFileId());
                    if (thumbnail != null) {
                        ResponseDTO<String> thumbUrlResult = fileService.getFileUrl(thumbnail.getFileKey());
                        vo.setThumbnailUrl(thumbUrlResult.getData());
                    }
                }
            }

            return vo;
        }).collect(Collectors.toList());

        return ResponseDTO.ok(voList);
    }

    /**
     * ç”Ÿæˆæ–‡ä»¶å @author wangxiao
     */
    private String generateFileName(String mediaType, String sdkFileId) {
        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
        String shortId = sdkFileId.substring(0, Math.min(8, sdkFileId.length()));

        String extension = switch (mediaType) {
            case "image" -> "jpg";
            case "voice" -> "amr";
            case "video" -> "mp4";
            case "file" -> "bin";
            case "emotion" -> "gif";
            default -> "dat";
        };

        return String.format("%s_%s_%s.%s", mediaType, timestamp, shortId, extension);
    }

    /**
     * è·å–Content-Type @author wangxiao
     */
    private String getContentType(String mediaType) {
        return switch (mediaType) {
            case "image" -> "image/jpeg";
            case "voice" -> "audio/amr";
            case "video" -> "video/mp4";
            case "emotion" -> "image/gif";
            default -> "application/octet-stream";
        };
    }

    /**
     * è·å–æ–‡ä»¶æ‰©å±•å @author wangxiao
     */
    private String getFileExtension(String fileName) {
        int dotIndex = fileName.lastIndexOf('.');
        return dotIndex > 0 ? fileName.substring(dotIndex + 1) : "";
    }
}
```

---

### åª’ä½“æ–‡ä»¶ä¸‹è½½æµç¨‹

```
1. æ¶ˆæ¯æ‹‰å–æ—¶è§£æå‡ºåª’ä½“ä¿¡æ¯
   - sdk_file_id (ä¼å¾®SDKæ–‡ä»¶ID)
   - media_type (image/voice/video/file)
   â†“
2. åˆ›å»º t_wecom_message_media è®°å½•
   - download_status = 1 (ä¸‹è½½ä¸­)
   â†“
3. ä»ä¼å¾®APIä¸‹è½½åª’ä½“æ–‡ä»¶
   - WxFinanceClient.downloadMedia(sdkFileId)
   â†“
4. ä¸Šä¼ åˆ° SmartAdmin æ–‡ä»¶ç³»ç»Ÿ
   - FileService.fileUpload() â†’ IFileStorageService
   - æœ¬åœ°: ä¿å­˜åˆ° /data/media/private/wecom-chat/
   - äº‘ç«¯: ä¸Šä¼ åˆ° OSS/COS bucket
   â†“
5. ç”Ÿæˆ file_key å¹¶ä¿å­˜åˆ° t_file
   - file_key: "private/wecom-chat/2025/10/uuid.jpg"
   - è¿”å› file_id
   â†“
6. æ›´æ–° t_wecom_message_media è®°å½•
   - file_id = è¿”å›çš„æ–‡ä»¶ID
   - download_status = 2 (å·²ä¸‹è½½)
   - download_time = å½“å‰æ—¶é—´
   â†“
7. å‰ç«¯å±•ç¤ºæ—¶æŸ¥è¯¢
   - é€šè¿‡ message_id æŸ¥è¯¢ t_wecom_message_media
   - é€šè¿‡ file_id å…³è” t_file è·å– file_key
   - é€šè¿‡ file_key è·å–è®¿é—®URL
```

**å…³é”®ç‚¹**ï¼š
- âœ… `t_wecom_message_media` å­˜å‚¨ä¼å¾®ä¸šåŠ¡ä¿¡æ¯ï¼ˆsdk_file_idã€message_idã€download_statusï¼‰
- âœ… `t_file` å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ï¼ˆfile_keyã€file_nameã€storageè·¯å¾„ï¼‰
- âœ… åˆ†ç¦»å…³æ³¨ç‚¹ï¼šä¸šåŠ¡è¡¨ vs å­˜å‚¨è¡¨

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Service
public class WecomMediaService {

    @Resource
    private FileService fileService;

    @Resource
    private MessageDao messageDao;

    /**
     * ä¸‹è½½å¹¶ä¸Šä¼ ä¼å¾®åª’ä½“æ–‡ä»¶
     */
    public String downloadAndUploadMedia(String sdkFileId, String msgId) {

        // 1. ä»ä¼å¾®ä¸‹è½½åª’ä½“æ–‡ä»¶åˆ°å†…å­˜
        byte[] mediaData = wxFinanceClient.downloadMedia(sdkFileId);

        // 2. è½¬æ¢ä¸º MultipartFile
        MultipartFile file = new MockMultipartFile(
            "file",
            "media.jpg",
            "image/jpeg",
            mediaData
        );

        // 3. ä¸Šä¼ åˆ°æ–‡ä»¶ç³»ç»Ÿ
        ResponseDTO<FileUploadVO> response = fileService.fileUpload(
            file,
            FileFolderTypeEnum.WECOM_CHAT.getValue(),
            requestUser
        );

        if (!response.getOk()) {
            throw new BusinessException("åª’ä½“æ–‡ä»¶ä¸Šä¼ å¤±è´¥");
        }

        // 4. è·å– file_key
        String fileKey = response.getData().getFileKey();

        // 5. æ›´æ–°æ¶ˆæ¯è¡¨
        MessageEntity message = messageDao.selectByMsgId(msgId);
        message.setFileKeys(fileKey);
        messageDao.updateById(message);

        return fileKey;
    }
}
```

---

## é…ç½®ä¸ä½¿ç”¨

### æœ¬åœ°å­˜å‚¨é…ç½®

```yaml
# application-dev.yml
file:
  storage:
    mode: local
    local:
      upload-path: /data/media        # æœ¬åœ°å­˜å‚¨è·¯å¾„
      url-prefix: http://localhost:1024/upload  # è®¿é—®URLå‰ç¼€ï¼ˆå¯é€‰ï¼‰
```

**è®¿é—®æ–¹å¼**ï¼š
- ä¸Šä¼ å file_key: `private/wecom-chat/2025/01/abc.jpg`
- è®¿é—®URL: `http://localhost:1024/upload/private/wecom-chat/2025/01/abc.jpg`

---

### äº‘å­˜å‚¨é…ç½®ï¼ˆS3å…¼å®¹ï¼‰

#### MinIOï¼ˆæ¨èç”¨äºå¼€å‘æµ‹è¯•ï¼‰

```yaml
# application-dev.yml
file:
  storage:
    mode: cloud
    cloud:
      region: us-east-1
      endpoint: localhost:9000                    # MinIOåœ°å€
      bucket-name: wecom-media-dev                # Bucketåç§°
      access-key: minioadmin
      secret-key: minioadmin
      private-url-expire-seconds: 3600            # ä¸´æ—¶URLæœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
      url-prefix: http://wecom-media-dev.localhost:9000/
```

#### é˜¿é‡Œäº‘OSS

```yaml
# application-prod.yml
file:
  storage:
    mode: cloud
    cloud:
      region: cn-hangzhou
      endpoint: oss-cn-hangzhou.aliyuncs.com
      bucket-name: wecom-media-prod
      access-key: ${OSS_ACCESS_KEY_ID}           # ç¯å¢ƒå˜é‡
      secret-key: ${OSS_ACCESS_KEY_SECRET}
      private-url-expire-seconds: 86400          # 24å°æ—¶
      url-prefix: https://wecom-media-prod.oss-cn-hangzhou.aliyuncs.com/
```

#### è…¾è®¯äº‘COS

```yaml
file:
  storage:
    mode: cloud
    cloud:
      region: ap-guangzhou
      endpoint: cos.ap-guangzhou.myqcloud.com
      bucket-name: wecom-media-prod-1234567890   # æ ¼å¼: bucket-appid
      access-key: ${COS_SECRET_ID}
      secret-key: ${COS_SECRET_KEY}
      private-url-expire-seconds: 86400
      url-prefix: https://wecom-media-prod-1234567890.cos.ap-guangzhou.myqcloud.com/
```

---

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# ç”Ÿäº§ç¯å¢ƒï¼ˆä½¿ç”¨äº‘å­˜å‚¨ï¼‰
export FILE_STORAGE_MODE=cloud
export OSS_ACCESS_KEY_ID="LTAI5t****************"
export OSS_ACCESS_KEY_SECRET="xKZG**************************"

# å¼€å‘ç¯å¢ƒï¼ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
export FILE_STORAGE_MODE=local
export FILE_UPLOAD_PATH="/data/media"
```

---

### ä½¿ç”¨ç¤ºä¾‹

#### ä¸Šä¼ æ–‡ä»¶

```java
@RestController
public class WecomChatController {

    @Resource
    private FileService fileService;

    @PostMapping("/wecom/media/upload")
    public ResponseDTO<FileUploadVO> uploadMedia(
        @RequestParam("file") MultipartFile file,
        @RequestUser RequestUser user) {

        return fileService.fileUpload(
            file,
            FileFolderTypeEnum.WECOM_CHAT.getValue(),
            user
        );
    }
}
```

**å“åº”**ï¼š
```json
{
  "code": 1,
  "ok": true,
  "msg": "ä¸Šä¼ æˆåŠŸ",
  "data": {
    "fileId": 123,
    "fileKey": "private/wecom-chat/2025/01/uuid.jpg",
    "fileUrl": "http://localhost:1024/upload/private/wecom-chat/2025/01/uuid.jpg"
  }
}
```

#### è·å–æ–‡ä»¶URL

```java
// å•ä¸ªæ–‡ä»¶
String fileKey = "private/wecom-chat/2025/01/uuid.jpg";
ResponseDTO<String> response = fileService.getFileUrl(fileKey);
String url = response.getData();

// å¤šä¸ªæ–‡ä»¶ï¼ˆé€—å·åˆ†éš”ï¼‰
String fileKeys = "key1,key2,key3";
ResponseDTO<String> response = fileService.getFileUrl(fileKeys);
String urls = response.getData();  // "url1,url2,url3"
```

#### ä¸‹è½½æ–‡ä»¶

```java
@GetMapping("/file/download")
public void downloadFile(
    @RequestParam String fileKey,
    HttpServletResponse response) {

    ResponseDTO<FileDownloadVO> result = fileService.getDownloadFile(fileKey, userAgent);

    if (result.getOk()) {
        FileDownloadVO downloadVO = result.getData();
        // è®¾ç½®å“åº”å¤´
        response.setContentType(downloadVO.getMetadata().getContentType());
        response.setHeader("Content-Disposition", "attachment; filename=" + downloadVO.getMetadata().getFileName());
        // å†™å…¥æ–‡ä»¶æµ
        response.getOutputStream().write(downloadVO.getData());
    }
}
```

---

## æœªæ¥å¢å¼ºè§„åˆ’

### ä¸ºä»€ä¹ˆéœ€è¦å¢å¼ºï¼Ÿ

**å½“å‰é™åˆ¶**ï¼š
- âŒ å•ä¸€å­˜å‚¨ï¼šåªèƒ½é€‰æ‹©æœ¬åœ°æˆ–äº‘ç«¯ï¼Œæ— æ³•æ··åˆ
- âŒ æ— å®¹ç¾ï¼šæ²¡æœ‰å¤‡ä»½æœºåˆ¶
- âŒ æ— è¿ç§»ï¼šæ— æ³•è‡ªåŠ¨ä»æœ¬åœ°è¿ç§»åˆ°äº‘ç«¯
- âŒ å›ºå®šç­–ç•¥ï¼šæ— æ³•æŒ‰æ–‡ä»¶å¤§å°ã€ç±»å‹åŠ¨æ€é€‰æ‹©å­˜å‚¨

**æœªæ¥åœºæ™¯**ï¼š
- ğŸ“ˆ ä¸šåŠ¡å¢é•¿åéœ€è¦å†·çƒ­æ•°æ®åˆ†å±‚
- ğŸ” é‡è¦æ–‡ä»¶éœ€è¦å¤šåœ°å¤‡ä»½
- ğŸ’° æˆæœ¬ä¼˜åŒ–éœ€è¦çµæ´»çš„å­˜å‚¨ç­–ç•¥

---

### å¢å¼ºæ–¹æ¡ˆï¼šä¸»å¤‡åŒå­˜å‚¨ + æ··åˆç­–ç•¥

#### 1. æ•°æ®åº“è®¾è®¡

**æ–¹æ¡ˆAï¼šæ‰©å±•ç°æœ‰ t_file è¡¨**
```sql
ALTER TABLE t_file
ADD COLUMN primary_file_key varchar(255) COMMENT 'ä¸»å­˜å‚¨key',
ADD COLUMN backup_file_key varchar(255) COMMENT 'å¤‡ä»½å­˜å‚¨key',
ADD COLUMN storage_strategy varchar(32) COMMENT 'å­˜å‚¨ç­–ç•¥: local/oss/mixed';

-- å…¼å®¹æ—§æ•°æ®
UPDATE t_file SET primary_file_key = file_key WHERE primary_file_key IS NULL;
```

**æ–¹æ¡ˆBï¼šæ–°å»ºåª’ä½“æ–‡ä»¶è¡¨**
```sql
CREATE TABLE t_media_file (
  file_id bigint NOT NULL AUTO_INCREMENT,
  business_type varchar(32) NOT NULL,
  business_id varchar(128) NOT NULL,
  file_name varchar(255),
  file_size bigint,
  file_md5 varchar(64),

  -- ä¸»å¤‡åŒå­˜å‚¨
  primary_storage_id varchar(255) NOT NULL,
  backup_storage_id varchar(255),

  upload_status tinyint DEFAULT 0,
  access_count int DEFAULT 0,
  last_access_time datetime,

  PRIMARY KEY (file_id),
  KEY idx_business (business_type, business_id)
);
```

---

#### 2. å­˜å‚¨ç­–ç•¥é…ç½®

**ç­–ç•¥è¡¨**ï¼š
```sql
CREATE TABLE t_storage_strategy (
  strategy_id bigint NOT NULL AUTO_INCREMENT,
  strategy_name varchar(128),

  -- åŒ¹é…æ¡ä»¶
  file_type varchar(32),
  min_file_size bigint,
  max_file_size bigint,
  business_type varchar(32),

  -- å­˜å‚¨é€‰æ‹©
  primary_storage varchar(32) NOT NULL,  -- local/oss/cos
  backup_storage varchar(32),

  -- è¿ç§»ç­–ç•¥
  auto_migrate tinyint DEFAULT 0,
  migrate_days int,
  migrate_to_storage varchar(32),

  priority int DEFAULT 0,
  PRIMARY KEY (strategy_id)
);
```

**ç¤ºä¾‹é…ç½®**ï¼š
```sql
-- å¤§æ–‡ä»¶ç”¨äº‘å­˜å‚¨
INSERT INTO t_storage_strategy VALUES
(1, 'å¤§æ–‡ä»¶OSS', NULL, 10485760, NULL, NULL, 'oss', 'local', 0, NULL, NULL, 10);

-- è§†é¢‘æ–‡ä»¶ç”¨äº‘å­˜å‚¨
INSERT INTO t_storage_strategy VALUES
(2, 'è§†é¢‘OSS', 'video', NULL, NULL, NULL, 'oss', NULL, 0, NULL, NULL, 20);

-- å†·æ•°æ®è‡ªåŠ¨è¿ç§»
INSERT INTO t_storage_strategy VALUES
(3, 'å†·æ•°æ®è¿ç§»', NULL, NULL, NULL, NULL, 'local', NULL, 1, 90, 'oss', 5);
```

---

#### 3. æ··åˆå­˜å‚¨è·¯ç”±

```java
@Service
public class StorageStrategyService {

    /**
     * æ ¹æ®æ–‡ä»¶å±æ€§é€‰æ‹©å­˜å‚¨
     */
    public StorageDecision selectStorage(FileMetadata metadata) {

        // 1. æŸ¥è¯¢åŒ¹é…ç­–ç•¥ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
        List<StorageStrategy> strategies = strategyDao.queryMatched(
            metadata.getFileType(),
            metadata.getFileSize(),
            metadata.getBusinessType()
        );

        if (strategies.isEmpty()) {
            // é»˜è®¤ç­–ç•¥
            return new StorageDecision("local", null);
        }

        // 2. ä½¿ç”¨ä¼˜å…ˆçº§æœ€é«˜çš„ç­–ç•¥
        StorageStrategy strategy = strategies.get(0);
        return new StorageDecision(
            strategy.getPrimaryStorage(),
            strategy.getBackupStorage()
        );
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// ä¸Šä¼ æ—¶è‡ªåŠ¨é€‰æ‹©å­˜å‚¨
StorageDecision decision = strategyService.selectStorage(metadata);

// ä¸Šä¼ åˆ°ä¸»å­˜å‚¨
String primaryKey = uploadToStorage(file, decision.getPrimaryStorage());

// ä¸Šä¼ åˆ°å¤‡ä»½å­˜å‚¨ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
String backupKey = null;
if (decision.getBackupStorage() != null) {
    backupKey = uploadToStorage(file, decision.getBackupStorage());
}
```

---

#### 4. è‡ªåŠ¨è¿ç§»

```java
@Component
public class StorageMigrationJob {

    /**
     * æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå†·æ•°æ®è¿ç§»
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void migrateColdData() {

        // 1. æŸ¥è¯¢å†·æ•°æ®ï¼ˆ90å¤©æœªè®¿é—®ï¼‰
        LocalDateTime threshold = LocalDateTime.now().minusDays(90);
        List<FileEntity> coldFiles = fileDao.selectColdData(threshold);

        for (FileEntity file : coldFiles) {
            try {
                // 2. ä»æœ¬åœ°ä¸‹è½½
                byte[] data = downloadFromLocal(file.getFileKey());

                // 3. ä¸Šä¼ åˆ°OSS
                String ossKey = uploadToOss(data, file);

                // 4. æ›´æ–°æ•°æ®åº“
                file.setPrimaryFileKey(ossKey);
                file.setBackupFileKey(file.getFileKey());  // æœ¬åœ°å˜å¤‡ä»½
                fileDao.updateById(file);

                log.info("æ–‡ä»¶è¿ç§»æˆåŠŸ: {}", file.getFileId());

            } catch (Exception e) {
                log.error("æ–‡ä»¶è¿ç§»å¤±è´¥: {}", file.getFileId(), e);
            }
        }
    }
}
```

---

#### 5. ä¸»å¤‡åˆ‡æ¢

```java
public String getFileUrl(String fileKey) {

    FileEntity file = fileDao.selectByFileKey(fileKey);

    // 1. ä¼˜å…ˆä½¿ç”¨ä¸»å­˜å‚¨
    try {
        return getUrlFromStorage(file.getPrimaryFileKey());
    } catch (Exception e) {
        log.error("ä¸»å­˜å‚¨è·å–URLå¤±è´¥ï¼Œå°è¯•å¤‡ä»½å­˜å‚¨", e);

        // 2. ä¸»å­˜å‚¨å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å¤‡ä»½
        if (file.getBackupFileKey() != null) {
            return getUrlFromStorage(file.getBackupFileKey());
        }

        throw new BusinessException("æ–‡ä»¶è®¿é—®å¤±è´¥");
    }
}
```

---

### å®æ–½è®¡åˆ’

**Phase 1: å½“å‰æ–¹æ¡ˆï¼ˆV1.0ï¼‰** - å·²å®Œæˆ âœ…
- ä½¿ç”¨ç°æœ‰ SmartAdmin æ–‡ä»¶ç³»ç»Ÿ
- æ”¯æŒæœ¬åœ° + S3å…¼å®¹äº‘å­˜å‚¨
- é…ç½®åˆ‡æ¢

**Phase 2: ä¸šåŠ¡å…³è”ï¼ˆV1.1ï¼‰** - å¯é€‰
- æ‰©å±• t_file è¡¨ï¼šbusiness_type + business_id
- æ”¯æŒæŒ‰ä¸šåŠ¡ç±»å‹æŸ¥è¯¢æ–‡ä»¶

**Phase 3: æ··åˆå­˜å‚¨ï¼ˆV2.0ï¼‰** - æœªæ¥
- ä¸»å¤‡åŒå­˜å‚¨
- å­˜å‚¨ç­–ç•¥é…ç½®
- è‡ªåŠ¨è¿ç§»

**Phase 4: é«˜çº§ç‰¹æ€§ï¼ˆV3.0ï¼‰** - é•¿æœŸ
- ç¼©ç•¥å›¾è‡ªåŠ¨ç”Ÿæˆ
- CDNåŠ é€Ÿ
- æ–‡ä»¶å»é‡
- åˆ†ç‰‡ä¸Šä¼ 

---

## æ€»ç»“

### åª’ä½“æ–‡ä»¶ç®¡ç†æ ¸å¿ƒè®¾è®¡

**åŒè¡¨åˆ†ç¦»æ¶æ„**ï¼š
```
t_wecom_message_media (ä¼å¾®ä¸šåŠ¡è¡¨)
        â†“ file_id å…³è”
t_file (SmartAdminé€šç”¨æ–‡ä»¶è¡¨)
```

**èŒè´£åˆ’åˆ†**ï¼š
- `t_wecom_message_media`: å­˜å‚¨ä¼å¾®ç‰¹æœ‰ä¿¡æ¯ï¼ˆsdk_file_idã€message_idã€download_statusã€åª’ä½“å…ƒä¿¡æ¯ï¼‰
- `t_file`: å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ï¼ˆfile_keyã€file_nameã€å­˜å‚¨è·¯å¾„ï¼‰

### å½“å‰æ–¹æ¡ˆä¼˜åŠ¿

âœ… **é›¶å¼€å‘æˆæœ¬** - ç›´æ¥å¤ç”¨ SmartAdmin æ–‡ä»¶ç³»ç»Ÿ
âœ… **åˆ†ç¦»å…³æ³¨ç‚¹** - ä¸šåŠ¡è¡¨ vs å­˜å‚¨è¡¨ï¼ŒèŒè´£æ¸…æ™°
âœ… **çµæ´»é…ç½®** - æœ¬åœ°/äº‘å­˜å‚¨ä¸€é”®åˆ‡æ¢
âœ… **å…¼å®¹æ€§å¥½** - S3åè®®æ”¯æŒ MinIOã€é˜¿é‡Œäº‘OSSã€è…¾è®¯äº‘COSã€AWS S3
âœ… **ä¸‹è½½ç®¡ç†** - æ”¯æŒå¼‚æ­¥ä¸‹è½½ã€çŠ¶æ€è·Ÿè¸ªã€å¤±è´¥é‡è¯•

### å¿«é€Ÿå¼€å§‹

```java
// 1. æ·»åŠ æšä¸¾ç±»å‹ï¼ˆå”¯ä¸€éœ€è¦çš„ä»£ç ä¿®æ”¹ï¼‰
FileFolderTypeEnum.WECOM_CHAT(5, "private/wecom-chat/", "ä¼å¾®ä¼šè¯å­˜æ¡£");

// 2. é…ç½®å­˜å‚¨æ–¹å¼
file.storage.mode=local  // æˆ– cloud

// 3. ä¸‹è½½å¹¶ä¿å­˜åª’ä½“
messageMediaService.downloadAndSave(messageId, msgId, sdkFileId, mediaType);

// 4. è·å–åª’ä½“URL
messageMediaService.getMediaList(messageId);
```

### æœªæ¥æ¼”è¿›è·¯å¾„

```
V1.0 (å½“å‰)
  â†“
V1.1 (ä¸šåŠ¡å…³è”)
  â†“
V2.0 (æ··åˆå­˜å‚¨)
  â†“
V3.0 (é«˜çº§ç‰¹æ€§)
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-08
**ç»´æŠ¤äºº**: wangxiao