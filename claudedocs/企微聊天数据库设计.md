---
title: ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£æ•°æ®åº“è®¾è®¡
author: wangxiao
company: å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€
date: 2025-10-08
permalink: claudedocs/ä¼å¾®èŠå¤©æ•°æ®åº“è®¾è®¡
---

# ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£æ•°æ®åº“è®¾è®¡

---

## ğŸ“‹ ç›®å½•

1. [è®¾è®¡æ¦‚è¿°](#è®¾è®¡æ¦‚è¿°)
2. [æ ¸å¿ƒæ•°æ®æ¨¡å‹](#æ ¸å¿ƒæ•°æ®æ¨¡å‹)
3. [è¡¨ç»“æ„è®¾è®¡](#è¡¨ç»“æ„è®¾è®¡)
4. [æ¶ˆæ¯ç±»å‹è®¾è®¡](#æ¶ˆæ¯ç±»å‹è®¾è®¡)
5. [ç´¢å¼•ç­–ç•¥](#ç´¢å¼•ç­–ç•¥)
6. [æŸ¥è¯¢ä¼˜åŒ–](#æŸ¥è¯¢ä¼˜åŒ–)
7. [ä¸SmartAdminé›†æˆ](#ä¸smartadminé›†æˆ)

---

## è®¾è®¡æ¦‚è¿°

### åŠŸèƒ½ç›®æ ‡

å®ç°ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£çš„å®Œæ•´å±•ç¤ºåŠŸèƒ½ï¼Œæ”¯æŒ:
- âœ… ä¼šè¯æ¶ˆæ¯çš„æ‹‰å–ã€è§£å¯†ã€å­˜å‚¨
- âœ… å¤šç§æ¶ˆæ¯ç±»å‹å±•ç¤º(æ–‡æœ¬/å›¾ç‰‡/è¯­éŸ³/è§†é¢‘/æ–‡ä»¶ç­‰20+ç§)
- âœ… å•èŠ/ç¾¤èŠä¼šè¯ç®¡ç†
- âœ… å‘˜å·¥/å®¢æˆ·å‚ä¸æ–¹ä¿¡æ¯ç®¡ç†
- âœ… åª’ä½“æ–‡ä»¶ä¸‹è½½å’Œå­˜å‚¨
- âœ… ä¼šè¯æœç´¢å’Œç­›é€‰
- âœ… æ¶ˆæ¯å¯¼å‡ºåŠŸèƒ½

### æŠ€æœ¯æ¶æ„

**åŸºç¡€æ¡†æ¶**: SmartAdmin Java17 + SpringBoot3 + MyBatis-Plus + MySQL 8.0

**æ ¸å¿ƒä¾èµ–**:
- WxJava SDK (ä¼ä¸šå¾®ä¿¡API)
- wx-finance HTTPæœåŠ¡ (ä¼šè¯å­˜æ¡£SDKå°è£…)
- æœ¬åœ°æ–‡ä»¶å­˜å‚¨ + å¯é€‰äº‘å­˜å‚¨

**æ•°æ®åº“ç‰¹æ€§**:
- MySQL 8.0 åˆ†åŒºè¡¨(æŒ‰æœˆåˆ†åŒºæ¶ˆæ¯è¡¨)
- JSONå­—æ®µå­˜å‚¨å¤æ‚æ•°æ®
- å…¨æ–‡ç´¢å¼•æ”¯æŒæ¶ˆæ¯æœç´¢

---

## æ ¸å¿ƒæ•°æ®æ¨¡å‹

### æ•°æ®æµç¨‹

```
ä¼ä¸šå¾®ä¿¡ â†’ wx-finance API â†’ åç«¯æœåŠ¡ â†’ æ•°æ®åº“
   â†“           â†“                 â†“           â†“
åŠ å¯†æ¶ˆæ¯    è§£å¯†æœåŠ¡         ä¸šåŠ¡å¤„ç†      æŒä¹…åŒ–å­˜å‚¨
```

### ERå…³ç³»å›¾

**æ¸²æŸ“è¯´æ˜**ï¼š
- ä½¿ç”¨ Kroki + Mermaid æ¸²æŸ“ï¼ˆWiki.js 2.4+ æ”¯æŒï¼‰
- ä»£ç å—ç¬¬ä¸€è¡Œä¸º `kroki`ï¼Œç¬¬äºŒè¡Œä¸ºå›¾è¡¨ç±»å‹ `mermaid`
- GitHub/GitLab ç­‰å¹³å°æŸ¥çœ‹æºç æ—¶éœ€ä½¿ç”¨æ ‡å‡† Mermaid ä»£ç å—

#### æ¨¡å—1ï¼šä¼ä¸šé…ç½®

```mermaid
erDiagram
    t_wecom_corp_config {
        bigint config_id PK "é…ç½®ID"
        varchar_64 corp_id UK "ä¼ä¸šID"
        varchar_128 corp_name "ä¼ä¸šåç§°"
        varchar_255 chat_secret "ä¼šè¯å­˜æ¡£Secret"
        bigint chat_seq "æ¶ˆæ¯æ‹‰å–æ¸¸æ ‡"
        tinyint chat_pull_status "æ‹‰å–çŠ¶æ€"
        tinyint enabled_flag "å¯ç”¨çŠ¶æ€"
    }
```

#### æ¨¡å—2ï¼šä¼šè¯ä¸å‚ä¸æ–¹

```mermaid
erDiagram
    t_wecom_conversation ||--o{ t_wecom_conversation_participant : "1:N ä¼šè¯å‚ä¸"
    t_wecom_conversation_participant }o--|| t_wecom_staff : "N:1 å‘˜å·¥"
    t_wecom_conversation_participant }o--|| t_wecom_customer : "N:1 å®¢æˆ·"
    t_wecom_conversation_participant }o--|| t_wecom_group : "N:1 ç¾¤èŠ"

    t_wecom_conversation {
        bigint conversation_id PK "ä¼šè¯ID"
        varchar_64 corp_id "ä¼ä¸šID"
        tinyint conversation_type "ä¼šè¯ç±»å‹:1-å•èŠ 2-ç¾¤èŠ"
        varchar_64 room_id "ç¾¤èŠID"
        int participant_count "å‚ä¸æ–¹æ•°é‡"
        int customer_count "å®¢æˆ·æ•°é‡"
        int msg_count "æ¶ˆæ¯æ€»æ•°"
    }

    t_wecom_conversation_participant {
        bigint id PK "å…³ç³»ID"
        bigint conversation_id FK "ä¼šè¯ID"
        varchar_64 participant_id "å‚ä¸æ–¹ID"
        tinyint participant_type "å‚ä¸æ–¹ç±»å‹:1-å®¢æˆ· 2-å‘˜å·¥"
        varchar_128 participant_name "å‚ä¸æ–¹åç§°"
        tinyint is_active "æ˜¯å¦æ´»è·ƒ"
    }

    t_wecom_staff {
        bigint staff_id PK "å‘˜å·¥ID"
        varchar_64 corp_id "ä¼ä¸šID"
        varchar_64 wecom_user_id UK "ä¼å¾®å‘˜å·¥UserID"
        varchar_128 name "å§“å"
        varchar_128 position "èŒåŠ¡"
        tinyint status "çŠ¶æ€"
    }

    t_wecom_customer {
        bigint customer_id PK "å®¢æˆ·ID"
        varchar_64 corp_id "ä¼ä¸šID"
        varchar_64 wecom_external_user_id UK "ä¼å¾®å¤–éƒ¨è”ç³»äººID"
        varchar_128 name "å®¢æˆ·æ˜µç§°"
        tinyint type "å®¢æˆ·ç±»å‹"
        tinyint gender "æ€§åˆ«"
    }

    t_wecom_group {
        bigint group_id PK "ç¾¤èŠID"
        varchar_64 corp_id "ä¼ä¸šID"
        varchar_64 wecom_chat_id UK "ä¼å¾®ç¾¤èŠChatID"
        varchar_128 name "ç¾¤åç§°"
        varchar_64 wecom_owner_id "ç¾¤ä¸»UserID"
        int total_member "æ€»æˆå‘˜æ•°"
        int customer_num "å®¢æˆ·æ•°"
    }
```

#### æ¨¡å—3ï¼šæ¶ˆæ¯ä¸å…³è” â­â­â­æ ¸å¿ƒ

```mermaid
erDiagram
    t_wecom_message ||--o{ t_wecom_message_conversation : "1:N æ¶ˆæ¯å…³è”"
    t_wecom_message ||--o{ t_wecom_message_media : "1:N åª’ä½“æ–‡ä»¶"
    t_wecom_message_conversation }o--|| t_wecom_conversation : "N:1 å…³è”ä¼šè¯"
    t_wecom_message_media }o--|| t_file : "N:1 æ–‡ä»¶å­˜å‚¨"

    t_wecom_message {
        bigint message_id PK "æ¶ˆæ¯è‡ªå¢ID"
        datetime msg_time PK "æ¶ˆæ¯æ—¶é—´-åˆ†åŒºé”®"
        varchar_128 msg_id UK "ä¼å¾®æ¶ˆæ¯ID"
        varchar_64 corp_id "ä¼ä¸šID"
        bigint seq "æ¶ˆæ¯åºå·"
        varchar_32 msg_type "æ¶ˆæ¯ç±»å‹"
        varchar_32 msg_action "æ¶ˆæ¯åŠ¨ä½œ"
        varchar_64 from_id "å‘é€æ–¹ID"
        tinyint from_type "å‘é€æ–¹ç±»å‹"
        json to_list "æ¥æ”¶æ–¹IDåˆ—è¡¨"
        varchar_64 room_id "ç¾¤èŠID"
        text msg_content "æ¶ˆæ¯æ–‡æœ¬å†…å®¹"
        json raw_content "ä¼å¾®åŸå§‹æ¶ˆæ¯JSON"
    }

    t_wecom_message_conversation {
        bigint id PK "å…³è”ID"
        varchar_128 msg_id "ä¼å¾®æ¶ˆæ¯ID"
        bigint message_id FK "æ¶ˆæ¯è¡¨ID"
        bigint conversation_id FK "ä¼šè¯ID"
        varchar_64 from_id "å‘é€æ–¹ID-å†—ä½™"
        varchar_64 to_id "æ¥æ”¶æ–¹ID-å†—ä½™-æ ¸å¿ƒç´¢å¼•"
        tinyint route_type "è·¯ç”±ç±»å‹:1-å•èŠ 2-ç¾¤èŠ"
    }

    t_wecom_message_media {
        bigint media_id PK "åª’ä½“ID"
        bigint message_id FK "æ¶ˆæ¯ID"
        varchar_128 msg_id "ä¼å¾®æ¶ˆæ¯ID"
        varchar_32 media_type "åª’ä½“ç±»å‹"
        varchar_255 sdk_file_id "ä¼å¾®åª’ä½“æ–‡ä»¶ID"
        bigint file_id FK "æ–‡ä»¶å­˜å‚¨ID"
        bigint thumbnail_file_id FK "ç¼©ç•¥å›¾æ–‡ä»¶ID"
        varchar_255 file_name "æ–‡ä»¶å"
        bigint file_size "æ–‡ä»¶å¤§å°"
        tinyint download_status "ä¸‹è½½çŠ¶æ€"
    }

    t_wecom_conversation {
        bigint conversation_id PK "ä¼šè¯ID"
        varchar_64 corp_id "ä¼ä¸šID"
        tinyint conversation_type "ä¼šè¯ç±»å‹"
        varchar_64 room_id "ç¾¤èŠID"
    }

    t_file {
        bigint file_id PK "æ–‡ä»¶ID"
        varchar_500 file_key "æ–‡ä»¶è·¯å¾„"
        varchar_255 file_bucket "å­˜å‚¨æ¡¶"
        bigint file_size "æ–‡ä»¶å¤§å°"
    }
```

**æ ¸å¿ƒè®¾è®¡è¯´æ˜**ï¼š
- âœ… **æ¶ˆæ¯è§£è€¦**: æ¶ˆæ¯è¡¨ä¸å­˜å‚¨ conversation_idï¼Œé€šè¿‡å…³è”è¡¨å®ç°å¤šå¯¹å¤š
- âœ… **çµæ´»å…³è”**: ä¸€æ¡æ¶ˆæ¯å¯å…³è”å¤šä¸ªä¼šè¯ï¼ˆç¾¤å‘åœºæ™¯ï¼‰
- âœ… **æŸ¥è¯¢ä¼˜åŒ–**: to_id å†—ä½™å­—æ®µ + idx_to_time ç´¢å¼• = æé€ŸæŸ¥è¯¢
- âœ… **æ•°æ®æµè½¬**: å•èŠ1æ¡å…³è”ã€ç¾¤èŠ1æ¡å…³è”ã€ç¾¤å‘Næ¡å…³è”

#### æ¨¡å—4ï¼šå‘˜å·¥-å®¢æˆ·å…³ç³»

```mermaid
erDiagram
    t_wecom_staff ||--o{ t_wecom_staff_customer_relation : "1:N å‘˜å·¥å…³ç³»"
    t_wecom_customer ||--o{ t_wecom_staff_customer_relation : "1:N å®¢æˆ·å…³ç³»"

    t_wecom_staff {
        bigint staff_id PK "å‘˜å·¥ID"
        varchar_64 corp_id "ä¼ä¸šID"
        varchar_64 wecom_user_id UK "ä¼å¾®å‘˜å·¥UserID"
        varchar_128 name "å§“å"
        varchar_32 mobile "æ‰‹æœºå·"
        varchar_128 position "èŒåŠ¡"
        tinyint status "çŠ¶æ€"
    }

    t_wecom_staff_customer_relation {
        bigint relation_id PK "å…³ç³»ID"
        varchar_64 corp_id "ä¼ä¸šID"
        varchar_64 wecom_staff_user_id UK "ä¼å¾®å‘˜å·¥UserID"
        varchar_64 wecom_external_user_id UK "ä¼å¾®å¤–éƒ¨è”ç³»äººID"
        varchar_128 staff_remark "å‘˜å·¥å¤‡æ³¨å"
        varchar_500 staff_description "å‘˜å·¥æè¿°"
        tinyint add_way "æ·»åŠ æ¥æº"
        datetime add_time "æ·»åŠ æ—¶é—´"
        json tags "å®¢æˆ·æ ‡ç­¾"
        tinyint relation_status "å…³ç³»çŠ¶æ€"
    }

    t_wecom_customer {
        bigint customer_id PK "å®¢æˆ·ID"
        varchar_64 corp_id "ä¼ä¸šID"
        varchar_64 wecom_external_user_id UK "ä¼å¾®å¤–éƒ¨è”ç³»äººID"
        varchar_128 name "å®¢æˆ·æ˜µç§°"
        tinyint type "å®¢æˆ·ç±»å‹"
        tinyint gender "æ€§åˆ«"
        varchar_128 corp_name "å®¢æˆ·ä¼ä¸šåç§°"
    }
```

**è®¾è®¡è¯´æ˜**ï¼š
- âœ… **N:Nå…³ç³»**: ä¸€ä¸ªå®¢æˆ·å¯è¢«å¤šä¸ªå‘˜å·¥æ·»åŠ 
- âœ… **å‘˜å·¥çº§æ•°æ®**: æ¯ä¸ªå‘˜å·¥å¯¹åŒä¸€å®¢æˆ·æœ‰ç‹¬ç«‹çš„å¤‡æ³¨ã€æ ‡ç­¾
- âœ… **ä¼ä¸šçº§å…±äº«**: å®¢æˆ·åŸºç¡€ä¿¡æ¯å­˜å‚¨åœ¨å®¢æˆ·è¡¨ï¼Œä¼ä¸šçº§å…±äº«

#### æ¨¡å—5ï¼šè¾…åŠ©åŠŸèƒ½

```mermaid
erDiagram
    t_wecom_export_task {
        bigint task_id PK "ä»»åŠ¡ID"
        varchar_64 corp_id "ä¼ä¸šID"
        bigint conversation_id "ä¼šè¯ID"
        varchar_255 task_name "ä»»åŠ¡åç§°"
        tinyint export_type "å¯¼å‡ºç±»å‹:1-HTML 2-PDF 3-Excel 4-JSON"
        tinyint export_scope "å¯¼å‡ºèŒƒå›´"
        tinyint task_status "ä»»åŠ¡çŠ¶æ€"
        varchar_500 file_path "æ–‡ä»¶è·¯å¾„"
        bigint file_size "æ–‡ä»¶å¤§å°"
        bigint create_user_id "åˆ›å»ºäººID"
    }
```

**åŠŸèƒ½è¯´æ˜**: æ”¯æŒå¯¼å‡ºæ ¼å¼ HTML/PDF/Excel/JSON

---

### æ ¸å¿ƒè®¾è®¡äº®ç‚¹

- âœ… **æ¶ˆæ¯ä¼šè¯è§£è€¦** â­â­â­ï¼šæ¶ˆæ¯è¡¨ä¸ç›´æ¥å…³è”ä¼šè¯ï¼Œé€šè¿‡å…³è”è¡¨å®ç°å¤šå¯¹å¤š
- âœ… **æ¶ˆæ¯ä¼šè¯å…³è”è¡¨** `t_wecom_message_conversation`ï¼šç©ºé—´æ¢æ—¶é—´ï¼Œæé€ŸæŸ¥è¯¢ï¼Œæ”¯æŒç¾¤å‘
- âœ… **å‚ä¸æ–¹å…³ç³»è¡¨** `t_wecom_conversation_participant`ï¼šç»Ÿä¸€å¤„ç†å•èŠå’Œç¾¤èŠçš„æˆå‘˜å…³ç³»
- âœ… **å‘˜å·¥-å®¢æˆ·å…³ç³»è¡¨** `t_wecom_staff_customer_relation`ï¼šæ”¯æŒä¸€å¯¹å¤šå…³ç³»
- âœ… **åª’ä½“æ–‡ä»¶åŒè¡¨è®¾è®¡**ï¼šä¸šåŠ¡è¡¨ + å­˜å‚¨è¡¨ï¼ŒèŒè´£åˆ†ç¦»
- âœ… **æ¶ˆæ¯è¡¨åˆ†åŒº**ï¼šæŒ‰æœˆåˆ†åŒºï¼Œæ”¯æŒæµ·é‡æ•°æ®é«˜æ•ˆæŸ¥è¯¢

### ä¸¤å¼ å…³è”è¡¨çš„èŒè´£åŒºåˆ«

| è¡¨ | èŒè´£ | æ•°æ®ç‰¹ç‚¹ | å…¸å‹ç”¨é€” |
|----|------|---------|---------|
| **t_wecom_conversation_participant**<br>(ä¼šè¯å‚ä¸æ–¹è¡¨) | ä¼šè¯çš„**é•¿æœŸæˆå‘˜å…³ç³»** | â€¢ è®°å½•è°åœ¨ä¼šè¯é‡Œ<br>â€¢ å¯èƒ½æ²¡å‘è¿‡æ¶ˆæ¯<br>â€¢ è®°å½•å…¥ç¾¤/é€€ç¾¤æ—¶é—´ | â€¢ å±•ç¤ºä¼šè¯æˆå‘˜åˆ—è¡¨<br>â€¢ åˆ¤æ–­æŸäººæ˜¯å¦åœ¨ä¼šè¯ä¸­<br>â€¢ ç»Ÿè®¡ä¼šè¯æˆå‘˜æ•° |
| **t_wecom_message_conversation**<br>(æ¶ˆæ¯ä¼šè¯å…³è”è¡¨) | æ¶ˆæ¯çš„**å³æ—¶è·¯ç”±å…³ç³»** | â€¢ æ¯æ¡æ¶ˆæ¯éƒ½æœ‰è·¯ç”±<br>â€¢ æ”¯æŒç¾¤å‘<br>â€¢ è®°å½•æ¶ˆæ¯å½’å± | â€¢ æŸ¥è¯¢æŸäººçš„æ¶ˆæ¯<br>â€¢ æŸ¥è¯¢æŸä¼šè¯çš„æ¶ˆæ¯<br>â€¢ ç»Ÿè®¡æ¶ˆæ¯æ•°é‡ |

**ä¸¾ä¾‹è¯´æ˜**ï¼š
```
åœºæ™¯ï¼šç¾¤èŠæœ‰10ä¸ªäººï¼Œä½†åªæœ‰3ä¸ªäººå‘è¿‡æ¶ˆæ¯

å‚ä¸æ–¹è¡¨(t_wecom_conversation_participant)ï¼š
- 10æ¡è®°å½•ï¼ˆæ‰€æœ‰æˆå‘˜ï¼‰
- ç”¨äºæ˜¾ç¤º"ç¾¤æˆå‘˜åˆ—è¡¨"

æ¶ˆæ¯ä¼šè¯å…³è”è¡¨(t_wecom_message_conversation)ï¼š
- åªæœ‰3ä¸ªäººçš„æ¶ˆæ¯è·¯ç”±è®°å½•
- ç”¨äºæŸ¥è¯¢"è°åœ¨è¿™ä¸ªç¾¤é‡Œå‘è¿‡æ¶ˆæ¯"
```

---

## è¡¨ç»“æ„è®¾è®¡

### 1. é…ç½®ç®¡ç†è¡¨

#### t_wecom_corp_config (ä¼ä¸šå¾®ä¿¡é…ç½®è¡¨)

**ç”¨é€”**: å­˜å‚¨ä¼ä¸šå¾®ä¿¡æ¥å…¥é…ç½®å’Œæ‹‰å–çŠ¶æ€

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| config_id | bigint | é…ç½®ID | ä¸»é”®,è‡ªå¢ |
| corp_id | varchar(64) | ä¼ä¸šID | å”¯ä¸€ç´¢å¼• |
| corp_name | varchar(128) | ä¼ä¸šåç§° | |
| agent_secret | varchar(255) | åº”ç”¨Secret | åŠ å¯†å­˜å‚¨ |
| chat_secret | varchar(255) | ä¼šè¯å­˜æ¡£Secret | åŠ å¯†å­˜å‚¨ |
| chat_public_key_ver | int | RSAå…¬é’¥ç‰ˆæœ¬ | é»˜è®¤1 |
| chat_seq | bigint | æ¶ˆæ¯æ‹‰å–æ¸¸æ ‡ | æ–­ç‚¹ç»­ä¼  |
| chat_pull_status | tinyint | æ‹‰å–çŠ¶æ€ | 0-æœªå¼€å§‹ 1-æ‹‰å–ä¸­ 2-å¼‚å¸¸ 3-å·²å®Œæˆ |
| last_pull_time | datetime | æœ€åæ‹‰å–æ—¶é—´ | |
| last_error_msg | varchar(500) | æœ€åé”™è¯¯ä¿¡æ¯ | å¼‚å¸¸æ—¶è®°å½• |
| enabled_flag | tinyint | å¯ç”¨çŠ¶æ€ | 0-ç¦ç”¨ 1-å¯ç”¨ |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | 0-æœªåˆ é™¤ 1-å·²åˆ é™¤ |
| create_user_id | bigint | åˆ›å»ºäººID | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_user_id | bigint | æ›´æ–°äººID | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `config_id`
- UNIQUE KEY: `uk_corp_id` (corp_id)

**è¯´æ˜**:
- `chat_seq`: ç”¨äºè®°å½•å½“å‰æ‹‰å–åˆ°çš„æ¶ˆæ¯åºå·,å®ç°æ–­ç‚¹ç»­ä¼ 
- `chat_pull_status`: ç›‘æ§æ‹‰å–çŠ¶æ€,å¼‚å¸¸æ—¶å¯å‘Šè­¦
- æ•æ„Ÿå­—æ®µ(`agent_secret`, `chat_secret`)å»ºè®®åŠ å¯†å­˜å‚¨

---

### 2. ä¼šè¯ç®¡ç†è¡¨

#### t_wecom_conversation (ä¼šè¯ä¸»è¡¨)

**ç”¨é€”**: å­˜å‚¨ä¼šè¯å…ƒä¿¡æ¯,ç”¨äºä¼šè¯åˆ—è¡¨å±•ç¤º

**è®¾è®¡ç†å¿µ**: é‡‡ç”¨å…³ç³»è¡¨è®¾è®¡,ç»Ÿä¸€å¤„ç†å•èŠå’Œç¾¤èŠ,é€šè¿‡ `t_wecom_conversation_participant` å…³è”å‚ä¸æ–¹

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| conversation_id | bigint | ä¼šè¯ID | ä¸»é”®,è‡ªå¢ |
| corp_id | varchar(64) | ä¼ä¸šID | |
| conversation_type | tinyint | ä¼šè¯ç±»å‹ | 1-å•èŠ 2-ç¾¤èŠ |
| room_id | varchar(64) | ç¾¤èŠID | ç¾¤èŠæ—¶æœ‰å€¼,å•èŠä¸ºNULL |
| room_name | varchar(128) | ç¾¤åç§° | ç¾¤èŠæ—¶æœ‰å€¼ |
| participant_count | int | å‚ä¸æ–¹æ•°é‡ | å•èŠ=2, ç¾¤èŠ=N (å†—ä½™å­—æ®µ,æå‡æŸ¥è¯¢æ€§èƒ½) |
| customer_count | int | å®¢æˆ·æ•°é‡ | ç”¨äºå¿«é€Ÿåˆ¤æ–­å†…éƒ¨/å¤–éƒ¨ä¼šè¯ (å†—ä½™å­—æ®µ) |
| last_msg_id | varchar(128) | æœ€åä¸€æ¡æ¶ˆæ¯ID | |
| last_msg_type | varchar(32) | æœ€åæ¶ˆæ¯ç±»å‹ | |
| last_msg_content | text | æœ€åæ¶ˆæ¯å†…å®¹é¢„è§ˆ | åˆ—è¡¨å±•ç¤ºç”¨ |
| last_msg_time | datetime | æœ€åæ¶ˆæ¯æ—¶é—´ | ç”¨äºæ’åº |
| last_msg_sender_id | varchar(64) | æœ€åæ¶ˆæ¯å‘é€è€…ID | å†—ä½™å­—æ®µ,åˆ—è¡¨å±•ç¤º"XXX: æ¶ˆæ¯å†…å®¹" |
| last_msg_sender_name | varchar(128) | æœ€åæ¶ˆæ¯å‘é€è€…åç§° | |
| msg_count | int | æ¶ˆæ¯æ€»æ•° | |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `conversation_id`
- UNIQUE KEY: `uk_room` (corp_id, room_id) - ç¾¤èŠå”¯ä¸€æ€§
- KEY: `idx_corp_type` (corp_id, conversation_type)
- KEY: `idx_last_msg_time` (last_msg_time)
- KEY: `idx_customer_count` (customer_count) - å¿«é€Ÿç­›é€‰å¤–éƒ¨/å†…éƒ¨ä¼šè¯

**è¯´æ˜**:
- å•èŠä¼šè¯çš„å”¯ä¸€æ€§é€šè¿‡å‚ä¸æ–¹å…³ç³»è¡¨ä¿è¯(è§ä¸‹æ–¹)
- `participant_count` å’Œ `customer_count` æ˜¯å†—ä½™å­—æ®µ,é¿å…JOINæŸ¥è¯¢
- ç¾¤èŠé€šè¿‡ `room_id` å”¯ä¸€æ ‡è¯†

---

#### t_wecom_conversation_participant (ä¼šè¯å‚ä¸æ–¹å…³ç³»è¡¨)

**ç”¨é€”**: å­˜å‚¨ä¼šè¯ä¸å‚ä¸æ–¹çš„å¤šå¯¹å¤šå…³ç³»,ç»Ÿä¸€å¤„ç†å•èŠå’Œç¾¤èŠ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| id | bigint | å…³ç³»ID | ä¸»é”®,è‡ªå¢ |
| conversation_id | bigint | ä¼šè¯ID | å¤–é”®å…³è” |
| participant_id | varchar(64) | å‚ä¸æ–¹ID | å‘˜å·¥UserIDæˆ–å®¢æˆ·ExternalUserID |
| participant_type | tinyint | å‚ä¸æ–¹ç±»å‹ | 1-å®¢æˆ· 2-å‘˜å·¥ |
| participant_name | varchar(128) | å‚ä¸æ–¹åç§° | å†—ä½™å­—æ®µ,é¿å…JOIN |
| relation_start_time | datetime | å…³ç³»å¼€å§‹æ—¶é—´ | ç¾¤èŠ=å…¥ç¾¤æ—¶é—´, å•èŠ=åŠ å¥½å‹æ—¶é—´ |
| relation_end_time | datetime | å…³ç³»ç»“æŸæ—¶é—´ | ç¾¤èŠ=é€€ç¾¤æ—¶é—´, å•èŠ=åˆ å¥½å‹æ—¶é—´, NULLè¡¨ç¤ºå…³ç³»ä»å­˜åœ¨ |
| is_active | tinyint | æ˜¯å¦æ´»è·ƒ | 1-å…³ç³»å­˜åœ¨ 0-å…³ç³»å·²ç»“æŸ |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_conv_participant` (conversation_id, participant_id)
- KEY: `idx_participant` (participant_id, conversation_id) - æ ¸å¿ƒæŸ¥è¯¢ç´¢å¼•
- KEY: `idx_conv_type` (conversation_id, participant_type)

**è®¾è®¡è¯´æ˜**:

1. **å•èŠåœºæ™¯** (2æ¡è®°å½•):
   ```
   ä¼šè¯1: é”€å”®A â†” å®¢æˆ·B
   â”œâ”€ è®°å½•1: conversation_id=1, participant_id=A, participant_type=2
   â””â”€ è®°å½•2: conversation_id=1, participant_id=B, participant_type=1
   ```

2. **ç¾¤èŠåœºæ™¯** (Næ¡è®°å½•):
   ```
   ä¼šè¯2: ç¾¤èŠ(A, B, C, D)
   â”œâ”€ è®°å½•1: conversation_id=2, participant_id=A, is_active=1
   â”œâ”€ è®°å½•2: conversation_id=2, participant_id=B, is_active=1
   â”œâ”€ è®°å½•3: conversation_id=2, participant_id=C, is_active=0, leave_time=xxx
   â””â”€ è®°å½•4: conversation_id=2, participant_id=D, is_active=1
   ```

3. **å•èŠå”¯ä¸€æ€§ä¿è¯** (åº”ç”¨å±‚é€»è¾‘):
   ```java
   // åˆ›å»ºå•èŠä¼šè¯å‰,å…ˆæŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨
   List<Long> conversationIds = participantDao.findConversationsByParticipants(
       Arrays.asList(userId1, userId2)
   );

   // SQL: æŸ¥è¯¢åŒ…å«è¿™ä¸¤ä¸ªå‚ä¸æ–¹çš„å•èŠä¼šè¯
   SELECT conversation_id
   FROM t_wecom_conversation_participant
   WHERE participant_id IN (?, ?)
   GROUP BY conversation_id
   HAVING COUNT(DISTINCT participant_id) = 2
     AND conversation_id IN (
       SELECT conversation_id FROM t_wecom_conversation
       WHERE conversation_type = 1
     );
   ```

---

**ä¼šè¯ç±»å‹åˆ¤æ–­é€»è¾‘**:

```
å•èŠ:
- conversation_type = 1
- room_id = NULL
- participant_count = 2
- customer_count åˆ¤æ–­å†…éƒ¨/å¤–éƒ¨:
  * å†…éƒ¨å•èŠ: customer_count = 0 (å‘˜å·¥â†”å‘˜å·¥)
  * å¤–éƒ¨å•èŠ: customer_count = 1 (å‘˜å·¥â†”å®¢æˆ·)

ç¾¤èŠ:
- conversation_type = 2
- room_id ä¸ä¸ºç©º
- participant_count >= 2
- customer_count åˆ¤æ–­å†…éƒ¨/å¤–éƒ¨:
  * å†…éƒ¨ç¾¤: customer_count = 0
  * å®¢æˆ·ç¾¤: customer_count > 0
```

---

**æ ¸å¿ƒæŸ¥è¯¢åœºæ™¯**:

```sql
-- åœºæ™¯1: æŸ¥è¯¢æŸé”€å”®çš„æ‰€æœ‰ä¼šè¯åˆ—è¡¨(å•èŠ+ç¾¤èŠ)
-- âœ… ä¼˜åŒ–: åˆ©ç”¨ idx_participant ç´¢å¼•,é¿å…å…¨è¡¨æ‰«æ
SELECT c.*
FROM t_wecom_conversation c
INNER JOIN t_wecom_conversation_participant p ON p.conversation_id = c.conversation_id
WHERE p.participant_id = 'sales001'
  AND c.corp_id = 'test_corp'
ORDER BY c.last_msg_time DESC
LIMIT 20;

-- åœºæ™¯2: æŸ¥è¯¢é”€å”®çš„å¤–éƒ¨å®¢æˆ·å•èŠä¼šè¯
-- âœ… ä¼˜åŒ–: åˆ©ç”¨å†—ä½™å­—æ®µ customer_count,é¿å…å†æ¬¡JOIN
SELECT c.*
FROM t_wecom_conversation c
INNER JOIN t_wecom_conversation_participant p ON p.conversation_id = c.conversation_id
WHERE p.participant_id = 'sales001'
  AND c.conversation_type = 1
  AND c.customer_count = 1  -- å¤–éƒ¨å•èŠ
ORDER BY c.last_msg_time DESC
LIMIT 20;

-- åœºæ™¯3: æŸ¥è¯¢ä¸¤äººçš„ä¼šè¯(åˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨)
-- âœ… ç”¨äºåˆ›å»ºä¼šè¯å‰å»é‡
SELECT c.conversation_id, c.*
FROM t_wecom_conversation c
INNER JOIN (
  SELECT conversation_id
  FROM t_wecom_conversation_participant
  WHERE participant_id IN ('user1', 'user2')
  GROUP BY conversation_id
  HAVING COUNT(DISTINCT participant_id) = 2
) p ON p.conversation_id = c.conversation_id
WHERE c.conversation_type = 1;

-- åœºæ™¯4: æŸ¥è¯¢æŸç¾¤èŠçš„æ‰€æœ‰å‚ä¸æ–¹
SELECT p.*
FROM t_wecom_conversation_participant p
WHERE p.conversation_id = ?
  AND p.is_active = 1  -- ä»…æŸ¥è¯¢åœ¨ç¾¤æˆå‘˜
ORDER BY p.join_time ASC;

-- åœºæ™¯5: æŸ¥è¯¢æŸå®¢æˆ·å‚ä¸çš„æ‰€æœ‰ä¼šè¯(å«å·²é€€å‡ºçš„ç¾¤)
SELECT c.*, p.is_active, p.leave_time
FROM t_wecom_conversation c
INNER JOIN t_wecom_conversation_participant p ON p.conversation_id = c.conversation_id
WHERE p.participant_id = 'customer001'
ORDER BY c.last_msg_time DESC;
```

---

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**:

1. **å†—ä½™å­—æ®µå‡å°‘JOIN**:
   - `participant_count`, `customer_count` é¿å…ç»Ÿè®¡æŸ¥è¯¢
   - `participant_name` é¿å…JOINå‘˜å·¥/å®¢æˆ·è¡¨
   - `last_msg_sender_name` ä¼šè¯åˆ—è¡¨ç›´æ¥æ˜¾ç¤º

2. **ç´¢å¼•è¦†ç›–é«˜é¢‘æŸ¥è¯¢**:
   - `idx_participant (participant_id, conversation_id)` - æŸ¥æŸäººçš„ä¼šè¯
   - `uk_conv_participant` - é˜²æ­¢é‡å¤å‚ä¸æ–¹

3. **åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**:
   ```sql
   -- å…ˆæŸ¥ä¼šè¯ID(è¦†ç›–ç´¢å¼•),å†JOINæŸ¥è¯¦æƒ…
   SELECT c.*
   FROM t_wecom_conversation c
   INNER JOIN (
     SELECT conversation_id
     FROM t_wecom_conversation_participant
     WHERE participant_id = ?
     LIMIT 20 OFFSET 0
   ) p ON p.conversation_id = c.conversation_id
   ORDER BY c.last_msg_time DESC;
   ```

4. **ç¼“å­˜ç­–ç•¥**:
   ```java
   // ç¼“å­˜æŸäººçš„ä¼šè¯IDåˆ—è¡¨(ä»…ID,ä½“ç§¯å°)
   "wecom:conv:ids:{participant_id}" -> [1,2,3,4,5...] (TTL 30åˆ†é’Ÿ)

   // ç¼“å­˜å•ä¸ªä¼šè¯è¯¦æƒ…
   "wecom:conv:detail:{conversation_id}" -> ConversationVO (TTL 10åˆ†é’Ÿ)

   // æ–°æ¶ˆæ¯æ—¶åªæ›´æ–°å¯¹åº”ä¼šè¯çš„ç¼“å­˜,ä¸æ¸…é™¤æ•´ä¸ªåˆ—è¡¨
   ```

---

### 3. æ¶ˆæ¯ç®¡ç†è¡¨

#### t_wecom_message (æ¶ˆæ¯ä¸»è¡¨)

**ç”¨é€”**: å­˜å‚¨çº¯ç²¹çš„æ¶ˆæ¯å†…å®¹ï¼Œä¸ç›´æ¥å…³è”ä¼šè¯ï¼ˆé€šè¿‡å…³è”è¡¨è§£è€¦ï¼‰

**è®¾è®¡ç†å¿µ**: æ¶ˆæ¯è¡¨åªå­˜å‚¨æ¶ˆæ¯æœ¬èº«ï¼Œä¸ä¼šè¯çš„å…³ç³»ç”± `t_wecom_message_conversation` ç»´æŠ¤

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| message_id | bigint | æ¶ˆæ¯è‡ªå¢ID | ä¸»é”® |
| msg_id | varchar(128) | ä¼å¾®æ¶ˆæ¯ID | å”¯ä¸€æ ‡è¯† |
| corp_id | varchar(64) | ä¼ä¸šID | |
| seq | bigint | æ¶ˆæ¯åºå· | ä¼å¾®SDKè¿”å›,ç”¨äºæ’åºå’Œæ–­ç‚¹ç»­ä¼  |
| msg_type | varchar(32) | æ¶ˆæ¯ç±»å‹ | text/image/voice/videoç­‰ |
| msg_action | varchar(32) | æ¶ˆæ¯åŠ¨ä½œ | send-å‘é€ recall-æ’¤å› |
| from_id | varchar(64) | å‘é€æ–¹ID | |
| from_type | tinyint | å‘é€æ–¹ç±»å‹ | 1-å®¢æˆ· 2-å‘˜å·¥ |
| from_name | varchar(128) | å‘é€æ–¹åç§° | å†—ä½™å­—æ®µ |
| to_list | json | æ¥æ”¶æ–¹IDåˆ—è¡¨ | JSONæ•°ç»„ï¼ˆä¼å¾®åŸå§‹æ•°æ®ï¼‰ |
| room_id | varchar(64) | ç¾¤èŠID | ç¾¤èŠæ—¶æœ‰å€¼ï¼ˆä¼å¾®åŸå§‹æ•°æ®ï¼‰ |
| msg_time | datetime | æ¶ˆæ¯æ—¶é—´ | **åˆ†åŒºé”®** |
| msg_content | text | æ¶ˆæ¯æ–‡æœ¬å†…å®¹ | æ–‡æœ¬æ¶ˆæ¯ç›´æ¥å­˜å‚¨,å…¶ä»–ç±»å‹æå–æ‘˜è¦ |
| raw_content | json | ä¼å¾®åŸå§‹æ¶ˆæ¯JSON | å®Œæ•´æ•°æ®,ç”¨äºè¯¦æƒ…å±•ç¤º |
| public_key_ver | int | åŠ å¯†å…¬é’¥ç‰ˆæœ¬ | |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `(message_id, msg_time)` - åˆ†åŒºè¡¨å¤åˆä¸»é”®
- UNIQUE KEY: `uk_msg_id` (msg_id)
- KEY: `idx_corp` (corp_id)
- KEY: `idx_seq` (seq)
- KEY: `idx_from` (from_id)
- KEY: `idx_room` (room_id)
- KEY: `idx_msg_time` (msg_time)
- KEY: `idx_msg_type` (msg_type)

**è¯´æ˜**:
- âŒ ä¸å­˜å‚¨ `conversation_id`ï¼šä¸ä¼šè¯è§£è€¦ï¼Œé€šè¿‡å…³è”è¡¨å»ºç«‹å…³ç³»
- âœ… ä¿ç•™ `to_list` å’Œ `room_id`ï¼šä¼å¾®åŸå§‹æ•°æ®ï¼Œç”¨äºæ¶ˆæ¯å¤„ç†é€»è¾‘
- âœ… ä¸€æ¡æ¶ˆæ¯å¯ä»¥å…³è”å¤šä¸ªä¼šè¯ï¼šæ”¯æŒç¾¤å‘åœºæ™¯

**åˆ†åŒºç­–ç•¥**:

```sql
-- æŒ‰æœˆåˆ†åŒº,æå‡å¤§æ•°æ®é‡æŸ¥è¯¢æ€§èƒ½
PARTITION BY RANGE (YEAR(msg_time) * 100 + MONTH(msg_time)) (
  PARTITION p202501 VALUES LESS THAN (202502),
  PARTITION p202502 VALUES LESS THAN (202503),
  ...
  PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

**raw_content JSONç»“æ„ç¤ºä¾‹**:

```json
// æ–‡æœ¬æ¶ˆæ¯
{
  "msgid": "CAQQluDa4QUY0On2rYSAgAMgzPrShAE=",
  "action": "send",
  "from": "UserID123",
  "tolist": ["UserID456"],
  "roomid": "",
  "msgtime": 1547087894783,
  "msgtype": "text",
  "text": {
    "content": "æ¶ˆæ¯å†…å®¹"
  }
}

// å›¾ç‰‡æ¶ˆæ¯
{
  "msgtype": "image",
  "image": {
    "sdkfileid": "CtYBMzA5NDcwMjAxNDAzMjMz...",
    "md5sum": "50de8e5ae8ffe4f1df7a93841f71993a",
    "filesize": 70961
  }
}

// æ–‡ä»¶æ¶ˆæ¯
{
  "msgtype": "file",
  "file": {
    "filename": "é¡¹ç›®æ–‡æ¡£.pdf",
    "fileext": "pdf",
    "sdkfileid": "CtYBMzA5NDcwMjAxNDAzMjMz...",
    "md5sum": "e5b6d8e3f2a9c7d1b4e8f9a1c2d3e4f5",
    "filesize": 2048576
  }
}
```

**æŸ¥è¯¢ä¼˜åŒ–**:

```sql
-- âœ… åˆ©ç”¨åˆ†åŒº - å¿…é¡»å¸¦æ—¶é—´æ¡ä»¶
SELECT * FROM t_wecom_message
WHERE conversation_id = ?
  AND msg_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)  -- åˆ©ç”¨åˆ†åŒº
ORDER BY seq ASC
LIMIT 50;

-- âŒ ä¸åˆ©ç”¨åˆ†åŒº - ä¼šæ‰«ææ‰€æœ‰åˆ†åŒº
SELECT * FROM t_wecom_message
WHERE conversation_id = ?
ORDER BY seq ASC
LIMIT 50;
```

---

#### t_wecom_message_conversation (æ¶ˆæ¯ä¼šè¯å…³è”è¡¨) â­â­â­æ ¸å¿ƒ

**ç”¨é€”**: æ¶ˆæ¯ä¸ä¼šè¯çš„å¤šå¯¹å¤šå…³è”è¡¨ï¼Œå®ç°æ¶ˆæ¯ä¼šè¯è§£è€¦ï¼Œé‡‡ç”¨ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

**è®¾è®¡ç†å¿µ**:
- **èŒè´£æ¸…æ™°**ï¼šæ¶ˆæ¯è¡¨åªå­˜æ¶ˆæ¯ï¼Œä¼šè¯è¡¨åªå­˜ä¼šè¯ï¼Œå…³è”è¡¨å»ºç«‹è·¯ç”±å…³ç³»
- **è§£è€¦çµæ´»**ï¼šä¸€æ¡æ¶ˆæ¯å¯ä»¥å…³è”å¤šä¸ªä¼šè¯ï¼ˆç¾¤å‘åœºæ™¯ï¼‰
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡to_idå†—ä½™å­—æ®µå®ç°å•è¡¨ç´¢å¼•æŸ¥è¯¢ï¼Œé¿å…å¤æ‚JOIN
- **æ‰©å±•å‹å¥½**ï¼šæ”¯æŒæ¶ˆæ¯è½¬å‘ã€è·¨ä¼šè¯å¼•ç”¨ç­‰æœªæ¥éœ€æ±‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| id | bigint | å…³è”ID | ä¸»é”®,è‡ªå¢ |
| msg_id | varchar(128) | ä¼å¾®æ¶ˆæ¯ID | å…³è”åŸå§‹æ¶ˆæ¯,æ–¹ä¾¿å®šä½ |
| message_id | bigint | æ¶ˆæ¯è¡¨ID | å…³è”t_wecom_message |
| conversation_id | bigint | ä¼šè¯ID | å…³è”t_wecom_conversation |
| from_id | varchar(64) | å‘é€æ–¹ID | å†—ä½™å­—æ®µ,åŠ é€ŸæŸ¥è¯¢ |
| to_id | varchar(64) | æ¥æ”¶æ–¹ID | **æ ¸å¿ƒå†—ä½™å­—æ®µ**ï¼šå•èŠ=UserID, ç¾¤èŠ=RoomID |
| route_type | tinyint | è·¯ç”±ç±»å‹ | 1-å•èŠ 2-ç¾¤èŠ |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `id`
- KEY: `idx_msg` (msg_id)
- KEY: `idx_message` (message_id)
- KEY: `idx_conversation` (conversation_id)
- KEY: `idx_from_to` (from_id, to_id)
- KEY: `idx_to_time` (to_id, create_time) - **ğŸ”¥æ ¸å¿ƒæŸ¥è¯¢ç´¢å¼•ï¼šæŸ¥è¯¢æŸäººçš„æ¶ˆæ¯**

**æ•°æ®ç¤ºä¾‹**:

**åœºæ™¯1ï¼šç¾¤èŠæ¶ˆæ¯**
```sql
-- ä¼å¾®åŸå§‹æ¶ˆæ¯
msgid=msg001, from=rocky, roomid=room123, tolist=[...]

-- ç”Ÿæˆ1æ¡å…³è”è®°å½•
INSERT INTO t_wecom_message_conversation VALUES (
  1, 'msg001', 1001, 10, 'rocky', 'room123', 2, 0, NOW()
);

è¯´æ˜:
- ç¾¤èŠæ¶ˆæ¯åªç”Ÿæˆ1æ¡å…³è”è®°å½•
- to_id = room123ï¼ˆç¾¤èŠIDï¼‰
- conversation_id = 10ï¼ˆæŸ¥è¯¢/åˆ›å»ºçš„ç¾¤èŠä¼šè¯IDï¼‰
```

**åœºæ™¯2ï¼šå•èŠæ¶ˆæ¯**
```sql
-- ä¼å¾®åŸå§‹æ¶ˆæ¯
msgid=msg002, from=rocky, tolist=[zhangsan], roomid=""

-- ç”Ÿæˆ1æ¡å…³è”è®°å½•
INSERT INTO t_wecom_message_conversation VALUES (
  2, 'msg002', 1002, 20, 'rocky', 'zhangsan', 1, 0, NOW()
);

è¯´æ˜:
- å•èŠæ¶ˆæ¯ç”Ÿæˆ1æ¡å…³è”è®°å½•
- to_id = zhangsanï¼ˆæ¥æ”¶æ–¹UserIDï¼‰
- conversation_id = 20ï¼ˆæŸ¥è¯¢/åˆ›å»ºçš„å•èŠä¼šè¯IDï¼‰
```

**åœºæ™¯3ï¼šç¾¤å‘æ¶ˆæ¯ï¼ˆä¸€å¯¹å¤šï¼‰**
```sql
-- ä¼å¾®åŸå§‹æ¶ˆæ¯
msgid=msg003, from=rocky, tolist=[zhangsan,lisi,wangwu], roomid=""

-- ç”Ÿæˆ3æ¡å…³è”è®°å½•ï¼ˆæ¯ä¸ªæ¥æ”¶è€…ä¸€æ¡ï¼‰
INSERT INTO t_wecom_message_conversation VALUES
  (3, 'msg003', 1003, 20, 'rocky', 'zhangsan', 1, 0, NOW()),
  (4, 'msg003', 1003, 21, 'rocky', 'lisi', 1, 0, NOW()),
  (5, 'msg003', 1003, 22, 'rocky', 'wangwu', 1, 0, NOW());

è¯´æ˜:
- ç¾¤å‘æ¶ˆæ¯ç”ŸæˆNæ¡å…³è”è®°å½•ï¼ˆN=æ¥æ”¶è€…æ•°é‡ï¼‰
- æ¯æ¡è®°å½•å¯¹åº”ä¸åŒçš„to_idå’Œconversation_id
- åŒä¸€æ¡æ¶ˆæ¯ï¼ˆmessage_id=1003ï¼‰å…³è”åˆ°å¤šä¸ªä¼šè¯
```

**æ ¸å¿ƒæŸ¥è¯¢åœºæ™¯**:

```sql
-- åœºæ™¯1: æŸ¥è¯¢æŸäººæ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆğŸ”¥æé€ŸæŸ¥è¯¢ï¼Œå•è¡¨ç´¢å¼•æ‰«æï¼‰
SELECT m.*
FROM t_wecom_message m
INNER JOIN t_wecom_message_conversation mc ON m.message_id = mc.message_id
WHERE mc.to_id = 'rocky'
  AND m.msg_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY m.msg_time DESC
LIMIT 50;

-- åœºæ™¯2: æŸ¥è¯¢æŸäººå‘é€æˆ–æ¥æ”¶çš„æ‰€æœ‰æ¶ˆæ¯
SELECT m.*
FROM t_wecom_message m
INNER JOIN t_wecom_message_conversation mc ON m.message_id = mc.message_id
WHERE (mc.to_id = 'rocky' OR mc.from_id = 'rocky')
  AND m.msg_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY m.msg_time DESC
LIMIT 50;

-- åœºæ™¯3: æŸ¥è¯¢æŸä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆåˆ©ç”¨conversation_idç´¢å¼•ï¼‰
SELECT m.*
FROM t_wecom_message m
INNER JOIN t_wecom_message_conversation mc ON m.message_id = mc.message_id
WHERE mc.conversation_id = ?
  AND m.msg_time >= ?  -- åˆ©ç”¨åˆ†åŒº
ORDER BY m.seq ASC
LIMIT 50;

-- åœºæ™¯4: ç»Ÿè®¡æŸäººçš„æ¶ˆæ¯æ•°é‡ï¼ˆè¦†ç›–ç´¢å¼•ï¼Œæ— éœ€å›è¡¨ï¼‰
SELECT COUNT(*) FROM t_wecom_message_conversation
WHERE to_id = 'rocky'
  AND create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY);

-- åœºæ™¯5: æŸ¥æ‰¾ç¾¤å‘æ¶ˆæ¯ï¼ˆåŒä¸€æ¡æ¶ˆæ¯å…³è”å¤šä¸ªä¼šè¯ï¼‰
SELECT msg_id, COUNT(*) as conversation_count
FROM t_wecom_message_conversation
WHERE route_type = 1  -- å•èŠ
GROUP BY msg_id
HAVING COUNT(*) > 1;
```

**æ€§èƒ½å¯¹æ¯”**:

| æŸ¥è¯¢æ–¹å¼ | è¡¨æ‰«æ | ç´¢å¼•ä½¿ç”¨ | æ€§èƒ½ |
|---------|-------|---------|------|
| **åŸæ–¹æ¡ˆ**: JOINå‚ä¸æ–¹å…³ç³»è¡¨ | 3å¼ è¡¨ | å¤šè¡¨JOIN | æ…¢ âš ï¸ |
| **æ–°æ–¹æ¡ˆ**: æ¶ˆæ¯ä¼šè¯å…³è”è¡¨ | 2å¼ è¡¨ | å•è¡¨ç´¢å¼•æ‰«æ | å¿« âœ… |

**ç©ºé—´æˆæœ¬**:
- å‡è®¾: 1000ä¸‡æ¡æ¶ˆæ¯ï¼Œå¹³å‡æ¯æ¡1.5ä¸ªå…³è”ï¼ˆç¾¤èŠ1ä¸ªï¼Œå•èŠ1ä¸ªï¼Œç¾¤å‘å¤šä¸ªï¼‰
- å…³è”è¡¨è®°å½•: 1500ä¸‡æ¡
- å­˜å‚¨ç©ºé—´: çº¦1.5GBï¼ˆæ¯æ¡è®°å½•~100å­—èŠ‚ï¼‰
- **ç»“è®º**: æˆæœ¬å®Œå…¨å¯æ¥å— âœ…

**æ¶ˆæ¯å¤„ç†æµç¨‹**:

```
æ¥æ”¶ä¼å¾®æ¶ˆæ¯
â†“
è§£å¯†æ¶ˆæ¯JSON
â†“
åˆ¤æ–­ä¼šè¯ç±»å‹
â”œâ”€ roomidä¸ä¸ºç©º? â†’ ç¾¤èŠ
â”‚   â”œâ”€ æŸ¥è¯¢/åˆ›å»ºä¼šè¯ (æ ¹æ®corp_id + roomid)
â”‚   â””â”€ åˆ›å»º1æ¡å…³è”è®°å½•: to_id=roomid
â””â”€ roomidä¸ºç©º? â†’ å•èŠæˆ–ç¾¤å‘
    â”œâ”€ éå†tolistä¸­çš„æ¯ä¸ªæ¥æ”¶è€…
    â”œâ”€ æŸ¥è¯¢/åˆ›å»ºä¼šè¯ (æ ¹æ®from + toå‚ä¸æ–¹ç»„åˆ)
    â””â”€ ä¸ºæ¯ä¸ªæ¥æ”¶è€…åˆ›å»º1æ¡å…³è”è®°å½•: to_id=æ¥æ”¶è€…UserID
```

**è®¾è®¡ä¼˜åŠ¿**:
- âœ… **æŸ¥è¯¢æ€§èƒ½**: å•è¡¨ç´¢å¼•æ‰«æï¼Œé¿å…å¤æ‚JOIN
- âœ… **ç¾¤å‘æ”¯æŒ**: ä¸€æ¡æ¶ˆæ¯å¯ä»¥æœ‰å¤šæ¡å…³è”è®°å½•
- âœ… **é€‚åˆå­˜æ¡£**: è¯»å¤šå†™å°‘ï¼Œç©ºé—´æˆæœ¬å¯æ¥å—
- âœ… **ç´¢å¼•è¦†ç›–**: idx_to_timeå¯ä»¥è¦†ç›–å¤§éƒ¨åˆ†æŸ¥è¯¢
- âœ… **æ¶ˆæ¯è§£è€¦**: æ¶ˆæ¯è¡¨ä¸“æ³¨äºæ¶ˆæ¯å†…å®¹ï¼Œå…³è”å…³ç³»ç”±ä¸“é—¨çš„è¡¨ç»´æŠ¤

---

#### t_wecom_message_media (ä¼šè¯åª’ä½“æ–‡ä»¶è¡¨)

**ç”¨é€”**: å­˜å‚¨ä¼šè¯æ¶ˆæ¯ä¸­çš„åª’ä½“æ–‡ä»¶ä¸šåŠ¡ä¿¡æ¯ï¼Œå…³è”æ¶ˆæ¯è¡¨å’Œæ–‡ä»¶å­˜å‚¨è¡¨

**è®¾è®¡ç†å¿µ**: åˆ†ç¦»å­˜å‚¨å’Œä¸šåŠ¡ï¼Œt_fileè´Ÿè´£æ–‡ä»¶å­˜å‚¨ï¼Œæœ¬è¡¨è´Ÿè´£ä¸šåŠ¡ä¿¡æ¯å’Œå±•ç¤ºéœ€æ±‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| media_id | bigint | åª’ä½“ID | ä¸»é”®,è‡ªå¢ |
| message_id | bigint | æ¶ˆæ¯ID | å…³è”t_wecom_message |
| msg_id | varchar(128) | ä¼å¾®æ¶ˆæ¯ID | å†—ä½™å­—æ®µ,æ–¹ä¾¿æŸ¥è¯¢ |
| corp_id | varchar(64) | ä¼ä¸šID | |
| media_type | varchar(32) | åª’ä½“ç±»å‹ | image/voice/video/file/emotion |
| sdk_file_id | varchar(255) | ä¼å¾®åª’ä½“æ–‡ä»¶ID | ä¼å¾®SDKè¿”å›çš„æ–‡ä»¶ID,ç”¨äºä¸‹è½½ |
| md5sum | varchar(64) | æ–‡ä»¶MD5å€¼ | ä¼å¾®è¿”å›,ç”¨äºæ ¡éªŒ |
| file_id | bigint | æ–‡ä»¶å­˜å‚¨ID | å…³è”t_fileè¡¨,å­˜å‚¨ä¸»æ–‡ä»¶ |
| thumbnail_file_id | bigint | ç¼©ç•¥å›¾æ–‡ä»¶ID | å…³è”t_fileè¡¨,å­˜å‚¨ç¼©ç•¥å›¾(å›¾ç‰‡/è§†é¢‘ç”¨) |
| file_name | varchar(255) | æ–‡ä»¶å | ä»æ¶ˆæ¯ä¸­æå–æˆ–ç”Ÿæˆ |
| file_ext | varchar(32) | æ–‡ä»¶æ‰©å±•å | jpg/png/mp3/mp4/pdfç­‰ |
| file_size | bigint | æ–‡ä»¶å¤§å° | å­—èŠ‚æ•° |
| duration | int | æ—¶é•¿ | è¯­éŸ³/è§†é¢‘æ—¶é•¿(ç§’) |
| width | int | å®½åº¦ | å›¾ç‰‡/è§†é¢‘å®½åº¦(åƒç´ ) |
| height | int | é«˜åº¦ | å›¾ç‰‡/è§†é¢‘é«˜åº¦(åƒç´ ) |
| download_status | tinyint | ä¸‹è½½çŠ¶æ€ | 0-å¾…ä¸‹è½½ 1-ä¸‹è½½ä¸­ 2-å·²ä¸‹è½½ 3-å¤±è´¥ |
| download_time | datetime | ä¸‹è½½æ—¶é—´ | æˆåŠŸä¸‹è½½çš„æ—¶é—´ |
| download_error_msg | varchar(500) | ä¸‹è½½å¤±è´¥åŸå›  | å¤±è´¥æ—¶è®°å½•é”™è¯¯ä¿¡æ¯ |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `media_id`
- UNIQUE KEY: `uk_msg_media` (message_id, media_type) - ä¸€æ¡æ¶ˆæ¯ä¸€ç§ç±»å‹åªæœ‰ä¸€ä¸ªåª’ä½“æ–‡ä»¶
- KEY: `idx_msg_id` (msg_id)
- KEY: `idx_sdk_file_id` (sdk_file_id)
- KEY: `idx_file_id` (file_id)
- KEY: `idx_download_status` (download_status)

**å…³è”å…³ç³»**:
```
t_wecom_message (æ¶ˆæ¯è¡¨)
        â†“ 1:N
t_wecom_message_media (åª’ä½“æ–‡ä»¶è¡¨)
        â†“ N:1
t_file (SmartAdminæ–‡ä»¶å­˜å‚¨è¡¨)
```

**æ•°æ®ç¤ºä¾‹**:
```sql
-- å›¾ç‰‡æ¶ˆæ¯
INSERT INTO t_wecom_message_media VALUES (
  1, 1001, 'msgid123', 'corp001', 'image',
  'sdk_file_id_xxx', 'md5_xxx',
  5001, 5002,  -- file_id, thumbnail_file_id
  'å®¢æˆ·å‘çš„äº§å“å›¾.jpg', 'jpg', 1024000,
  NULL, 1920, 1080,  -- duration, width, height
  2, '2025-10-08 10:00:00', NULL,  -- å·²ä¸‹è½½
  0, NOW(), NOW()
);

-- è¯­éŸ³æ¶ˆæ¯
INSERT INTO t_wecom_message_media VALUES (
  2, 1002, 'msgid456', 'corp001', 'voice',
  'sdk_file_id_yyy', 'md5_yyy',
  5003, NULL,  -- file_id, è¯­éŸ³æ— ç¼©ç•¥å›¾
  'è¯­éŸ³æ¶ˆæ¯_20251008.amr', 'amr', 50000,
  30, NULL, NULL,  -- 30ç§’è¯­éŸ³
  2, '2025-10-08 10:01:00', NULL,
  0, NOW(), NOW()
);

-- æ–‡ä»¶æ¶ˆæ¯
INSERT INTO t_wecom_message_media VALUES (
  3, 1003, 'msgid789', 'corp001', 'file',
  'sdk_file_id_zzz', 'md5_zzz',
  5004, NULL,
  'åˆåŒæ–‡ä»¶.pdf', 'pdf', 2048000,
  NULL, NULL, NULL,
  2, '2025-10-08 10:02:00', NULL,
  0, NOW(), NOW()
);
```

**åª’ä½“ç±»å‹è¯´æ˜**:
| media_type | è¯´æ˜ | æ˜¯å¦æœ‰ç¼©ç•¥å›¾ | æ˜¯å¦æœ‰æ—¶é•¿ |
|-----------|------|------------|----------|
| image | å›¾ç‰‡ | âœ… æ˜¯ | âŒ å¦ |
| voice | è¯­éŸ³ | âŒ å¦ | âœ… æ˜¯ |
| video | è§†é¢‘ | âœ… æ˜¯ | âœ… æ˜¯ |
| file | æ–‡ä»¶ | âŒ å¦ | âŒ å¦ |
| emotion | è¡¨æƒ… | âŒ å¦ | âŒ å¦ |

**ä¸‹è½½çŠ¶æ€æµè½¬**:
```
0(å¾…ä¸‹è½½) â†’ 1(ä¸‹è½½ä¸­) â†’ 2(å·²ä¸‹è½½)
                    â†˜ 3(å¤±è´¥) â†’ [é‡è¯•] â†’ 1(ä¸‹è½½ä¸­)
```

**æ ¸å¿ƒæŸ¥è¯¢åœºæ™¯**:
```sql
-- åœºæ™¯1: æŸ¥è¯¢æ¶ˆæ¯çš„åª’ä½“æ–‡ä»¶ä¿¡æ¯ï¼ˆå«æ–‡ä»¶URLï¼‰
SELECT
  m.media_id,
  m.media_type,
  m.file_name,
  m.file_size,
  m.duration,
  f1.file_key AS file_url,
  f2.file_key AS thumbnail_url
FROM t_wecom_message_media m
LEFT JOIN t_file f1 ON m.file_id = f1.file_id
LEFT JOIN t_file f2 ON m.thumbnail_file_id = f2.file_id
WHERE m.message_id = ?;

-- åœºæ™¯2: æŸ¥è¯¢å¾…ä¸‹è½½çš„åª’ä½“æ–‡ä»¶
SELECT *
FROM t_wecom_message_media
WHERE download_status = 0
  AND deleted_flag = 0
ORDER BY create_time ASC
LIMIT 100;

-- åœºæ™¯3: ç»Ÿè®¡åª’ä½“æ–‡ä»¶ä¸‹è½½æƒ…å†µ
SELECT
  media_type,
  download_status,
  COUNT(*) AS count,
  SUM(file_size) AS total_size
FROM t_wecom_message_media
WHERE corp_id = 'corp001'
  AND create_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY media_type, download_status;
```

**è®¾è®¡ä¼˜åŠ¿**:
- âœ… åˆ†ç¦»å…³æ³¨ç‚¹ï¼šå­˜å‚¨ï¼ˆt_fileï¼‰vs ä¸šåŠ¡ï¼ˆt_wecom_message_mediaï¼‰
- âœ… æ”¯æŒç¼©ç•¥å›¾ï¼šå›¾ç‰‡å’Œè§†é¢‘å¯ä»¥æœ‰ç‹¬ç«‹çš„ç¼©ç•¥å›¾æ–‡ä»¶
- âœ… ä¸‹è½½ç®¡ç†ï¼šè®°å½•ä¸‹è½½çŠ¶æ€ï¼Œæ”¯æŒå¼‚æ­¥ä¸‹è½½å’Œå¤±è´¥é‡è¯•
- âœ… ä¼å¾®ç‰¹æœ‰ä¿¡æ¯ï¼šä¿ç•™sdk_file_idå’Œmd5sumï¼Œæ–¹ä¾¿é‡æ–°ä¸‹è½½
- âœ… å±•ç¤ºä¼˜åŒ–ï¼šå†—ä½™æ–‡ä»¶åã€å¤§å°ã€æ—¶é•¿ç­‰ï¼Œå‡å°‘JOINæŸ¥è¯¢

---

### 4. å‚ä¸æ–¹ä¿¡æ¯è¡¨

#### t_wecom_staff (å‘˜å·¥è¡¨)

**ç”¨é€”**: å­˜å‚¨ä¼ä¸šå‘˜å·¥ä¿¡æ¯

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| staff_id | bigint | å‘˜å·¥ID | ä¸»é”®,è‡ªå¢ |
| corp_id | varchar(64) | ä¼ä¸šID | |
| wecom_user_id | varchar(64) | ä¼å¾®å‘˜å·¥UserID | ä¼å¾®APIè¿”å›çš„åŸå§‹ID |
| name | varchar(128) | å§“å | |
| alias | varchar(128) | åˆ«å | |
| mobile | varchar(32) | æ‰‹æœºå· | |
| position | varchar(128) | èŒåŠ¡ | |
| gender | tinyint | æ€§åˆ« | 0-æœªå®šä¹‰ 1-ç”· 2-å¥³ |
| avatar | varchar(500) | å¤´åƒURL | |
| department | json | éƒ¨é—¨IDåˆ—è¡¨ | JSONæ•°ç»„ |
| status | tinyint | çŠ¶æ€ | 1-å·²æ¿€æ´» 2-å·²ç¦ç”¨ 4-æœªæ¿€æ´» 5-å·²ç¦»èŒ |
| enable_chat_archive_flag | tinyint | æ˜¯å¦å¼€å¯ä¼šè¯å­˜æ¡£ | 0-å¦ 1-æ˜¯ |
| has_conversation_flag | tinyint | æ˜¯å¦æœ‰ä¼šè¯è®°å½• | 0-å¦ 1-æ˜¯ |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `staff_id`
- UNIQUE KEY: `uk_corp_user` (corp_id, wecom_user_id)
- KEY: `idx_name` (name)
- KEY: `idx_status` (status)

---

#### t_wecom_staff_customer_relation (å‘˜å·¥-å®¢æˆ·å…³ç³»è¡¨) â­æ–°å¢

**ç”¨é€”**: å­˜å‚¨å‘˜å·¥ä¸å®¢æˆ·çš„å…³è”å…³ç³»åŠå‘˜å·¥çº§åˆ«çš„æ•°æ®

**è®¾è®¡ç†å¿µ**: ä¸€ä¸ªå®¢æˆ·å¯ä»¥è¢«å¤šä¸ªå‘˜å·¥æ·»åŠ ï¼Œæ¯ä¸ªå‘˜å·¥å¯¹åŒä¸€å®¢æˆ·æœ‰ç‹¬ç«‹çš„å¤‡æ³¨ã€æ ‡ç­¾ã€æ·»åŠ æ–¹å¼ç­‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| relation_id | bigint | å…³ç³»ID | ä¸»é”®,è‡ªå¢ |
| corp_id | varchar(64) | ä¼ä¸šID | |
| wecom_staff_user_id | varchar(64) | ä¼å¾®å‘˜å·¥UserID | å…³è”å‘˜å·¥è¡¨ |
| wecom_external_user_id | varchar(64) | ä¼å¾®å®¢æˆ·ExternalUserID | å…³è”å®¢æˆ·è¡¨ |
| staff_remark | varchar(128) | å‘˜å·¥å¤‡æ³¨å | å‘˜å·¥å¯¹å®¢æˆ·çš„å¤‡æ³¨ |
| staff_description | varchar(500) | å‘˜å·¥æè¿° | å‘˜å·¥å¯¹å®¢æˆ·çš„æè¿° |
| add_way | tinyint | æ·»åŠ æ¥æº | 0-æœªçŸ¥ 1-æ‰«ç  2-æœæ‰‹æœºå· 3-åç‰‡åˆ†äº« 4-ç¾¤èŠ 5-é€šè®¯å½• 6-å¾®ä¿¡è”ç³»äºº 7-ç”³è¯· 8-è‡ªåŠ¨æ·»åŠ  9-æœé‚®ç®± 201-å†…éƒ¨å…±äº« 202-ç®¡ç†å‘˜åˆ†é… |
| add_time | datetime | æ·»åŠ æ—¶é—´ | å‘˜å·¥æ·»åŠ å®¢æˆ·çš„æ—¶é—´ |
| state | varchar(128) | æ¥æºæ¸ é“ | æ·»åŠ å®¢æˆ·æ—¶çš„æ¸ é“å‚æ•° |
| remark_corp_name | varchar(128) | å¤‡æ³¨ä¼ä¸šåç§° | å‘˜å·¥å¤‡æ³¨çš„å®¢æˆ·ä¼ä¸šå |
| remark_mobiles | json | å¤‡æ³¨æ‰‹æœºå· | å‘˜å·¥å¤‡æ³¨çš„å®¢æˆ·æ‰‹æœºå·åˆ—è¡¨ |
| tags | json | å®¢æˆ·æ ‡ç­¾ | å‘˜å·¥ç»™å®¢æˆ·æ‰“çš„æ ‡ç­¾ï¼ˆJSONæ•°ç»„ï¼ŒåŒ…å«ä¼ä¸šæ ‡ç­¾å’Œä¸ªäººæ ‡ç­¾ï¼‰ |
| relation_status | tinyint | å…³ç³»çŠ¶æ€ | 0-å·²åˆ é™¤å¥½å‹ 1-æ­£å¸¸ |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `relation_id`
- UNIQUE KEY: `uk_corp_staff_customer` (corp_id, wecom_staff_user_id, wecom_external_user_id)
- KEY: `idx_staff` (wecom_staff_user_id)
- KEY: `idx_customer` (wecom_external_user_id)
- KEY: `idx_relation_status` (relation_status)

**æ•°æ®ç¤ºä¾‹**:
```
å®¢æˆ·"æå››"è¢«ä¸¤ä¸ªå‘˜å·¥æ·»åŠ ï¼ˆä¸åŒçš„å¤‡æ³¨å’Œæ ‡ç­¾ï¼‰:
relation_id=1, wecom_staff_user_id=rocky, wecom_external_user_id=ext001,
  staff_remark=æéƒ¨é•¿, add_way=1,
  tags=[{"tag_name":"VIPå®¢æˆ·","tag_id":"xxx","type":1},{"tag_name":"é‡ç‚¹è·Ÿè¿›","type":2}]

relation_id=2, wecom_staff_user_id=zhangsan, wecom_external_user_id=ext001,
  staff_remark=é‡‡è´­ç»ç†, add_way=2,
  tags=[{"tag_name":"æ½œåœ¨å®¢æˆ·","type":2}]
```

**add_way æšä¸¾å€¼**:
| å€¼ | è¯´æ˜ |
|----|------|
| 0 | æœªçŸ¥æ¥æº |
| 1 | æ‰«æäºŒç»´ç  |
| 2 | æœç´¢æ‰‹æœºå· |
| 3 | åç‰‡åˆ†äº« |
| 4 | ç¾¤èŠ |
| 5 | æ‰‹æœºé€šè®¯å½• |
| 6 | å¾®ä¿¡è”ç³»äºº |
| 7 | æ¥è‡ªå¾®ä¿¡çš„æ·»åŠ å¥½å‹ç”³è¯· |
| 8 | å®‰è£…ç¬¬ä¸‰æ–¹åº”ç”¨æ—¶è‡ªåŠ¨æ·»åŠ çš„å®¢æœäººå‘˜ |
| 9 | æœç´¢é‚®ç®± |
| 201 | å†…éƒ¨æˆå‘˜å…±äº« |
| 202 | ç®¡ç†å‘˜/è´Ÿè´£äººåˆ†é… |

**tags JSONç»“æ„**:
```json
[
  {
    "group_name": "å®¢æˆ·åˆ†ç±»",
    "tag_name": "VIPå®¢æˆ·",
    "tag_id": "etAJ2GCAAAXtWyujaWJHDDGi0mACHAAA",
    "type": 1  // 1-ä¼ä¸šæ ‡ç­¾ 2-ä¸ªäººæ ‡ç­¾ 3-è§„åˆ™ç»„æ ‡ç­¾
  },
  {
    "group_name": "æˆ‘çš„åˆ†ç±»",
    "tag_name": "é‡ç‚¹è·Ÿè¿›",
    "type": 2  // ä¸ªäººæ ‡ç­¾æ— tag_id
  }
]
```

**æ ‡ç­¾ç±»å‹è¯´æ˜**:
| type | ç±»å‹ | è¯´æ˜ | æ˜¯å¦æœ‰tag_id |
|------|------|------|-------------|
| 1 | ä¼ä¸šæ ‡ç­¾ | ç®¡ç†å‘˜ç»Ÿä¸€é…ç½®ï¼Œæ‰€æœ‰å‘˜å·¥å¯ç”¨ | âœ… æ˜¯ |
| 2 | ä¸ªäººæ ‡ç­¾ | å‘˜å·¥ä¸ªäººåˆ›å»ºï¼Œåªæœ‰åˆ›å»ºè€…å¯è§ | âŒ å¦ |
| 3 | è§„åˆ™ç»„æ ‡ç­¾ | è‡ªåŠ¨åŒ–è§„åˆ™åˆ†é…çš„æ ‡ç­¾ | âœ… æ˜¯ |

**é‡è¦è¯´æ˜**:
- åŒä¸€ä¸ªå®¢æˆ·ï¼Œä¸åŒå‘˜å·¥å¯ä»¥æ‰“ä¸åŒçš„æ ‡ç­¾
- å³ä½¿æ˜¯ä¼ä¸šæ ‡ç­¾ï¼ˆtype=1ï¼‰ï¼Œæ¯ä¸ªå‘˜å·¥ä¹Ÿå¯ä»¥é€‰æ‹©æ€§åœ°ç»™å®¢æˆ·æ‰“æ ‡ç­¾
- æ ‡ç­¾å­˜å‚¨åœ¨å‘˜å·¥-å®¢æˆ·å…³ç³»è¡¨ï¼Œè€Œéå®¢æˆ·è¡¨

---

#### t_wecom_customer (å®¢æˆ·è¡¨)

**ç”¨é€”**: å­˜å‚¨å¤–éƒ¨å®¢æˆ·çš„ä¼ä¸šçº§ä¿¡æ¯ï¼ˆæ‰€æœ‰å‘˜å·¥çœ‹åˆ°çš„ä¸€æ ·ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| customer_id | bigint | å®¢æˆ·ID | ä¸»é”®,è‡ªå¢ |
| corp_id | varchar(64) | ä¼ä¸šID | |
| wecom_external_user_id | varchar(64) | ä¼å¾®å¤–éƒ¨è”ç³»äººUserID | ä¼å¾®APIè¿”å›çš„åŸå§‹ID |
| name | varchar(128) | å®¢æˆ·æ˜µç§° | |
| type | tinyint | å®¢æˆ·ç±»å‹ | 1-å¾®ä¿¡ç”¨æˆ· 2-ä¼å¾®ç”¨æˆ· |
| gender | tinyint | æ€§åˆ« | 0-æœªçŸ¥ 1-ç”· 2-å¥³ |
| avatar | varchar(500) | å¤´åƒURL | |
| corp_name | varchar(128) | å®¢æˆ·ä¼ä¸šåç§° | |
| corp_full_name | varchar(255) | å®¢æˆ·ä¼ä¸šå…¨ç§° | |
| description | varchar(500) | å®¢æˆ·æè¿° | |
| has_conversation_flag | tinyint | æ˜¯å¦æœ‰ä¼šè¯è®°å½• | 0-å¦ 1-æ˜¯ |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `customer_id`
- UNIQUE KEY: `uk_corp_external` (corp_id, wecom_external_user_id)
- KEY: `idx_name` (name)

---

#### t_wecom_group (ç¾¤èŠè¡¨)

**ç”¨é€”**: å­˜å‚¨ç¾¤èŠä¿¡æ¯

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| group_id | bigint | ç¾¤èŠID | ä¸»é”®,è‡ªå¢ |
| corp_id | varchar(64) | ä¼ä¸šID | |
| wecom_chat_id | varchar(64) | ä¼å¾®ç¾¤èŠChatID | ä¼å¾®APIè¿”å›çš„åŸå§‹ID |
| name | varchar(128) | ç¾¤åç§° | |
| wecom_owner_id | varchar(64) | ç¾¤ä¸»UserID | ä¼å¾®APIè¿”å›çš„åŸå§‹ID |
| group_create_time | datetime | ç¾¤åˆ›å»ºæ—¶é—´ | |
| notice | varchar(500) | ç¾¤å…¬å‘Š | |
| member_version | varchar(64) | ç¾¤æˆå‘˜ç‰ˆæœ¬å· | |
| total_member | int | æ€»æˆå‘˜æ•° | |
| staff_num | int | å‘˜å·¥æ•° | |
| customer_num | int | å®¢æˆ·æ•° | ç”¨äºåˆ¤æ–­å†…éƒ¨ç¾¤/å®¢æˆ·ç¾¤ |
| member_list | json | æˆå‘˜åˆ—è¡¨ | JSONæ•°ç»„ |
| admin_list | json | ç®¡ç†å‘˜åˆ—è¡¨ | JSONæ•°ç»„ |
| group_status | tinyint | ç¾¤çŠ¶æ€ | 0-å·²è§£æ•£ 1-æ­£å¸¸ |
| has_conversation_flag | tinyint | æ˜¯å¦æœ‰ä¼šè¯è®°å½• | 0-å¦ 1-æ˜¯ |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `group_id`
- UNIQUE KEY: `uk_corp_chat` (corp_id, wecom_chat_id)
- KEY: `idx_owner` (wecom_owner_id)
- KEY: `idx_name` (name)
- KEY: `idx_group_status` (group_status)

**ç¾¤ç±»å‹åˆ¤æ–­**:
- å†…éƒ¨ç¾¤: `customer_num = 0`
- å®¢æˆ·ç¾¤: `customer_num > 0`

---

### 5. è¾…åŠ©åŠŸèƒ½è¡¨

#### t_wecom_export_task (æ¶ˆæ¯å¯¼å‡ºä»»åŠ¡è¡¨)

**ç”¨é€”**: ç®¡ç†æ¶ˆæ¯å¯¼å‡ºä»»åŠ¡

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|------|------|------|------|
| task_id | bigint | ä»»åŠ¡ID | ä¸»é”®,è‡ªå¢ |
| corp_id | varchar(64) | ä¼ä¸šID | |
| task_name | varchar(255) | ä»»åŠ¡åç§° | |
| export_type | tinyint | å¯¼å‡ºç±»å‹ | 1-HTML 2-PDF 3-Excel 4-JSON |
| export_scope | tinyint | å¯¼å‡ºèŒƒå›´ | 1-å•ä¸ªä¼šè¯ 2-å¤šä¸ªä¼šè¯ 3-æŒ‰æ¡ä»¶ |
| filter_condition | json | ç­›é€‰æ¡ä»¶JSON | æ—¶é—´èŒƒå›´/å‚ä¸æ–¹/æ¶ˆæ¯ç±»å‹ç­‰ |
| task_status | tinyint | ä»»åŠ¡çŠ¶æ€ | 1-å¾…å¤„ç† 2-å¤„ç†ä¸­ 3-å·²å®Œæˆ 4-å¤±è´¥ |
| progress_percent | int | è¿›åº¦ç™¾åˆ†æ¯” | 0-100 |
| total_msg_count | int | æ€»æ¶ˆæ¯æ•° | |
| processed_msg_count | int | å·²å¤„ç†æ¶ˆæ¯æ•° | |
| file_path | varchar(500) | æ–‡ä»¶è·¯å¾„ | |
| file_url | varchar(500) | æ–‡ä»¶URL | |
| file_size | bigint | æ–‡ä»¶å¤§å° | å­—èŠ‚ |
| error_msg | varchar(500) | é”™è¯¯ä¿¡æ¯ | |
| expire_time | datetime | è¿‡æœŸæ—¶é—´ | |
| deleted_flag | tinyint | åˆ é™¤æ ‡è¯† | |
| create_user_id | bigint | åˆ›å»ºäººID | |
| create_time | datetime | åˆ›å»ºæ—¶é—´ | |
| update_time | datetime | æ›´æ–°æ—¶é—´ | |

**ç´¢å¼•**:
- PRIMARY KEY: `task_id`
- KEY: `idx_corp_status` (corp_id, task_status)
- KEY: `idx_create_user` (create_user_id)
- KEY: `idx_create_time` (create_time)

**filter_condition JSONç¤ºä¾‹**:

```json
{
  "time_range": {
    "start_time": "2025-01-01 00:00:00",
    "end_time": "2025-01-31 23:59:59"
  },
  "conversation_ids": [123, 456, 789],
  "participant_ids": ["UserID123", "UserID456"],
  "msg_types": ["text", "image", "file"],
  "include_media": true
}
```

---

## æ¶ˆæ¯ç±»å‹è®¾è®¡

### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

| msgtype | è¯´æ˜ | raw_contentå…³é”®å­—æ®µ | å±•ç¤ºæ–¹å¼ |
|---------|------|-------------------|---------|
| **text** | æ–‡æœ¬æ¶ˆæ¯ | text.content | ç›´æ¥æ˜¾ç¤º |
| **image** | å›¾ç‰‡æ¶ˆæ¯ | image.sdkfileid, image.md5sum, image.filesize | ç¼©ç•¥å›¾+ç‚¹å‡»æŸ¥çœ‹å¤§å›¾ |
| **voice** | è¯­éŸ³æ¶ˆæ¯ | voice.sdkfileid, voice.play_length | æ’­æ”¾æŒ‰é’®+æ—¶é•¿ |
| **video** | è§†é¢‘æ¶ˆæ¯ | video.sdkfileid, video.play_length | è§†é¢‘æ’­æ”¾å™¨ |
| **file** | æ–‡ä»¶æ¶ˆæ¯ | file.filename, file.fileext, file.sdkfileid, file.filesize | æ–‡ä»¶å›¾æ ‡+ä¸‹è½½ |
| **link** | é“¾æ¥æ¶ˆæ¯ | link.title, link.description, link.link_url, link.image_url | å¡ç‰‡æ ·å¼ |
| **weapp** | å°ç¨‹åºæ¶ˆæ¯ | weapp.title, weapp.description, weapp.username | å°ç¨‹åºå¡ç‰‡ |
| **card** | åç‰‡æ¶ˆæ¯ | card.corpname, card.userid | åç‰‡ä¿¡æ¯ |
| **location** | ä½ç½®æ¶ˆæ¯ | location.longitude, location.latitude, location.address | åœ°å›¾å±•ç¤º |
| **emotion** | è¡¨æƒ…æ¶ˆæ¯ | emotion.type, emotion.sdkfileid | è¡¨æƒ…å›¾ç‰‡ |
| **chatrecord** | ä¼šè¯è®°å½• | chatrecord.title, chatrecord.item[] | èŠå¤©è®°å½•å¼•ç”¨ |
| **todo** | å¾…åŠæ¶ˆæ¯ | todo.title, todo.content | å¾…åŠå¡ç‰‡ |
| **vote** | æŠ•ç¥¨æ¶ˆæ¯ | vote.votetitle, vote.voteitem[] | æŠ•ç¥¨å¡ç‰‡ |
| **collect** | å¡«è¡¨æ¶ˆæ¯ | collect.title, collect.details[] | è¡¨å•å¡ç‰‡ |
| **redpacket** | çº¢åŒ…æ¶ˆæ¯ | redpacket.type, redpacket.totalamount | çº¢åŒ…å¡ç‰‡ |
| **meeting** | ä¼šè®®é‚€è¯· | meeting.topic, meeting.starttime, meeting.address | ä¼šè®®å¡ç‰‡ |
| **docmsg** | åœ¨çº¿æ–‡æ¡£ | doc.title, doc.link_url | æ–‡æ¡£é“¾æ¥ |
| **markdown** | Markdown | info.content | Markdownæ¸²æŸ“ |
| **news** | å›¾æ–‡æ¶ˆæ¯ | info.item[] | å›¾æ–‡å¡ç‰‡ |
| **calendar** | æ—¥ç¨‹æ¶ˆæ¯ | calendar.title, calendar.starttime | æ—¥ç¨‹å¡ç‰‡ |
| **mixed** | æ··åˆæ¶ˆæ¯ | mixed.item[] | ç»„åˆå±•ç¤º |
| **voiptext** | éŸ³è§†é¢‘é€šè¯ | voiptext.voip_type, voiptext.call_duration | é€šè¯è®°å½• |
| **meeting_voice_call** | ä¼šè®®è¯­éŸ³å­˜æ¡£ | meeting_voice_call.voiceid, meeting_voice_call.sdkfileid | è¯­éŸ³æ’­æ”¾ |
| **sphfeed** | è§†é¢‘å·æ¶ˆæ¯ | sphfeed.feed_type, sphfeed.sph_name | è§†é¢‘å·å¡ç‰‡ |
| **revoke** | æ’¤å›é€šçŸ¥ | revoke.pre_msgid | "[å‘é€è€…]æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯" |

### æ¶ˆæ¯å¤„ç†æµç¨‹

```
1. æ¥æ”¶åŠ å¯†æ¶ˆæ¯
   â†“
2. è°ƒç”¨ wx-finance API /api/decrypt/full è§£å¯†
   â†“
3. è§£æ JSON,æå–é€šç”¨å­—æ®µ:
   - msgid, action, from, tolist, roomid, msgtime, msgtype
   â†“
4. æ ¹æ® msgtype æå–ç‰¹å®šå­—æ®µ:
   - text: æå– text.content â†’ msg_content
   - image/voice/video/file: æå– sdkfileid â†’ åˆ›å»º media_file è®°å½•
   - link/weapp/card: å®Œæ•´å­˜å‚¨åˆ° raw_content
   â†“
5. ä¿å­˜åˆ° t_wecom_message
   â†“
6. å¼‚æ­¥ä¸‹è½½åª’ä½“æ–‡ä»¶(å¦‚éœ€è¦)
```

---

## ç´¢å¼•ç­–ç•¥

### æ ¸å¿ƒç´¢å¼•

**t_wecom_conversation**:
```sql
-- ä¼šè¯å”¯ä¸€æ€§
UNIQUE KEY uk_conversation (corp_id, conversation_type, from_id, to_id, room_id)

-- æŒ‰ç±»å‹æŸ¥è¯¢
KEY idx_corp_type (corp_id, conversation_type)

-- æ—¶é—´æ’åº
KEY idx_last_msg_time (last_msg_time)

-- å‚ä¸æ–¹æŸ¥è¯¢
KEY idx_from (from_id)
KEY idx_to (to_id)
KEY idx_room (room_id)
```

**t_wecom_message**:
```sql
-- æ¶ˆæ¯å”¯ä¸€æ€§
UNIQUE KEY uk_msg_id (msg_id)

-- ä¼ä¸šæ¶ˆæ¯æŸ¥è¯¢
KEY idx_corp (corp_id)

-- åºå·æ’åº
KEY idx_seq (seq)

-- æ—¶é—´åˆ†åŒº
KEY idx_msg_time (msg_time)
```

### å…¨æ–‡ç´¢å¼•(å¯é€‰)

å¦‚éœ€æ”¯æŒæ¶ˆæ¯å†…å®¹æœç´¢:

```sql
-- MySQL 8.0 å…¨æ–‡ç´¢å¼•
ALTER TABLE t_wecom_message
ADD FULLTEXT INDEX ft_msg_content (msg_content) WITH PARSER ngram;

-- æŸ¥è¯¢ç¤ºä¾‹
SELECT * FROM t_wecom_message
WHERE MATCH(msg_content) AGAINST('å…³é”®è¯' IN NATURAL LANGUAGE MODE)
  AND msg_time >= DATE_SUB(NOW(), INTERVAL 30 DAY);
```

---

## æŸ¥è¯¢ä¼˜åŒ–

### å¸¸è§æŸ¥è¯¢ä¼˜åŒ–

#### 1. ä¼šè¯åˆ—è¡¨æŸ¥è¯¢

```sql
-- âœ… ä¼˜åŒ–:åˆ©ç”¨å…³ç³»è¡¨ç´¢å¼• + å†—ä½™å­—æ®µ
SELECT
    c.conversation_id,
    c.conversation_type,
    c.participant_count,
    c.customer_count,
    c.last_msg_sender_name,
    c.last_msg_content,
    c.last_msg_time
FROM t_wecom_conversation c
INNER JOIN t_wecom_conversation_participant p ON p.conversation_id = c.conversation_id
WHERE p.participant_id = 'sales001'
  AND c.corp_id = 'test_corp'
ORDER BY c.last_msg_time DESC
LIMIT 20;

-- âŒ é¿å…:æŸ¥è¯¢å‚ä¸æ–¹è¯¦æƒ…æ—¶ä¸å¿…è¦çš„JOIN
-- åº”åˆ©ç”¨ participant_name å†—ä½™å­—æ®µ,è€ŒéJOINå‘˜å·¥/å®¢æˆ·è¡¨
```

#### 2. æ¶ˆæ¯è¯¦æƒ…æŸ¥è¯¢

```sql
-- âœ… ä¼˜åŒ–:é€šè¿‡å…³è”è¡¨æŸ¥è¯¢ä¼šè¯æ¶ˆæ¯
SELECT
    m.message_id,
    m.msg_type,
    m.from_name,
    m.msg_time,
    m.msg_content,
    m.raw_content
FROM t_wecom_message m
INNER JOIN t_wecom_message_conversation mc ON m.message_id = mc.message_id
WHERE mc.conversation_id = ?
  AND m.msg_time >= ?  -- å¿…é¡»å¸¦æ—¶é—´æ¡ä»¶,åˆ©ç”¨åˆ†åŒº
  AND m.msg_time < ?
ORDER BY m.seq ASC
LIMIT 50 OFFSET ?;
```

#### 3. æŸäººçš„æ¶ˆæ¯æŸ¥è¯¢ï¼ˆæ¶ˆæ¯ä¼šè¯å…³è”è¡¨ï¼‰ â­æ¨è

```sql
-- âœ… æé€ŸæŸ¥è¯¢: åˆ©ç”¨å…³è”è¡¨å•è¡¨ç´¢å¼•æ‰«æ
SELECT m.*
FROM t_wecom_message m
INNER JOIN t_wecom_message_conversation mc ON m.message_id = mc.message_id
WHERE mc.to_id = 'rocky'
  AND m.msg_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY m.msg_time DESC
LIMIT 50;

-- âŒ ä¼ ç»Ÿæ–¹æ¡ˆ: éœ€è¦JOINå¤šå¼ è¡¨
SELECT m.*
FROM t_wecom_message m
JOIN t_wecom_conversation c ON mc.conversation_id = c.conversation_id
JOIN t_wecom_conversation_participant p ON c.conversation_id = p.conversation_id
WHERE p.participant_id = 'rocky'
ORDER BY m.msg_time DESC
LIMIT 50;
```

#### 4. åª’ä½“æ–‡ä»¶æŸ¥è¯¢

```sql
-- âœ… ä¼˜åŒ–:å…³è”æ–‡ä»¶å­˜å‚¨è¡¨
SELECT
  m.media_id,
  m.media_type,
  m.file_name,
  m.file_size,
  f.file_key AS file_url
FROM t_wecom_message_media m
LEFT JOIN t_file f ON m.file_id = f.file_id
WHERE m.message_id = ?
  AND m.download_status = 2;
```

### ç¼“å­˜ç­–ç•¥

| æ•°æ®ç±»å‹ | ç¼“å­˜é”® | TTL | å¤±æ•ˆç­–ç•¥ |
|---------|--------|-----|---------|
| ä¼šè¯åˆ—è¡¨ | `wecom:conv:list:{user_id}:p{page}` | 5åˆ†é’Ÿ | æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶æ¸…é™¤ |
| æ¶ˆæ¯è¯¦æƒ… | `wecom:msg:{conversation_id}:p{page}` | 10åˆ†é’Ÿ | æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶æ¸…é™¤ |
| å‘˜å·¥ä¿¡æ¯ | `wecom:staff:{user_id}` | 30åˆ†é’Ÿ | å‘˜å·¥ä¿¡æ¯æ›´æ–°æ—¶æ¸…é™¤ |
| å®¢æˆ·ä¿¡æ¯ | `wecom:customer:{external_userid}` | 30åˆ†é’Ÿ | å®¢æˆ·ä¿¡æ¯æ›´æ–°æ—¶æ¸…é™¤ |
| ç¾¤èŠä¿¡æ¯ | `wecom:group:{chat_id}` | 30åˆ†é’Ÿ | ç¾¤ä¿¡æ¯å˜æ›´æ—¶æ¸…é™¤ |
| åª’ä½“æ–‡ä»¶URL | `wecom:media:{sdk_file_id}` | 1å°æ—¶ | æ–‡ä»¶ä¸‹è½½å®Œæˆåè®¾ç½® |

---

## ä¸SmartAdminé›†æˆ

### èœå•é…ç½®

**èœå•IDåˆ†é…**: 430-439 (ä¼å¾®åŠ©æ‰‹åŠŸèƒ½æ®µ)

```
400 é¡µé¢åŸå‹ (å·²å­˜åœ¨)
â””â”€â”€ 430 ä¼å¾®åŠ©æ‰‹
    â”œâ”€â”€ 431 ä¼šè¯å­˜æ¡£
    â”‚   â”œâ”€â”€ 432 ä¼šè¯åˆ—è¡¨(åŠŸèƒ½ç‚¹)
    â”‚   â”œâ”€â”€ 433 æ¶ˆæ¯è¯¦æƒ…(åŠŸèƒ½ç‚¹)
    â”‚   â””â”€â”€ 434 æ¶ˆæ¯å¯¼å‡º(åŠŸèƒ½ç‚¹)
    â””â”€â”€ 435 é…ç½®ç®¡ç†
```

### æƒé™æ§åˆ¶

**æƒé™ç å®šä¹‰**:
- `wecom:chat:query` - æŸ¥çœ‹ä¼šè¯
- `wecom:chat:list` - ä¼šè¯åˆ—è¡¨
- `wecom:chat:detail` - æ¶ˆæ¯è¯¦æƒ…
- `wecom:chat:export` - æ¶ˆæ¯å¯¼å‡º
- `wecom:config:manage` - é…ç½®ç®¡ç†

**æƒé™æ£€æŸ¥**:
```java
@Operation(summary = "æŸ¥è¯¢ä¼šè¯åˆ—è¡¨")
@PostMapping("/wecom/conversation/list")
@SaCheckPermission("wecom:chat:list")
public ResponseDTO<PageResult<ConversationVO>> queryConversationList(
    @RequestBody @Valid ConversationQueryForm queryForm) {
    return conversationService.queryList(queryForm);
}
```

### ErrorCodeå®šä¹‰

```java
public enum WecomErrorCode implements ErrorCode {
    CONFIG_NOT_FOUND(50101, "ä¼ä¸šå¾®ä¿¡é…ç½®ä¸å­˜åœ¨"),
    CHAT_SECRET_INVALID(50102, "ä¼šè¯å­˜æ¡£å¯†é’¥æ— æ•ˆ"),
    MESSAGE_DECRYPT_FAILED(50103, "æ¶ˆæ¯è§£å¯†å¤±è´¥"),
    MEDIA_DOWNLOAD_FAILED(50104, "åª’ä½“æ–‡ä»¶ä¸‹è½½å¤±è´¥"),
    CONVERSATION_NOT_FOUND(50105, "ä¼šè¯ä¸å­˜åœ¨"),
    EXPORT_TASK_FAILED(50106, "å¯¼å‡ºä»»åŠ¡å¤±è´¥");
}
```

### æ•°æ®å­—å…¸

| å­—å…¸ç±»å‹ | è¯´æ˜ | æšä¸¾å€¼ |
|---------|------|--------|
| wecom_conversation_type | ä¼šè¯ç±»å‹ | 1-å•èŠ 2-ç¾¤èŠ |
| wecom_participant_type | å‚ä¸æ–¹ç±»å‹ | 1-å®¢æˆ· 2-å‘˜å·¥ 3-ç¾¤ |
| wecom_msg_action | æ¶ˆæ¯åŠ¨ä½œ | send-å‘é€ recall-æ’¤å› |
| wecom_export_type | å¯¼å‡ºæ ¼å¼ | 1-HTML 2-PDF 3-Excel 4-JSON |
| wecom_task_status | ä»»åŠ¡çŠ¶æ€ | 1-å¾…å¤„ç† 2-å¤„ç†ä¸­ 3-å·²å®Œæˆ 4-å¤±è´¥ |

---

## æ•°æ®åº“åˆ›å»ºè„šæœ¬ä½ç½®

**SQLè„šæœ¬è·¯å¾„**: `/æ•°æ®åº“SQLè„šæœ¬/mysql/sql-update-log/v3.30.0-wecom-chat-archive.sql`

**æ‰§è¡Œæ–¹å¼**:
```bash
# 1. æ‰§è¡Œä¸»è„šæœ¬(å¦‚æœæ˜¯å…¨æ–°éƒ¨ç½²)
docker exec -i smart-admin-mysql mysql -uroot -pSmartAdmin666 smart_admin_v3 \
  < æ•°æ®åº“SQLè„šæœ¬/mysql/smart_admin_v3.sql

# 2. æ‰§è¡Œå¢é‡è„šæœ¬
docker exec -i smart-admin-mysql mysql -uroot -pSmartAdmin666 smart_admin_v3 \
  < æ•°æ®åº“SQLè„šæœ¬/mysql/sql-update-log/v3.30.0-wecom-chat-archive.sql

# 3. éªŒè¯è¡¨åˆ›å»º
docker exec -it smart-admin-mysql mysql -uroot -pSmartAdmin666 smart_admin_v3 -e "
SHOW TABLES LIKE 't_wecom%';
"
```

---

## æ€»ç»“

### è®¾è®¡äº®ç‚¹

1. **æ¶ˆæ¯ä¼šè¯å…³è”è¡¨** â­â­â­: ç©ºé—´æ¢æ—¶é—´ï¼Œæé€ŸæŸ¥è¯¢æŸäººçš„æ¶ˆæ¯ï¼Œæ”¯æŒç¾¤å‘åœºæ™¯ï¼Œæ¶ˆæ¯ä¸ä¼šè¯å®Œå…¨è§£è€¦
2. **å…³ç³»è¡¨ç»Ÿä¸€è®¾è®¡**: é‡‡ç”¨å‚ä¸æ–¹å…³ç³»è¡¨,ç»Ÿä¸€å¤„ç†å•èŠå’Œç¾¤èŠ,æ˜“äºæ‰©å±•
3. **åˆ†åŒºè¡¨ä¼˜åŒ–**: æ¶ˆæ¯è¡¨æŒ‰æœˆåˆ†åŒº,æ”¯æŒå¤§æ•°æ®é‡é«˜æ•ˆæŸ¥è¯¢
4. **JSONçµæ´»å­˜å‚¨**: raw_contentå­˜å‚¨å®Œæ•´æ¶ˆæ¯,æ”¯æŒæœªæ¥æ‰©å±•
5. **æ™ºèƒ½å†—ä½™**: ä¼šè¯è¡¨å†—ä½™ç»Ÿè®¡å­—æ®µ(participant_countã€customer_count),å‡å°‘JOIN
6. **ç´¢å¼•å®Œå–„**: æ¶ˆæ¯ä¼šè¯å…³è”è¡¨idx_to_timeç´¢å¼•,è¦†ç›–é«˜é¢‘æŸ¥è¯¢åœºæ™¯
7. **åˆ†å±‚æ¸…æ™°**: é…ç½®/ä¼šè¯/å…³ç³»/æ¶ˆæ¯/æ¶ˆæ¯ä¼šè¯å…³è”/å‚ä¸æ–¹/è¾…åŠ©è¡¨èŒè´£æ˜ç¡®
8. **SmartAdminé›†æˆ**: éµå¾ªé¡¹ç›®è§„èŒƒ,æ— ç¼é›†æˆ

### æ ¸å¿ƒè¡¨å…³ç³»ï¼ˆ11å¼ ä¸šåŠ¡è¡¨ï¼‰

```
ã€æ¨¡å—1ï¼šä¼ä¸šé…ç½®ã€‘
t_wecom_corp_config (ä¼ä¸šé…ç½®) - ç‹¬ç«‹é…ç½®ï¼Œé€šè¿‡corp_idå…³è”å…¶ä»–è¡¨

ã€æ¨¡å—2ï¼šä¼šè¯ä¸å‚ä¸æ–¹ã€‘
t_wecom_conversation (ä¼šè¯ä¸»è¡¨)
        â†“ 1:N
t_wecom_conversation_participant (å‚ä¸æ–¹å…³ç³»è¡¨)
        â†“ N:1
        â”œâ”€ t_wecom_staff (å‘˜å·¥)
        â”œâ”€ t_wecom_customer (å®¢æˆ·)
        â””â”€ t_wecom_group (ç¾¤èŠ)

ã€æ¨¡å—3ï¼šæ¶ˆæ¯ä¸å…³è”ã€‘â­æ ¸å¿ƒ
t_wecom_message (æ¶ˆæ¯ä¸»è¡¨-åˆ†åŒºè¡¨) - çº¯ç²¹çš„æ¶ˆæ¯å†…å®¹
        â†“ 1:N                         â†“ 1:N
t_wecom_message_media            t_wecom_message_conversation â­â­â­æ¶ˆæ¯ä¼šè¯å…³è”è¡¨
   (åª’ä½“æ–‡ä»¶ä¸šåŠ¡è¡¨)                       â†“ N:1
        â†“ N:1                   t_wecom_conversation (ä¼šè¯ä¸»è¡¨)
t_file (SmartAdminæ–‡ä»¶å­˜å‚¨)

ã€æ¨¡å—4ï¼šå‘˜å·¥-å®¢æˆ·å…³ç³»ã€‘
t_wecom_staff (å‘˜å·¥) â†â”€ N:N â”€â†’ t_wecom_staff_customer_relation â†â”€ N:N â”€â†’ t_wecom_customer (å®¢æˆ·)

ã€æ¨¡å—5ï¼šè¾…åŠ©åŠŸèƒ½ã€‘
t_wecom_export_task (å¯¼å‡ºä»»åŠ¡)
```

**11å¼ ä¸šåŠ¡è¡¨æ¸…å•**:
1. t_wecom_corp_config - ä¼ä¸šé…ç½®è¡¨
2. t_wecom_conversation - ä¼šè¯ä¸»è¡¨
3. t_wecom_conversation_participant - å‚ä¸æ–¹å…³ç³»è¡¨
4. t_wecom_message - æ¶ˆæ¯ä¸»è¡¨(åˆ†åŒºè¡¨)
5. t_wecom_message_conversation â­â­â­ - æ¶ˆæ¯ä¼šè¯å…³è”è¡¨ï¼ˆæ–°å¢ï¼Œæ¶ˆæ¯ä¸ä¼šè¯è§£è€¦ï¼‰
6. t_wecom_message_media - åª’ä½“æ–‡ä»¶ä¸šåŠ¡è¡¨
7. t_wecom_staff - å‘˜å·¥è¡¨
8. t_wecom_staff_customer_relation - å‘˜å·¥-å®¢æˆ·å…³ç³»è¡¨
9. t_wecom_customer - å®¢æˆ·è¡¨
10. t_wecom_group - ç¾¤èŠè¡¨
11. t_wecom_export_task - å¯¼å‡ºä»»åŠ¡è¡¨

**å…³é”®è®¾è®¡å†³ç­–**:

1. **æ¶ˆæ¯ä¼šè¯å…³è”è¡¨** (t_wecom_message_conversation):
   - **æ¶ˆæ¯è§£è€¦**: æ¶ˆæ¯è¡¨ä¸å†å­˜å‚¨conversation_idï¼Œä¸“æ³¨äºæ¶ˆæ¯å†…å®¹æœ¬èº«
   - **çµæ´»å…³è”**: ä¸€æ¡æ¶ˆæ¯å¯ä»¥å…³è”å¤šä¸ªä¼šè¯ï¼ˆç¾¤å‘åœºæ™¯ï¼‰
   - ä¼ä¸šå¾®ä¿¡APIä¸æä¾›ä¼šè¯IDï¼Œéœ€è‡ªè¡Œç»´æŠ¤from/tolist/roomidå…³ç³»
   - ç©ºé—´æ¢æ—¶é—´ï¼šå†—ä½™å…³è”å…³ç³»ï¼Œå®ç°å•è¡¨ç´¢å¼•æŸ¥è¯¢
   - æ”¯æŒç¾¤å‘ï¼šä¸€æ¡æ¶ˆæ¯å¯ç”Ÿæˆå¤šæ¡å…³è”è®°å½•
   - æŸ¥è¯¢æ€§èƒ½ï¼šé¿å…3è¡¨JOINï¼Œç›´æ¥ç´¢å¼•æ‰«æ

2. **ä¼šè¯ç®¡ç†**:
   - å•èŠ: 1ä¸ªä¼šè¯ + 2æ¡å‚ä¸æ–¹è®°å½• + Næ¡æ¶ˆæ¯å…³è”è®°å½•
   - ç¾¤èŠ: 1ä¸ªä¼šè¯ + Næ¡å‚ä¸æ–¹è®°å½• + 1æ¡æ¶ˆæ¯å…³è”è®°å½•
   - æŸ¥è¯¢æŸäººçš„ä¼šè¯: é€šè¿‡ `t_wecom_message_conversation.to_id` ç´¢å¼•

3. **å‘˜å·¥-å®¢æˆ·å…³ç³»**:
   - ä¸€ä¸ªå®¢æˆ·å¯è¢«å¤šä¸ªå‘˜å·¥æ·»åŠ ï¼ˆN:Nå…³ç³»ï¼‰
   - æ¯ä¸ªå‘˜å·¥å¯¹åŒä¸€å®¢æˆ·æœ‰ç‹¬ç«‹çš„å¤‡æ³¨ã€æ ‡ç­¾ã€æ·»åŠ æ–¹å¼
   - é€šè¿‡ `wecom_staff_user_id` + `wecom_external_user_id` å”¯ä¸€æ ‡è¯†

4. **åª’ä½“æ–‡ä»¶**:
   - åŒè¡¨è®¾è®¡ï¼št_wecom_message_mediaï¼ˆä¸šåŠ¡ï¼‰+ t_fileï¼ˆå­˜å‚¨ï¼‰
   - æ”¯æŒç¼©ç•¥å›¾ï¼šå›¾ç‰‡/è§†é¢‘æœ‰ç‹¬ç«‹çš„thumbnail_file_id

### ä¸‹ä¸€æ­¥å·¥ä½œ

1. âœ… æ•°æ®åº“è®¾è®¡æ–‡æ¡£å®Œæˆ
2. â³ åˆ›å»ºSQLè„šæœ¬æ–‡ä»¶
3. â³ ç¼–å†™Entity/Form/VOç±»
4. â³ å®ç°Serviceä¸šåŠ¡é€»è¾‘
5. â³ å¼€å‘Controlleræ¥å£
6. â³ å‰ç«¯é¡µé¢å¼€å‘

---

## ğŸ“ å˜æ›´æ—¥å¿—

### v2.3 (2025-10-08) - æ¶ˆæ¯ä¼šè¯è§£è€¦æ¶æ„ â­â­â­

**æ ¸å¿ƒä¼˜åŒ–**:
1. âœ… æ–°å¢ `t_wecom_message_conversation` æ¶ˆæ¯ä¼šè¯å…³è”è¡¨
   - **æ¶æ„ä¼˜åŒ–**: æ¶ˆæ¯è¡¨ç§»é™¤conversation_idï¼Œå®ç°æ¶ˆæ¯ä¸ä¼šè¯å®Œå…¨è§£è€¦
   - **è¯­ä¹‰æ¸…æ™°**: ä»"è·¯ç”±åŠ é€Ÿè¡¨"æ”¹åä¸º"æ¶ˆæ¯ä¼šè¯å…³è”è¡¨"ï¼Œæ›´å‡†ç¡®è¡¨è¾¾ä¸šåŠ¡æ„å›¾
   - **çµæ´»å…³è”**: ä¸€æ¡æ¶ˆæ¯å¯ä»¥å…³è”å¤šä¸ªä¼šè¯ï¼ˆç¾¤å‘åœºæ™¯ï¼‰
   - **æŸ¥è¯¢ä¼˜åŒ–**: ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ï¼Œæé€ŸæŸ¥è¯¢æŸäººçš„æ¶ˆæ¯
   - å•è¡¨ç´¢å¼•æ‰«æï¼Œé¿å…å¤æ‚JOIN
   - æ ¸å¿ƒç´¢å¼•ï¼šidx_to_time (to_id, create_time)
   - å†—ä½™å­—æ®µto_id: åŠ é€Ÿ"æŸ¥è¯¢æŸäººæ”¶åˆ°çš„æ¶ˆæ¯"åœºæ™¯

2. âœ… æ¶ˆæ¯è¡¨æ¶æ„è°ƒæ•´
   - ç§»é™¤ `conversation_id` å­—æ®µï¼Œæ¶ˆæ¯è¡¨ä¸“æ³¨äºæ¶ˆæ¯å†…å®¹æœ¬èº«
   - æ›´æ–°ç´¢å¼•ï¼šidx_corp_conv æ”¹ä¸º idx_corp
   - æ¶ˆæ¯ä¸ä¼šè¯çš„å…³è”å…³ç³»å®Œå…¨ç”±å…³è”è¡¨ç»´æŠ¤

3. âœ… ä¼˜åŒ–ERå›¾å±•ç¤º
   - æ‹†åˆ†ä¸º5ä¸ªæ¨¡å—ï¼šä¼ä¸šé…ç½®ã€ä¼šè¯ä¸å‚ä¸æ–¹ã€æ¶ˆæ¯ä¸å…³è”ã€å‘˜å·¥-å®¢æˆ·å…³ç³»ã€è¾…åŠ©åŠŸèƒ½
   - ä¼ä¸šé…ç½®ç‹¬ç«‹å±•ç¤ºï¼Œä¸ä¸å…¶ä»–è¡¨äº§ç”Ÿå…³è”æ··æ·†
   - æ¸…æ™°å±•ç¤ºæ¶ˆæ¯ä¸ä¼šè¯çš„è§£è€¦å…³ç³»
   - æ·»åŠ ä¸¤ä¸ªå…³è”è¡¨çš„å¯¹æ¯”è¯´æ˜

4. âœ… æ›´æ–°æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
   - æ¨èä½¿ç”¨æ¶ˆæ¯ä¼šè¯å…³è”è¡¨è¿›è¡Œæ¶ˆæ¯æŸ¥è¯¢
   - æ€§èƒ½å¯¹æ¯”ï¼šå…³è”è¡¨ vs ä¼ ç»ŸJOINæ–¹æ¡ˆ

**è®¾è®¡èƒŒæ™¯**:
- ä¼ä¸šå¾®ä¿¡APIä¸ç›´æ¥æä¾›ä¼šè¯IDï¼Œéœ€è¦æ ¹æ®from/tolist/roomidåˆ¤æ–­å½’å±
- ä¼ ç»Ÿæ–¹æ¡ˆéœ€è¦JOIN 3å¼ è¡¨ï¼ˆæ¶ˆæ¯è¡¨ã€ä¼šè¯è¡¨ã€å‚ä¸æ–¹å…³ç³»è¡¨ï¼‰ï¼Œæ€§èƒ½è¾ƒå·®
- æ¶ˆæ¯ä¼šè¯å…³è”è¡¨é€šè¿‡å†—ä½™å…³è”å…³ç³»ï¼Œå®ç°å•è¡¨ç´¢å¼•æŸ¥è¯¢ï¼Œå¤§å¹…æå‡æ€§èƒ½
- æ¶ˆæ¯ä¸ä¼šè¯è§£è€¦ï¼Œä½¿æ¶ˆæ¯è¡¨æ›´åŠ çº¯ç²¹ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

**æ•°æ®ç¤ºä¾‹**:
- ç¾¤èŠæ¶ˆæ¯: 1æ¡å…³è”è®°å½• (to_id = roomid)
- å•èŠæ¶ˆæ¯: 1æ¡å…³è”è®°å½• (to_id = æ¥æ”¶æ–¹UserID)
- ç¾¤å‘æ¶ˆæ¯: Næ¡å…³è”è®°å½• (æ¯ä¸ªæ¥æ”¶è€…ä¸€æ¡)

**ç©ºé—´æˆæœ¬**:
- 1000ä¸‡æ¡æ¶ˆæ¯ Ã— 1.5æ¡å…³è”/æ¶ˆæ¯ = 1500ä¸‡æ¡å…³è”è®°å½•
- å­˜å‚¨ç©ºé—´çº¦1.5GBï¼Œæˆæœ¬å®Œå…¨å¯æ¥å—

---

### v2.2 (2025-10-08) - æ¶ˆæ¯è·¯ç”±åŠ é€Ÿè¡¨ â­

**æ ¸å¿ƒä¼˜åŒ–**:
1. âœ… åˆæ­¥è®¾è®¡æ¶ˆæ¯è·¯ç”±åŠ é€Ÿè¡¨
   - ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ï¼ŒåŠ é€ŸæŸ¥è¯¢æ€§èƒ½
   - æ”¯æŒç¾¤å‘åœºæ™¯ï¼ˆä¸€æ¡æ¶ˆæ¯ç”Ÿæˆå¤šæ¡è·¯ç”±è®°å½•ï¼‰
   - å•è¡¨ç´¢å¼•æ‰«æï¼Œé¿å…å¤æ‚JOIN

**è®¾è®¡é—®é¢˜**:
- è¡¨åè¯­ä¹‰ä¸å¤Ÿæ¸…æ™°ï¼š"è·¯ç”±åŠ é€Ÿè¡¨"ä¸èƒ½å‡†ç¡®è¡¨è¾¾ä¸šåŠ¡æ„å›¾
- æ¶ˆæ¯è¡¨ä»ç„¶ä¿ç•™conversation_idå­—æ®µï¼Œå­˜åœ¨å†—ä½™å’Œè€¦åˆ

**åç»­ä¼˜åŒ–**:
- v2.3 é‡æ„ä¸ºæ¶ˆæ¯ä¼šè¯å…³è”è¡¨ï¼Œå®ç°æ¶ˆæ¯ä¸ä¼šè¯å®Œå…¨è§£è€¦

---

### v2.1 (2025-10-08) - è§„èŒƒåŒ–è°ƒæ•´

**SmartAdminè§„èŒƒå¯¹é½**:
1. âœ… ä¼å¾®åŸå§‹IDå­—æ®µç»Ÿä¸€ `wecom_` å‰ç¼€ + æ¸…æ™°å‘½å:
   - `user_id` â†’ `wecom_user_id`
   - `external_userid` â†’ `wecom_external_user_id` (useridæ‹†åˆ†ä¸ºuser_id)
   - `chat_id` â†’ `wecom_chat_id`
   - `owner` â†’ `wecom_owner_id`

2. âœ… æ ‡å¿—å­—æ®µç»Ÿä¸€ `_flag` åç¼€:
   - `has_conversation` â†’ `has_conversation_flag`
   - `enable_chat_archive` â†’ `enable_chat_archive_flag`

3. âœ… æ—¶é—´å­—æ®µè¯­ä¹‰åŒ–:
   - `join_time` â†’ `relation_start_time` (ç¾¤èŠ=å…¥ç¾¤æ—¶é—´, å•èŠ=åŠ å¥½å‹æ—¶é—´)
   - `leave_time` â†’ `relation_end_time` (ç¾¤èŠ=é€€ç¾¤æ—¶é—´, å•èŠ=åˆ å¥½å‹æ—¶é—´)

4. âœ… åˆ é™¤ä¸å¿…è¦å­—æ®µ:
   - æ”¶è—åŠŸèƒ½: `is_favorite`, `favorite_reason`, `favorite_time`
   - åŠ å¯†æ ‡è¯†: `is_encrypted` (æ•°æ®åº“å­˜å‚¨å·²è§£å¯†æ•°æ®)
   - å†—ä½™å­—æ®µ: `staff_userid` (é€šè¿‡å…³ç³»è¡¨æŸ¥è¯¢)

5. âœ… æ–°å¢å‘˜å·¥-å®¢æˆ·å…³ç³»è¡¨:
   - åˆ›å»º `t_wecom_staff_customer_relation` è¡¨
   - å­˜å‚¨å‘˜å·¥çº§å­—æ®µ: `staff_remark`, `add_way`, `add_time`, `tags`, `description` ç­‰
   - æ”¯æŒä¸€å¯¹å¤šå…³ç³»ï¼ˆä¸€ä¸ªå®¢æˆ·å¯è¢«å¤šä¸ªå‘˜å·¥æ·»åŠ ï¼‰

**è®¾è®¡æ”¹è¿›**:
- éµå¾ªSmartAdminæ ‡å‡†å­—æ®µå‘½åè§„èŒƒ
- æ‰€æœ‰è¡¨åŒ…å«æ ‡å‡†å­—æ®µ: `deleted_flag`, `create_time`, `update_time`
- å­—ç¬¦é›†ç»Ÿä¸€: `utf8mb4` + `utf8mb4_general_ci`
- å¼•æ“ç»Ÿä¸€: `InnoDB` + `ROW_FORMAT=DYNAMIC`

---

### v2.0 (2025-10-08) - æ¶æ„é‡æ„

**æ ¸å¿ƒè®¾è®¡å˜æ›´**:
- æ–°å¢ `t_wecom_conversation_participant` å…³ç³»è¡¨
- ç»Ÿä¸€å¤„ç†å•èŠå’Œç¾¤èŠçš„å‚ä¸æ–¹å…³ç³»
- ä¼šè¯è¡¨ç®€åŒ–,é€šè¿‡å…³ç³»è¡¨å…³è”å‚ä¸æ–¹
- æ€§èƒ½ä¼˜åŒ–: å†—ä½™å­—æ®µ + è¦†ç›–ç´¢å¼•

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.3
**æœ€åæ›´æ–°**: 2025-10-08
**ç»´æŠ¤äºº**: wangxiao