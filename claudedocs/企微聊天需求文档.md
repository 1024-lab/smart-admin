---
title: 企业微信会话存档功能需求文档
author: wangxiao
company: 子午线高科智能科技
date: 2025-10-08
version: v1.0
permalink: claudedocs/企微聊天需求文档
---

# 企业微信会话存档功能需求文档

## 📋 文档概述

### 项目背景

为了满足企业合规要求和客户关系管理需求，需要开发企业微信会话存档功能，实现对员工与客户、员工与员工之间的聊天记录进行完整存档、检索和展示。

### 功能目标

- ✅ 接入企业微信会话存档API，实时拉取聊天消息
- ✅ 支持20+种消息类型的解析和展示（文本/图片/语音/视频/文件等）
- ✅ 支持单聊和群聊会话管理
- ✅ 支持会话搜索、筛选、导出功能
- ✅ 支持媒体文件自动下载和存储
- ✅ 支持员工-客户关系管理

### 技术架构

- **后端框架**: Java 17 + Spring Boot 3 + MyBatis-Plus
- **数据库**: MySQL 8.0 (分区表 + JSON字段)
- **前端框架**: Vue 3 + TypeScript + Element Plus
- **外部依赖**: WxJava SDK + wx-finance HTTP服务

---

## 🎯 功能模块

### 模块1：企业配置管理

**功能描述**: 管理企业微信接入配置，包括企业ID、密钥、拉取状态等

**核心功能**:
- 企业配置的增删改查
- 会话存档密钥配置
- 消息拉取游标管理
- 配置状态监控

**涉及表**:
- `t_wecom_corp_config` (企业配置表)

---

### 模块2：会话管理

**功能描述**: 管理单聊和群聊会话，展示会话列表和会话详情

**核心功能**:
- 会话列表展示（支持分页、筛选）
- 会话详情查看
- 会话参与方管理
- 会话统计信息（消息数、参与方数）
- 会话搜索（按参与方、时间范围）

**涉及表**:
- `t_wecom_conversation` (会话主表)
- `t_wecom_conversation_participant` (参与方关系表)
- `t_wecom_staff` (员工表)
- `t_wecom_customer` (客户表)
- `t_wecom_group` (群聊表)

---

### 模块3：消息管理 ⭐核心

**功能描述**: 消息的拉取、解析、存储、展示和搜索

**核心功能**:
- 消息实时拉取（定时任务）
- 消息解密和解析
- 消息列表展示（支持分页、时间范围）
- 消息内容渲染（20+种消息类型）
- 消息搜索（全文搜索）
- 媒体文件下载和预览

**涉及表**:
- `t_wecom_message` (消息主表-分区表)
- `t_wecom_message_conversation` (消息会话关联表) ⭐
- `t_wecom_message_media` (媒体文件表)
- `t_file` (SmartAdmin文件存储)

**消息类型支持**:
- 文本、图片、语音、视频、文件
- 链接、小程序、名片、位置
- 表情、撤回通知、音视频通话
- 会议语音、视频号消息等

---

### 模块4：员工客户管理

**功能描述**: 管理员工信息、客户信息和员工-客户关系

**核心功能**:
- 员工信息同步和管理
- 客户信息同步和管理
- 员工-客户关系维护
- 客户备注、标签管理
- 添加方式和添加时间记录

**涉及表**:
- `t_wecom_staff` (员工表)
- `t_wecom_customer` (客户表)
- `t_wecom_staff_customer_relation` (员工-客户关系表)
- `t_wecom_group` (群聊表)

---

### 模块5：消息导出

**功能描述**: 支持将会话消息导出为多种格式

**核心功能**:
- 导出任务创建
- 支持多种导出格式（HTML/PDF/Excel/JSON）
- 导出进度监控
- 导出文件下载
- 异步任务处理

**涉及表**:
- `t_wecom_export_task` (导出任务表)

---

## 📝 开发任务拆分

### 阶段1：数据库与基础架构

#### 任务1.1：数据库创建
- [ ] 编写数据库SQL脚本（11张业务表）
- [ ] 创建增量脚本文件：`v3.30.0-wecom-chat-archive.sql`
- [ ] 执行SQL脚本并验证表结构
- [ ] 创建必要的索引和分区

**交付物**: 可执行的SQL脚本文件

---

#### 任务1.2：Entity实体类创建
- [ ] `WecomCorpConfigEntity` - 企业配置
- [ ] `WecomConversationEntity` - 会话
- [ ] `WecomConversationParticipantEntity` - 参与方关系
- [ ] `WecomMessageEntity` - 消息（核心）
- [ ] `WecomMessageConversationEntity` - 消息会话关联（核心）
- [ ] `WecomMessageMediaEntity` - 媒体文件
- [ ] `WecomStaffEntity` - 员工
- [ ] `WecomCustomerEntity` - 客户
- [ ] `WecomGroupEntity` - 群聊
- [ ] `WecomStaffCustomerRelationEntity` - 员工客户关系
- [ ] `WecomExportTaskEntity` - 导出任务

**技术要点**:
- 继承 `BaseEntity`
- 使用 `@TableName` 指定表名
- 使用 `@TableId(type = IdType.AUTO)` 主键自增
- 使用 `@TableField` 映射JSON字段

**交付物**: 11个Entity类文件

---

#### 任务1.3：Dao接口和Mapper XML创建
- [ ] `WecomCorpConfigDao` + XML
- [ ] `WecomConversationDao` + XML（核心查询）
- [ ] `WecomConversationParticipantDao` + XML
- [ ] `WecomMessageDao` + XML（分页查询、时间范围查询）
- [ ] `WecomMessageConversationDao` + XML（核心关联查询）
- [ ] `WecomMessageMediaDao` + XML
- [ ] `WecomStaffDao` + XML
- [ ] `WecomCustomerDao` + XML
- [ ] `WecomGroupDao` + XML
- [ ] `WecomStaffCustomerRelationDao` + XML
- [ ] `WecomExportTaskDao` + XML

**技术要点**:
- 继承 `BaseMapper<Entity>`
- Mapper XML中使用 `SmartPageUtil` 分页
- 核心查询SQL需要优化索引使用

**交付物**: 11个Dao接口 + 11个Mapper XML文件

---

### 阶段2：企业配置模块

#### 任务2.1：企业配置CRUD
- [ ] `WecomCorpConfigAddForm` - 新增表单
- [ ] `WecomCorpConfigUpdateForm` - 更新表单
- [ ] `WecomCorpConfigQueryForm` - 查询表单
- [ ] `WecomCorpConfigVO` - 视图对象
- [ ] `WecomCorpConfigService` - 业务逻辑
- [ ] `WecomCorpConfigController` - 接口

**核心接口**:
- `POST /wecom/config/add` - 新增配置
- `POST /wecom/config/update` - 更新配置
- `POST /wecom/config/query` - 查询列表
- `GET /wecom/config/detail/{id}` - 配置详情
- `GET /wecom/config/delete/{id}` - 删除配置

**交付物**: 完整的配置管理功能

---

### 阶段3：消息拉取与解析 ⭐核心

#### 任务3.1：消息拉取定时任务
- [ ] 集成 `wx-finance` HTTP服务
- [ ] 实现消息拉取定时任务（Scheduled）
- [ ] 消息解密逻辑
- [ ] 断点续传（基于chat_seq）
- [ ] 异常处理和重试机制

**技术要点**:
```java
@Scheduled(fixedDelay = 5000) // 每5秒拉取一次
public void pullMessages() {
    // 1. 获取所有企业配置
    // 2. 遍历拉取消息
    // 3. 调用wx-finance API解密
    // 4. 保存到数据库
    // 5. 更新chat_seq游标
}
```

**交付物**: 消息拉取定时任务

---

#### 任务3.2：消息解析与存储
- [ ] 解析企业微信消息JSON
- [ ] 提取通用字段（msgid、from、tolist、roomid、msgtime）
- [ ] 按消息类型提取特定字段
- [ ] 保存到 `t_wecom_message` 表
- [ ] 创建消息会话关联记录（核心逻辑）

**消息会话关联逻辑** ⭐:
```java
// 群聊消息
if (roomid != null) {
    Conversation conv = findOrCreateGroupConversation(roomid);
    createMessageConversation(msgId, conv.getId(), roomid);
}
// 单聊或群发
else {
    for (String toUserId : tolist) {
        Conversation conv = findOrCreatePrivateConversation(from, toUserId);
        createMessageConversation(msgId, conv.getId(), toUserId);
    }
}
```

**交付物**: 消息解析和存储服务

---

#### 任务3.3：媒体文件下载
- [ ] 识别媒体类型消息（image/voice/video/file）
- [ ] 异步下载任务
- [ ] 调用企业微信SDK下载媒体文件
- [ ] 保存到SmartAdmin文件存储
- [ ] 更新 `t_wecom_message_media` 表

**技术要点**:
- 使用线程池异步下载
- 支持失败重试
- 记录下载状态

**交付物**: 媒体文件下载服务

---

### 阶段4：会话管理模块

#### 任务4.1：会话列表查询
- [ ] `WecomConversationQueryForm` - 查询表单
- [ ] `WecomConversationVO` - 会话视图对象
- [ ] `WecomConversationService.queryList()` - 查询服务
- [ ] `WecomConversationController.queryList()` - 查询接口

**查询条件**:
- 会话类型（单聊/群聊）
- 参与方ID
- 时间范围
- 分页

**SQL优化**:
```sql
-- 利用参与方关系表索引
SELECT c.*
FROM t_wecom_conversation c
INNER JOIN t_wecom_conversation_participant p ON c.conversation_id = p.conversation_id
WHERE p.participant_id = ?
ORDER BY c.last_msg_time DESC
```

**交付物**: 会话列表查询功能

---

#### 任务4.2：会话详情展示
- [ ] 会话基本信息
- [ ] 会话参与方列表
- [ ] 会话统计信息（消息数、客户数）

**交付物**: 会话详情查询接口

---

### 阶段5：消息管理模块 ⭐核心

#### 任务5.1：消息列表查询
- [ ] `WecomMessageQueryForm` - 查询表单
- [ ] `WecomMessageVO` - 消息视图对象
- [ ] `WecomMessageService.queryByConversation()` - 按会话查询
- [ ] `WecomMessageService.queryByUser()` - 按用户查询
- [ ] `WecomMessageController` - 消息接口

**核心查询场景** ⭐:

**场景1: 查询某会话的消息**
```sql
SELECT m.*
FROM t_wecom_message m
INNER JOIN t_wecom_message_conversation mc ON m.message_id = mc.message_id
WHERE mc.conversation_id = ?
  AND m.msg_time >= ?
ORDER BY m.seq ASC
```

**场景2: 查询某人收到的所有消息**（极速查询）
```sql
SELECT m.*
FROM t_wecom_message m
INNER JOIN t_wecom_message_conversation mc ON m.message_id = mc.message_id
WHERE mc.to_id = ?
  AND m.msg_time >= ?
ORDER BY m.msg_time DESC
```

**交付物**: 消息查询功能

---

#### 任务5.2：消息类型渲染
- [ ] 文本消息渲染
- [ ] 图片消息渲染（含缩略图）
- [ ] 语音消息渲染（含播放器）
- [ ] 视频消息渲染（含播放器）
- [ ] 文件消息渲染（含下载链接）
- [ ] 链接/小程序/名片消息渲染
- [ ] 撤回消息提示

**技术要点**:
- 根据 `msg_type` 渲染不同组件
- 媒体文件需要通过 `t_wecom_message_media` 表关联
- 使用 `t_file.file_key` 生成访问URL

**交付物**: 消息类型渲染组件

---

#### 任务5.3：消息搜索
- [ ] 全文搜索（基于msg_content）
- [ ] 按时间范围搜索
- [ ] 按发送者搜索
- [ ] 按消息类型搜索

**技术要点**:
```sql
-- MySQL全文索引
ALTER TABLE t_wecom_message
ADD FULLTEXT INDEX ft_msg_content (msg_content) WITH PARSER ngram;

-- 搜索SQL
SELECT * FROM t_wecom_message
WHERE MATCH(msg_content) AGAINST('关键词' IN NATURAL LANGUAGE MODE)
  AND msg_time >= ?
```

**交付物**: 消息搜索功能

---

### 阶段6：员工客户管理

#### 任务6.1：员工信息同步
- [ ] 调用企业微信API同步员工信息
- [ ] 保存/更新员工信息到 `t_wecom_staff`
- [ ] 定时同步任务

**交付物**: 员工信息同步服务

---

#### 任务6.2：客户信息同步
- [ ] 调用企业微信API同步外部联系人
- [ ] 保存/更新客户信息到 `t_wecom_customer`
- [ ] 维护员工-客户关系表 `t_wecom_staff_customer_relation`
- [ ] 定时同步任务

**交付物**: 客户信息同步服务

---

#### 任务6.3：群聊信息同步
- [ ] 调用企业微信API同步群聊信息
- [ ] 保存/更新群聊信息到 `t_wecom_group`
- [ ] 定时同步任务

**交付物**: 群聊信息同步服务

---

### 阶段7：消息导出功能

#### 任务7.1：导出任务管理
- [ ] `WecomExportTaskAddForm` - 导出任务创建表单
- [ ] `WecomExportTaskVO` - 导出任务视图对象
- [ ] `WecomExportTaskService` - 导出服务
- [ ] `WecomExportTaskController` - 导出接口

**核心接口**:
- `POST /wecom/export/create` - 创建导出任务
- `GET /wecom/export/progress/{taskId}` - 查询导出进度
- `GET /wecom/export/download/{taskId}` - 下载导出文件
- `POST /wecom/export/list` - 导出任务列表

**交付物**: 导出任务管理功能

---

#### 任务7.2：导出格式实现
- [ ] HTML格式导出（聊天记录样式）
- [ ] PDF格式导出（基于HTML转换）
- [ ] Excel格式导出（表格形式）
- [ ] JSON格式导出（原始数据）

**技术要点**:
- 使用异步任务处理导出
- 支持大量数据分批导出
- 导出文件保存到 `t_file` 表

**交付物**: 4种导出格式实现

---

### 阶段8：前端开发

#### 任务8.1：企业配置管理页面
- [ ] 配置列表页
- [ ] 配置新增/编辑表单
- [ ] 配置详情页

**路由**: `/prototype/wecom/config`

**交付物**: 企业配置管理页面

---

#### 任务8.2：会话列表页面
- [ ] 会话列表展示（卡片式）
- [ ] 会话筛选（类型、时间范围）
- [ ] 会话搜索
- [ ] 会话统计信息展示

**路由**: `/prototype/wecom/conversation/list`

**交付物**: 会话列表页面

---

#### 任务8.3：会话详情页面 ⭐核心
- [ ] 消息列表展示（时间线）
- [ ] 多种消息类型渲染组件
- [ ] 消息分页加载（虚拟滚动）
- [ ] 媒体文件预览
- [ ] 消息搜索
- [ ] 会话信息侧边栏（参与方列表）

**路由**: `/prototype/wecom/conversation/detail/:id`

**技术要点**:
- 使用虚拟滚动优化大量消息展示
- 图片/视频预览组件
- 文件下载功能

**交付物**: 会话详情页面（核心页面）

---

#### 任务8.4：员工客户管理页面
- [ ] 员工列表页
- [ ] 客户列表页
- [ ] 客户详情页（包含所属员工）
- [ ] 群聊列表页

**路由**:
- `/prototype/wecom/staff/list`
- `/prototype/wecom/customer/list`
- `/prototype/wecom/group/list`

**交付物**: 员工客户管理页面

---

#### 任务8.5：消息导出页面
- [ ] 导出任务创建表单
- [ ] 导出任务列表
- [ ] 导出进度展示
- [ ] 导出文件下载

**路由**: `/prototype/wecom/export`

**交付物**: 消息导出页面

---

### 阶段9：菜单配置与权限

#### 任务9.1：菜单SQL脚本
- [ ] 创建菜单SQL脚本
- [ ] 菜单ID分配：430-439（企微助手功能段）
- [ ] 角色授权SQL

**菜单结构**:
```
430 企微助手
├── 431 企业配置
├── 432 会话存档
│   ├── 433 会话列表(功能点)
│   └── 434 消息详情(功能点)
├── 435 员工客户
│   ├── 436 员工列表(功能点)
│   ├── 437 客户列表(功能点)
│   └── 438 群聊列表(功能点)
└── 439 消息导出
```

**交付物**: 菜单SQL脚本

---

#### 任务9.2：权限码配置
- [ ] 定义权限码
- [ ] 在Controller中添加 `@SaCheckPermission` 注解

**权限码定义**:
- `wecom:config:manage` - 配置管理
- `wecom:conversation:query` - 查询会话
- `wecom:message:query` - 查询消息
- `wecom:staff:query` - 查询员工
- `wecom:customer:query` - 查询客户
- `wecom:export:create` - 创建导出

**交付物**: 权限配置完成

---

### 阶段10：测试与优化

#### 任务10.1：功能测试
- [ ] 消息拉取测试（各种消息类型）
- [ ] 会话查询测试
- [ ] 消息查询测试（各种场景）
- [ ] 导出功能测试
- [ ] 异常场景测试

**测试场景**:
- 单聊消息
- 群聊消息
- 群发消息
- 媒体文件消息
- 撤回消息
- 大量数据分页

**交付物**: 测试报告

---

#### 任务10.2：性能优化
- [ ] SQL查询优化（EXPLAIN分析）
- [ ] 索引优化
- [ ] 分页性能优化
- [ ] 前端虚拟滚动优化
- [ ] 媒体文件加载优化

**关键优化点**:
- `t_wecom_message_conversation.idx_to_time` 索引使用
- 消息表分区查询
- 媒体文件CDN加速

**交付物**: 性能优化报告

---

## 🎯 里程碑

### 里程碑1：数据库完成
- ✅ 数据库表创建完成
- ✅ Entity、Dao、Mapper全部完成
- ✅ 基础架构搭建完成

### 里程碑2：消息拉取完成
- ✅ 消息拉取定时任务运行
- ✅ 消息解析和存储正常
- ✅ 消息会话关联逻辑正确

### 里程碑3：核心功能完成
- ✅ 会话管理功能完成
- ✅ 消息查询功能完成
- ✅ 消息类型渲染完成

### 里程碑4：前端完成
- ✅ 所有前端页面开发完成
- ✅ 前后端联调通过

### 里程碑5：上线准备
- ✅ 功能测试通过
- ✅ 性能优化完成
- ✅ 文档编写完成

---

## ⚠️ 风险与注意事项

### 技术风险

1. **企业微信API限制**
   - 风险：API调用频率限制、权限限制
   - 应对：合理设置拉取间隔，实现断点续传

2. **大数据量性能**
   - 风险：消息量大时查询和展示性能下降
   - 应对：表分区、索引优化、前端虚拟滚动

3. **媒体文件存储**
   - 风险：媒体文件占用大量存储空间
   - 应对：设置文件过期策略，可选云存储

### 开发风险

1. **消息类型多样性**
   - 风险：20+种消息类型，解析复杂
   - 应对：先实现核心类型，逐步扩展

2. **会话关联逻辑**
   - 风险：群发消息的会话关联逻辑复杂
   - 应对：充分测试各种场景，确保逻辑正确

---

## 📖 参考文档

- [数据库设计文档](./WECOM_CHAT_DATABASE_DESIGN.md)
- [SmartAdmin后端开发规范](../smart-admin-api-java17-springboot3/.claude/BACKEND_CODING_STANDARDS.md)
- [SmartAdmin后端开发指南](../smart-admin-api-java17-springboot3/.claude/BACKEND_DEV_GUIDE.md)
- [企业微信会话存档API文档](https://developer.work.weixin.qq.com/document/path/91774)

---

**文档版本**: v1.0
**最后更新**: 2025-10-08
**维护人**: wangxiao