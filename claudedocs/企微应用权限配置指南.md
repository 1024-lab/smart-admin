---
title: 企业微信自建应用权限配置指南
author: wangxiao
company: 子午线高科智能科技
date: 2025-10-14
permalink: claudedocs/企微应用权限配置指南
---

# 企业微信自建应用权限配置指南

## 问题说明

当前的通讯录Secret返回错误码 `48009`,原因是使用了"通讯录同步助手"类型的应用,该类型不支持主动查询API。

**错误信息**:
```json
{
    "errcode": 48009,
    "errmsg": "api forbidden for contact assistant"
}
```

**解决方案**: 创建自建应用,获取新的Secret。

---

## 🚀 创建自建应用步骤

### 第一步: 登录管理后台

访问: https://work.weixin.qq.com

使用管理员账号登录。

---

### 第二步: 进入应用管理

导航路径:
```
管理工具 → 应用管理 → 应用 → 自建
```

或者直接访问: https://work.weixin.qq.com/wework_admin/frame#apps

---

### 第三步: 创建应用

1. 点击 **"创建应用"** 按钮

2. 填写应用信息:

| 字段 | 填写内容 | 说明 |
|------|----------|------|
| **应用名称** | 会话存档管理 | 或其他自定义名称 |
| **应用Logo** | 上传图标 | 可以用公司Logo |
| **应用介绍** | 用于会话存档和通讯录管理 | 简要说明用途 |
| **可见范围** | 选择员工/部门 | 至少包含需要使用的员工 |

3. 点击 **"创建应用"**

---

### 第四步: 获取应用凭证

创建成功后,进入应用详情页面:

#### 记录AgentId和Secret

```
应用信息
├─ AgentId: 1000002 (示例,实际以页面显示为准)
└─ Secret: [点击"查看"按钮] → 复制Secret
```

**重要**: Secret只显示一次,务必保存好!

**示例Secret格式**:
```
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

---

### 第五步: 配置权限 ⭐ 关键步骤

在应用详情页面,找到 **"权限管理"** 或 **"API权限"** 模块:

#### 必需权限

勾选以下权限:

1. **✅ 通讯录管理**
   - 获取部门列表
   - 获取成员信息
   - 读取成员敏感信息 (如手机号,可选)

2. **✅ 客户联系** (如需要客户功能)
   - 管理企业客户
   - 客户联系「联系我」使用权限
   - 管理客户群

3. **✅ 会话内容存档** (如需要拉取消息)
   - 会话内容存档

#### 可选权限

根据实际需要勾选:
- 获取打卡数据
- 审批应用权限
- 日程

---

### 第六步: 配置IP白名单 (重要)

找到 **"企业可信IP"** 设置:

#### 方法A: 添加代理服务器IP (推荐)

```
121.43.243.40
```

#### 方法B: 添加IP段

如果服务器IP可能变化:
```
121.43.243.0/24
```

#### 方法C: 开发测试环境

如果仅用于开发测试 (不推荐生产环境):
```
0.0.0.0/0
```

**注意**: `0.0.0.0/0` 表示允许所有IP,存在安全风险,生产环境不建议使用。

---

### 第七步: 保存配置

点击页面底部的 **"保存"** 按钮。

---

## 🔧 测试新Secret

### 更新配置文件

编辑 `claudedocs/api 参数` 文件:

```bash
# 企业微信 API 配置参数
# @Author: wangxiao
# @Date: 2025-10-14

# 企业ID (所有应用通用)
CORP_ID=ww7d5bca9c66c2e988

# 会话存档Secret (用于拉取会话消息)
CHAT_ARCHIVE_SECRET=n4TgNHACnKUe8Q_vzcDFpDXtfQ-Go3mHmoG_S1mxPYM

# 通讯录管理Secret (通讯录同步助手 - 有限制)
CONTACTS_SECRET=URKzVx0vJRWJ7QPbjizd5WbrABSkqyq5EjKsNOeLhx4

# 自建应用Secret (新创建的应用 - 完整权限) ⭐
APP_SECRET=xxxxxxxxxxxxxxxxxxxxx  # 替换为实际Secret
APP_AGENT_ID=1000002  # 替换为实际AgentId
```

### 测试命令

```bash
#!/bin/bash

CORP_ID="ww7d5bca9c66c2e988"
APP_SECRET="xxxxxxxxxxxxxxxxxxxxx"  # 替换为新的Secret

# 1. 获取Token
echo "【1】获取 Access Token"
TOKEN=$(curl -s "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=$CORP_ID&corpsecret=$APP_SECRET" | python3 -c "import sys, json; print(json.load(sys.stdin).get('access_token', ''))")

if [ -z "$TOKEN" ]; then
    echo "❌ Token获取失败"
    exit 1
fi

echo "✅ Token: ${TOKEN:0:30}..."
echo ""

# 2. 测试获取部门列表
echo "【2】获取部门列表"
curl -s "https://qyapi.weixin.qq.com/cgi-bin/department/list?access_token=$TOKEN" | python3 -m json.tool
echo ""

# 3. 测试获取成员列表
echo "【3】获取成员列表"
curl -s "https://qyapi.weixin.qq.com/cgi-bin/user/simplelist?access_token=$TOKEN&department_id=1" | python3 -m json.tool
echo ""

# 4. 测试获取成员详情
echo "【4】获取成员详情 (UserID: HuJie)"
curl -s "https://qyapi.weixin.qq.com/cgi-bin/user/get?access_token=$TOKEN&userid=HuJie" | python3 -m json.tool
```

---

## 📊 权限对比

### 通讯录同步助手 vs 自建应用

| 功能 | 通讯录同步助手 | 自建应用 |
|------|--------------|----------|
| 类型 | 系统应用 | 自建应用 |
| 获取部门列表 | ❌ 不支持 | ✅ 支持 |
| 获取成员列表 | ❌ 不支持 | ✅ 支持 |
| 获取成员详情 | ❌ 不支持 | ✅ 支持 |
| 通讯录变更回调 | ✅ 支持 | ✅ 支持 |
| 客户联系API | ❌ 不支持 | ✅ 支持 (需配置) |
| 会话存档API | ❌ 不支持 | ✅ 支持 (需配置) |

---

## ❓ 常见问题

### Q1: 为什么通讯录同步助手不能查询?

**A**: 这是企业微信的设计限制。通讯录同步助手只能**被动接收**通讯录变更事件,不能主动查询。这样设计是为了安全考虑。

### Q2: 自建应用和通讯录同步助手可以同时使用吗?

**A**: 可以!建议的配置:
- **会话存档Secret**: 用于拉取会话消息
- **自建应用Secret**: 用于查询通讯录、客户信息
- **通讯录同步助手**: 用于接收通讯录变更通知 (可选)

### Q3: Secret会过期吗?

**A**: 不会。Secret是长期有效的,除非你主动重置。但Access Token会过期(7200秒),需要定期刷新。

### Q4: 可见范围如何设置?

**A**:
- **开发测试**: 可以只设置几个测试账号
- **生产环境**: 设置为全公司或相关部门
- **注意**: 只有在可见范围内的员工才能在企业微信中看到这个应用

### Q5: 如果没有管理员权限怎么办?

**A**: 需要联系企业微信管理员:
1. 说明需要创建自建应用
2. 提供应用名称和用途说明
3. 说明需要的权限: 通讯录管理、客户联系、会话存档
4. 提供需要添加的IP白名单

---

## 🎯 推荐配置方案

### 完整配置 (推荐)

创建**一个自建应用**,包含所有需要的权限:

**应用名称**: "会话存档与通讯录管理"

**配置权限**:
- ✅ 通讯录管理 (查询员工信息)
- ✅ 客户联系 (查询客户信息)
- ✅ 会话内容存档 (拉取会话消息)

**优点**:
- 只需要维护一个Secret
- 所有功能统一管理
- 配置简单

**缺点**:
- 权限较大,需要注意安全

### 分离配置 (安全性更高)

创建**多个自建应用**,每个应用负责不同功能:

#### 应用1: 通讯录查询应用
- 权限: 通讯录管理
- 用途: 查询员工、部门信息

#### 应用2: 客户管理应用
- 权限: 客户联系
- 用途: 查询客户信息

#### 应用3: 会话存档应用
- 权限: 会话内容存档
- 用途: 拉取会话消息

**优点**:
- 权限分离,更安全
- 某个应用出问题不影响其他功能

**缺点**:
- 需要维护多个Secret
- 配置相对复杂

---

## 📝 配置完成检查清单

创建应用后,请确认以下事项:

- [ ] 已获取 AgentId
- [ ] 已获取 Secret (并保存好)
- [ ] 已配置通讯录管理权限
- [ ] 已配置IP白名单
- [ ] 已设置可见范围
- [ ] 已测试获取Token
- [ ] 已测试获取部门列表
- [ ] 已测试获取成员列表
- [ ] 已测试获取成员详情

---

## 🔗 相关文档

- [企业微信应用管理](https://work.weixin.qq.com/wework_admin/frame#apps)
- [通讯录管理API文档](https://developer.work.weixin.qq.com/document/path/90196)
- [自建应用开发指南](https://developer.work.weixin.qq.com/document/path/90556)
- [API权限说明](https://developer.work.weixin.qq.com/document/path/90313)

---

**文档生成时间**: 2025-10-14
**下次更新**: 创建应用并测试成功后