# ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

**è®¾è®¡äººå‘˜**: wangxiao
**è®¾è®¡æ—¥æœŸ**: 2025-10-04
**ä¼ä¸š**: å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€
**ç‰ˆæœ¬**: 1.0

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [æ•°æ®åº“è®¾è®¡](#2-æ•°æ®åº“è®¾è®¡)
3. [åç«¯æ¶æ„è®¾è®¡](#3-åç«¯æ¶æ„è®¾è®¡)
4. [å‰ç«¯æ¶æ„è®¾è®¡](#4-å‰ç«¯æ¶æ„è®¾è®¡)
5. [æ•°æ®åŒæ­¥æœºåˆ¶](#5-æ•°æ®åŒæ­¥æœºåˆ¶)
6. [éƒ¨ç½²æ¶æ„](#6-éƒ¨ç½²æ¶æ„)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 ä¸šåŠ¡ç›®æ ‡

åŸºäºWxJava SDKå®ç°ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£åŠŸèƒ½ï¼Œå°†ä¼ä¸šå¾®ä¿¡èŠå¤©è®°å½•å®æ—¶åŒæ­¥åˆ°è‡ªæœ‰æ•°æ®åº“ï¼Œå¹¶æä¾›å‰ç«¯å±•ç¤ºç•Œé¢ï¼Œæ”¯æŒï¼š
- âœ… å®æ—¶åŒæ­¥ä¼ä¸šå¾®ä¿¡èŠå¤©è®°å½•ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶ç­‰20+ç§æ¶ˆæ¯ç±»å‹ï¼‰
- âœ… åˆ†é¡µæŸ¥è¯¢å’Œæœç´¢èŠå¤©è®°å½•
- âœ… å¤šåª’ä½“æ–‡ä»¶å­˜å‚¨å’Œé¢„è§ˆ
- âœ… æƒé™æ§åˆ¶å’Œæ•°æ®å®‰å…¨

### 1.2 æŠ€æœ¯æ ˆ

| å±‚æ¬¡ | æŠ€æœ¯é€‰å‹ |
|------|----------|
| **å‰ç«¯** | Vue3 + TypeScript + Ant Design Vue 4.2.5 |
| **åç«¯** | Java17 + SpringBoot3 + MyBatis-Plus |
| **SDK** | WxJava 4.7.0 + ä¼ä¸šå¾®ä¿¡FinanceåŸç”Ÿåº“ |
| **æ•°æ®åº“** | MySQL 8.0 |
| **å­˜å‚¨** | é˜¿é‡Œäº‘OSS / MinIO |
| **å®šæ—¶ä»»åŠ¡** | Spring @Scheduled |
| **çŠ¶æ€ç®¡ç†** | Pinia 2.1.7 |
| **è·¯ç”±** | Vue Router 4.3.2 |

### 1.3 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¼ä¸šå¾®ä¿¡æœåŠ¡å™¨                          â”‚
â”‚              (ä¼šè¯å­˜æ¡£API + åª’ä½“æ–‡ä»¶API)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTPS
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SmartAdmin åç«¯                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WecomFinanceManager (åŸç”Ÿåº“å°è£…)                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ Finance.so/dll åŠ è½½                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ æ‹‰å–èŠå¤©è®°å½• (GetChatData)                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ è§£å¯†æ¶ˆæ¯ (DecryptData)                           â”‚  â”‚
â”‚  â”‚  â””â”€ ä¸‹è½½åª’ä½“æ–‡ä»¶ (GetMediaData)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WecomChatArchiveService (ä¸šåŠ¡é€»è¾‘)                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ æ¶ˆæ¯åŒæ­¥å’Œè§£æ                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ åˆ†é¡µæŸ¥è¯¢å’Œæœç´¢                                   â”‚  â”‚
â”‚  â”‚  â””â”€ åª’ä½“æ–‡ä»¶å¤„ç†                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  æ•°æ®æŒä¹…åŒ–å±‚                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ MySQL (æ¶ˆæ¯ã€ä¼šè¯ã€ç”¨æˆ·ã€éƒ¨é—¨)                   â”‚  â”‚
â”‚  â”‚  â””â”€ OSS (å›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ RESTful API
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SmartAdmin å‰ç«¯                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  èŠå¤©è®°å½•æŸ¥è¯¢é¡µé¢ (chat-archive-list.vue)            â”‚  â”‚
â”‚  â”‚  â”œâ”€ æœç´¢ç­›é€‰è¡¨å•                                     â”‚  â”‚
â”‚  â”‚  â””â”€ èŠå¤©æ¶ˆæ¯åˆ—è¡¨ (ChatMessageList.vue)              â”‚  â”‚
â”‚  â”‚      â”œâ”€ æ–‡æœ¬æ¶ˆæ¯é¡¹ (ChatMessageItem.vue)            â”‚  â”‚
â”‚  â”‚      â”œâ”€ å›¾ç‰‡æ¶ˆæ¯é¡¹                                   â”‚  â”‚
â”‚  â”‚      â”œâ”€ è§†é¢‘æ¶ˆæ¯é¡¹                                   â”‚  â”‚
â”‚  â”‚      â””â”€ æ–‡ä»¶æ¶ˆæ¯é¡¹                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 è¡¨ç»“æ„è®¾è®¡

#### 2.1.1 ä¼ä¸šå¾®ä¿¡éƒ¨é—¨è¡¨ (t_wecom_department)

```sql
CREATE TABLE `t_wecom_department` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `department_id` bigint NOT NULL COMMENT 'éƒ¨é—¨IDï¼ˆä¼ä¸šå¾®ä¿¡ï¼‰',
  `name` varchar(100) NOT NULL COMMENT 'éƒ¨é—¨åç§°',
  `name_en` varchar(100) DEFAULT NULL COMMENT 'éƒ¨é—¨è‹±æ–‡åç§°',
  `parent_id` bigint DEFAULT 0 COMMENT 'çˆ¶éƒ¨é—¨ID',
  `order_num` int DEFAULT 0 COMMENT 'æ’åºå·',
  `deleted_flag` tinyint NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤çŠ¶æ€ï¼š0-æœªåˆ é™¤ 1-å·²åˆ é™¤',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_department_id` (`department_id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_deleted_flag` (`deleted_flag`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ä¼ä¸šå¾®ä¿¡éƒ¨é—¨è¡¨';
```

**å­—æ®µè¯´æ˜**:
- `department_id`: ä¼ä¸šå¾®ä¿¡éƒ¨é—¨IDï¼ˆå”¯ä¸€ï¼‰
- `name`: éƒ¨é—¨åç§°
- `parent_id`: çˆ¶éƒ¨é—¨IDï¼Œæ„å»ºéƒ¨é—¨æ ‘å½¢ç»“æ„
- `order_num`: åŒçº§éƒ¨é—¨çš„æ’åºå·

#### 2.1.2 ä¼ä¸šå¾®ä¿¡æˆå‘˜è¡¨ (t_wecom_user)

```sql
CREATE TABLE `t_wecom_user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `user_id` varchar(64) NOT NULL COMMENT 'æˆå‘˜UserIDï¼ˆä¼ä¸šå¾®ä¿¡ï¼‰',
  `name` varchar(64) NOT NULL COMMENT 'æˆå‘˜åç§°',
  `alias` varchar(64) DEFAULT NULL COMMENT 'æˆå‘˜åˆ«å',
  `mobile` varchar(32) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `gender` tinyint DEFAULT 0 COMMENT 'æ€§åˆ«ï¼š0-æœªå®šä¹‰ 1-ç”· 2-å¥³',
  `email` varchar(128) DEFAULT NULL COMMENT 'é‚®ç®±',
  `avatar` varchar(500) DEFAULT NULL COMMENT 'å¤´åƒURL',
  `status` tinyint DEFAULT 1 COMMENT 'æ¿€æ´»çŠ¶æ€ï¼š1-å·²æ¿€æ´» 2-å·²ç¦ç”¨ 4-æœªæ¿€æ´» 5-é€€å‡ºä¼ä¸š',
  `department_ids` varchar(500) DEFAULT NULL COMMENT 'æ‰€å±éƒ¨é—¨IDåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰',
  `position` varchar(128) DEFAULT NULL COMMENT 'èŒåŠ¡',
  `deleted_flag` tinyint NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤çŠ¶æ€ï¼š0-æœªåˆ é™¤ 1-å·²åˆ é™¤',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_mobile` (`mobile`),
  KEY `idx_deleted_flag` (`deleted_flag`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ä¼ä¸šå¾®ä¿¡æˆå‘˜è¡¨';
```

**å­—æ®µè¯´æ˜**:
- `user_id`: ä¼ä¸šå¾®ä¿¡æˆå‘˜UserIDï¼ˆå”¯ä¸€ï¼‰
- `department_ids`: æ‰€å±éƒ¨é—¨IDåˆ—è¡¨ï¼ˆä¸€ä¸ªæˆå‘˜å¯èƒ½å±äºå¤šä¸ªéƒ¨é—¨ï¼‰
- `status`: æˆå‘˜æ¿€æ´»çŠ¶æ€

#### 2.1.3 ä¼ä¸šå¾®ä¿¡ç¾¤èŠè¡¨ (t_wecom_room)

```sql
CREATE TABLE `t_wecom_room` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `room_id` varchar(64) NOT NULL COMMENT 'ç¾¤èŠIDï¼ˆä¼ä¸šå¾®ä¿¡ï¼‰',
  `room_name` varchar(255) DEFAULT NULL COMMENT 'ç¾¤èŠåç§°',
  `owner_user_id` varchar(64) DEFAULT NULL COMMENT 'ç¾¤ä¸»UserID',
  `member_count` int DEFAULT 0 COMMENT 'ç¾¤æˆå‘˜æ•°é‡',
  `member_list` text DEFAULT NULL COMMENT 'ç¾¤æˆå‘˜UserIDåˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰',
  `create_user_id` varchar(64) DEFAULT NULL COMMENT 'åˆ›å»ºè€…UserID',
  `room_create_time` bigint DEFAULT NULL COMMENT 'ç¾¤åˆ›å»ºæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰',
  `deleted_flag` tinyint NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤çŠ¶æ€ï¼š0-æœªåˆ é™¤ 1-å·²åˆ é™¤',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_room_id` (`room_id`),
  KEY `idx_owner` (`owner_user_id`),
  KEY `idx_deleted_flag` (`deleted_flag`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ä¼ä¸šå¾®ä¿¡ç¾¤èŠè¡¨';
```

**å­—æ®µè¯´æ˜**:
- `room_id`: ä¼ä¸šå¾®ä¿¡ç¾¤èŠIDï¼ˆå”¯ä¸€ï¼‰
- `member_list`: ç¾¤æˆå‘˜åˆ—è¡¨ï¼ˆJSONæ•°ç»„æ ¼å¼ï¼Œå¦‚ `["user1", "user2"]`ï¼‰
- `room_create_time`: ç¾¤èŠåˆ›å»ºæ—¶é—´ï¼ˆä»æ¶ˆæ¯ä¸­æå–ï¼‰

#### 2.1.4 ä¼ä¸šå¾®ä¿¡èŠå¤©æ¶ˆæ¯è¡¨ (t_wecom_chat_message)

```sql
CREATE TABLE `t_wecom_chat_message` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `msg_id` varchar(128) NOT NULL COMMENT 'æ¶ˆæ¯IDï¼ˆä¼ä¸šå¾®ä¿¡ï¼‰',
  `msg_type` varchar(32) NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹ï¼ˆtext/image/video/voice/fileç­‰ï¼‰',
  `msg_time` bigint NOT NULL COMMENT 'æ¶ˆæ¯æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰',
  `from_user_id` varchar(64) NOT NULL COMMENT 'å‘é€è€…UserID',
  `to_user_list` varchar(1000) DEFAULT NULL COMMENT 'æ¥æ”¶è€…UserIDåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰',
  `room_id` varchar(64) DEFAULT NULL COMMENT 'ç¾¤èŠIDï¼ˆç¾¤èŠæ¶ˆæ¯æ‰æœ‰ï¼‰',
  `content` text NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰',
  `content_text` text DEFAULT NULL COMMENT 'æ–‡æœ¬å†…å®¹ï¼ˆæ–‡æœ¬æ¶ˆæ¯ä¸“ç”¨ï¼Œç”¨äºæœç´¢ï¼‰',
  `seq` bigint NOT NULL COMMENT 'æ¶ˆæ¯åºåˆ—å·',
  `action` varchar(32) DEFAULT NULL COMMENT 'æ¶ˆæ¯åŠ¨ä½œï¼ˆsend/recall/switchï¼‰',
  `media_url` varchar(500) DEFAULT NULL COMMENT 'åª’ä½“æ–‡ä»¶URLï¼ˆå›¾ç‰‡/è§†é¢‘/æ–‡ä»¶ï¼‰',
  `media_size` bigint DEFAULT NULL COMMENT 'åª’ä½“æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
  `deleted_flag` tinyint NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤çŠ¶æ€ï¼š0-æœªåˆ é™¤ 1-å·²åˆ é™¤',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_msg_id` (`msg_id`),
  KEY `idx_seq` (`seq`),
  KEY `idx_from_user` (`from_user_id`),
  KEY `idx_room_id` (`room_id`),
  KEY `idx_msg_time` (`msg_time`),
  KEY `idx_msg_type` (`msg_type`),
  KEY `idx_deleted_flag` (`deleted_flag`),
  FULLTEXT KEY `ft_content_text` (`content_text`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ä¼ä¸šå¾®ä¿¡èŠå¤©æ¶ˆæ¯è¡¨';
```

**å­—æ®µè¯´æ˜**:
- `msg_id`: æ¶ˆæ¯å”¯ä¸€æ ‡è¯†ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
- `seq`: æ¶ˆæ¯åºåˆ—å·ï¼ˆé€’å¢ï¼Œç”¨äºå¢é‡åŒæ­¥ï¼‰
- `content`: åŸå§‹æ¶ˆæ¯å†…å®¹ï¼ˆJSONæ ¼å¼ï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µï¼‰
- `content_text`: æå–çš„æ–‡æœ¬å†…å®¹ï¼ˆä»…æ–‡æœ¬æ¶ˆæ¯ï¼Œç”¨äºå…¨æ–‡æœç´¢ï¼‰
- `media_url`: åª’ä½“æ–‡ä»¶URLï¼ˆå›¾ç‰‡/è§†é¢‘/æ–‡ä»¶ä¸Šä¼ åˆ°OSSåçš„URLï¼‰
- `action`: æ¶ˆæ¯åŠ¨ä½œ
  - `send`: å‘é€æ¶ˆæ¯
  - `recall`: æ’¤å›æ¶ˆæ¯
  - `switch`: åˆ‡æ¢ä¼ä¸šæ—¥å¿—

#### 2.1.5 æ¶ˆæ¯åŒæ­¥çŠ¶æ€è¡¨ (t_wecom_sync_status)

```sql
CREATE TABLE `t_wecom_sync_status` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `last_seq` bigint NOT NULL DEFAULT 0 COMMENT 'ä¸Šæ¬¡åŒæ­¥çš„æœ€å¤§seq',
  `last_sync_time` datetime DEFAULT NULL COMMENT 'ä¸Šæ¬¡åŒæ­¥æ—¶é—´',
  `sync_count` int DEFAULT 0 COMMENT 'æœ¬æ¬¡åŒæ­¥æ¶ˆæ¯æ•°é‡',
  `sync_status` tinyint DEFAULT 1 COMMENT 'åŒæ­¥çŠ¶æ€ï¼š1-æˆåŠŸ 0-å¤±è´¥',
  `error_msg` varchar(500) DEFAULT NULL COMMENT 'é”™è¯¯ä¿¡æ¯',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_last_sync_time` (`last_sync_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ¶ˆæ¯åŒæ­¥çŠ¶æ€è¡¨';
```

**å­—æ®µè¯´æ˜**:
- `last_seq`: è®°å½•ä¸Šæ¬¡åŒæ­¥åˆ°çš„æ¶ˆæ¯åºåˆ—å·ï¼Œç”¨äºå¢é‡åŒæ­¥
- `sync_status`: åŒæ­¥çŠ¶æ€ï¼Œç”¨äºç›‘æ§
- `error_msg`: åŒæ­¥å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯

### 2.2 æ•°æ®åº“ç´¢å¼•ç­–ç•¥

| è¡¨å | ç´¢å¼•ç±»å‹ | ç´¢å¼•å­—æ®µ | è¯´æ˜ |
|------|----------|----------|------|
| `t_wecom_chat_message` | å”¯ä¸€ç´¢å¼• | `msg_id` | æ¶ˆæ¯å»é‡ |
| `t_wecom_chat_message` | æ™®é€šç´¢å¼• | `seq` | å¢é‡åŒæ­¥æŸ¥è¯¢ |
| `t_wecom_chat_message` | æ™®é€šç´¢å¼• | `from_user_id` | æŒ‰å‘é€è€…æŸ¥è¯¢ |
| `t_wecom_chat_message` | æ™®é€šç´¢å¼• | `room_id` | æŒ‰ç¾¤èŠæŸ¥è¯¢ |
| `t_wecom_chat_message` | æ™®é€šç´¢å¼• | `msg_time` | æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ |
| `t_wecom_chat_message` | å…¨æ–‡ç´¢å¼• | `content_text` | å…¨æ–‡æœç´¢ |
| `t_wecom_user` | å”¯ä¸€ç´¢å¼• | `user_id` | ç”¨æˆ·å»é‡ |
| `t_wecom_room` | å”¯ä¸€ç´¢å¼• | `room_id` | ç¾¤èŠå»é‡ |

### 2.3 æ•°æ®åˆ†åŒºç­–ç•¥ï¼ˆå¯é€‰ï¼‰

é’ˆå¯¹æµ·é‡æ¶ˆæ¯æ•°æ®ï¼Œå»ºè®®æŒ‰æ—¶é—´åˆ†åŒºï¼š

```sql
-- æŒ‰æœˆåˆ†åŒºç¤ºä¾‹
ALTER TABLE t_wecom_chat_message
PARTITION BY RANGE (UNIX_TIMESTAMP(create_time)) (
    PARTITION p202501 VALUES LESS THAN (UNIX_TIMESTAMP('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (UNIX_TIMESTAMP('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (UNIX_TIMESTAMP('2025-04-01')),
    -- ... å…¶ä»–åˆ†åŒº
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

**ä¼˜åŠ¿**:
- æé«˜å†å²æ•°æ®æŸ¥è¯¢æ€§èƒ½
- æ–¹ä¾¿å½’æ¡£å’Œåˆ é™¤æ—§æ•°æ®
- é™ä½ç´¢å¼•ç»´æŠ¤æˆæœ¬

---

## 3. åç«¯æ¶æ„è®¾è®¡

### 3.1 æ¨¡å—ç»“æ„

```
smart-admin-api-java17-springboot3/
â””â”€â”€ sa-admin/
    â””â”€â”€ src/main/java/net/lab1024/sa/admin/
        â””â”€â”€ module/business/wecom/
            â”œâ”€â”€ controller/
            â”‚   â”œâ”€â”€ WecomChatArchiveController.java       # ä¼šè¯å­˜æ¡£Controller
            â”‚   â”œâ”€â”€ WecomUserController.java              # æˆå‘˜ç®¡ç†Controller
            â”‚   â””â”€â”€ WecomDepartmentController.java        # éƒ¨é—¨ç®¡ç†Controller
            â”œâ”€â”€ service/
            â”‚   â”œâ”€â”€ WecomChatArchiveService.java          # ä¼šè¯å­˜æ¡£Service
            â”‚   â”œâ”€â”€ WecomMessageDecryptService.java       # æ¶ˆæ¯è§£å¯†Service
            â”‚   â”œâ”€â”€ WecomUserService.java                 # æˆå‘˜Service
            â”‚   â”œâ”€â”€ WecomDepartmentService.java           # éƒ¨é—¨Service
            â”‚   â””â”€â”€ WecomSyncService.java                 # æ•°æ®åŒæ­¥Service
            â”œâ”€â”€ manager/
            â”‚   â”œâ”€â”€ WecomFinanceManager.java              # Finance SDKç®¡ç†å™¨
            â”‚   â””â”€â”€ WecomMediaManager.java                # åª’ä½“æ–‡ä»¶ç®¡ç†å™¨
            â”œâ”€â”€ dao/
            â”‚   â”œâ”€â”€ WecomChatMessageDao.java              # æ¶ˆæ¯Dao
            â”‚   â”œâ”€â”€ WecomUserDao.java                     # æˆå‘˜Dao
            â”‚   â”œâ”€â”€ WecomDepartmentDao.java               # éƒ¨é—¨Dao
            â”‚   â”œâ”€â”€ WecomRoomDao.java                     # ç¾¤èŠDao
            â”‚   â””â”€â”€ WecomSyncStatusDao.java               # åŒæ­¥çŠ¶æ€Dao
            â”œâ”€â”€ domain/
            â”‚   â”œâ”€â”€ entity/
            â”‚   â”‚   â”œâ”€â”€ WecomChatMessageEntity.java       # æ¶ˆæ¯å®ä½“
            â”‚   â”‚   â”œâ”€â”€ WecomUserEntity.java              # æˆå‘˜å®ä½“
            â”‚   â”‚   â”œâ”€â”€ WecomDepartmentEntity.java        # éƒ¨é—¨å®ä½“
            â”‚   â”‚   â”œâ”€â”€ WecomRoomEntity.java              # ç¾¤èŠå®ä½“
            â”‚   â”‚   â””â”€â”€ WecomSyncStatusEntity.java        # åŒæ­¥çŠ¶æ€å®ä½“
            â”‚   â”œâ”€â”€ form/
            â”‚   â”‚   â”œâ”€â”€ WecomChatQueryForm.java           # æ¶ˆæ¯æŸ¥è¯¢Form
            â”‚   â”‚   â”œâ”€â”€ WecomUserQueryForm.java           # æˆå‘˜æŸ¥è¯¢Form
            â”‚   â”‚   â””â”€â”€ WecomSyncForm.java                # åŒæ­¥Form
            â”‚   â””â”€â”€ vo/
            â”‚       â”œâ”€â”€ WecomChatMessageVO.java           # æ¶ˆæ¯VO
            â”‚       â”œâ”€â”€ WecomUserVO.java                  # æˆå‘˜VO
            â”‚       â”œâ”€â”€ WecomDepartmentVO.java            # éƒ¨é—¨VO
            â”‚       â””â”€â”€ WecomSyncStatusVO.java            # åŒæ­¥çŠ¶æ€VO
            â”œâ”€â”€ constant/
            â”‚   â”œâ”€â”€ WecomMessageTypeEnum.java             # æ¶ˆæ¯ç±»å‹æšä¸¾
            â”‚   â”œâ”€â”€ WecomSyncStatusEnum.java              # åŒæ­¥çŠ¶æ€æšä¸¾
            â”‚   â””â”€â”€ WecomErrorCodeEnum.java               # é”™è¯¯ç æšä¸¾
            â””â”€â”€ schedule/
                â””â”€â”€ WecomSyncSchedule.java                # å®šæ—¶åŒæ­¥ä»»åŠ¡

resources/
â”œâ”€â”€ wecom/
â”‚   â”œâ”€â”€ libWeWorkFinanceSdk_Java.so                       # LinuxåŸç”Ÿåº“
â”‚   â””â”€â”€ Finance.dll                                       # WindowsåŸç”Ÿåº“
â””â”€â”€ application.yml                                       # é…ç½®æ–‡ä»¶
```

### 3.2 æ ¸å¿ƒç±»è®¾è®¡

#### 3.2.1 WecomFinanceManager (Finance SDKç®¡ç†å™¨)

**èŒè´£**: å°è£…ä¼ä¸šå¾®ä¿¡Finance SDKçš„åŸç”Ÿåº“è°ƒç”¨

```java
/*
 * ä¼ä¸šå¾®ä¿¡Finance SDKç®¡ç†å™¨
 *
 * @Author:    wangxiao
 * @Date:      2025-10-04
 * @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
 */
@Component
@Slf4j
public class WecomFinanceManager {

    private long sdk;

    @Value("${wecom.corpid}")
    private String corpId;

    @Value("${wecom.chat-archive.secret}")
    private String secret;

    /**
     * åˆå§‹åŒ–SDK @author wangxiao
     */
    @PostConstruct
    public void init() {
        loadNativeLibrary();
        sdk = Finance.NewSdk();
        long ret = Finance.Init(sdk, corpId, secret);
        if (ret != 0) {
            throw new BusinessException(WecomErrorCodeEnum.SDK_INIT_FAILED);
        }
    }

    /**
     * æ‹‰å–èŠå¤©è®°å½• @author wangxiao
     */
    public String getChatData(long seq, long limit);

    /**
     * è§£å¯†æ¶ˆæ¯ @author wangxiao
     */
    public String decryptMessage(String encryptKey, String encryptMsg);

    /**
     * ä¸‹è½½åª’ä½“æ–‡ä»¶ @author wangxiao
     */
    public byte[] getMediaData(String sdkFileId, String indexBuf);

    /**
     * é”€æ¯SDK @author wangxiao
     */
    @PreDestroy
    public void destroy();
}
```

#### 3.2.2 WecomChatArchiveService (ä¼šè¯å­˜æ¡£ä¸šåŠ¡å±‚)

**èŒè´£**: èŠå¤©è®°å½•çš„åŒæ­¥ã€æŸ¥è¯¢ã€æœç´¢ä¸šåŠ¡é€»è¾‘

```java
/*
 * ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£Service
 *
 * @Author:    wangxiao
 * @Date:      2025-10-04
 * @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
 */
@Service
@Slf4j
public class WecomChatArchiveService {

    @Resource
    private WecomFinanceManager financeManager;

    @Resource
    private WecomMediaManager mediaManager;

    @Resource
    private WecomChatMessageDao chatMessageDao;

    @Resource
    private WecomSyncStatusDao syncStatusDao;

    /**
     * åŒæ­¥èŠå¤©è®°å½• @author wangxiao
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<Integer> syncChatMessages();

    /**
     * åˆ†é¡µæŸ¥è¯¢èŠå¤©è®°å½• @author wangxiao
     */
    public ResponseDTO<PageResult<WecomChatMessageVO>> queryPage(
        WecomChatQueryForm form);

    /**
     * å…¨æ–‡æœç´¢èŠå¤©è®°å½• @author wangxiao
     */
    public ResponseDTO<PageResult<WecomChatMessageVO>> searchMessages(
        String keyword, WecomChatQueryForm form);

    /**
     * è·å–æ¶ˆæ¯è¯¦æƒ… @author wangxiao
     */
    public ResponseDTO<WecomChatMessageVO> getMessageDetail(String msgId);

    /**
     * è§£ææ¶ˆæ¯ @author wangxiao
     */
    private WecomChatMessageEntity parseMessage(String plaintext);

    /**
     * å¤„ç†åª’ä½“æ–‡ä»¶ @author wangxiao
     */
    @Async
    private void processMediaFile(WecomChatMessageEntity message);
}
```

#### 3.2.3 WecomMediaManager (åª’ä½“æ–‡ä»¶ç®¡ç†å™¨)

**èŒè´£**: åª’ä½“æ–‡ä»¶ä¸‹è½½ã€ä¸Šä¼ OSSã€URLç”Ÿæˆ

```java
/*
 * ä¼ä¸šå¾®ä¿¡åª’ä½“æ–‡ä»¶ç®¡ç†å™¨
 *
 * @Author:    wangxiao
 * @Date:      2025-10-04
 * @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
 */
@Component
@Slf4j
public class WecomMediaManager {

    @Resource
    private WecomFinanceManager financeManager;

    @Resource
    private OssService ossService;  // OSSæœåŠ¡ï¼ˆé˜¿é‡Œäº‘/MinIOï¼‰

    /**
     * ä¸‹è½½å¹¶ä¸Šä¼ åª’ä½“æ–‡ä»¶ @author wangxiao
     */
    @Async
    public CompletableFuture<String> downloadAndUpload(
        String sdkFileId, String msgId, String msgType);

    /**
     * ç”Ÿæˆæ–‡ä»¶å­˜å‚¨è·¯å¾„ @author wangxiao
     */
    private String generateFilePath(String msgId, String msgType);

    /**
     * è·å–æ–‡ä»¶æ‰©å±•å @author wangxiao
     */
    private String getFileExtension(String msgType);
}
```

#### 3.2.4 WecomSyncSchedule (å®šæ—¶åŒæ­¥ä»»åŠ¡)

**èŒè´£**: å®šæ—¶æ‹‰å–å¢é‡æ¶ˆæ¯

```java
/*
 * ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯å®šæ—¶åŒæ­¥ä»»åŠ¡
 *
 * @Author:    wangxiao
 * @Date:      2025-10-04
 * @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
 */
@Component
@Slf4j
public class WecomSyncSchedule {

    @Resource
    private WecomChatArchiveService chatArchiveService;

    /**
     * å®šæ—¶åŒæ­¥èŠå¤©è®°å½• @author wangxiao
     * æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(cron = "0 */5 * * * ?")
    public void syncMessages() {
        log.info("å¼€å§‹å®šæ—¶åŒæ­¥ä¼ä¸šå¾®ä¿¡èŠå¤©è®°å½•");
        try {
            ResponseDTO<Integer> result = chatArchiveService.syncChatMessages();
            log.info("å®šæ—¶åŒæ­¥å®Œæˆï¼ŒåŒæ­¥æ¶ˆæ¯æ•°é‡ï¼š{}", result.getData());
        } catch (Exception e) {
            log.error("å®šæ—¶åŒæ­¥å¤±è´¥", e);
        }
    }
}
```

### 3.3 APIæ¥å£è®¾è®¡

#### 3.3.1 ä¼šè¯å­˜æ¡£API

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | æƒé™ |
|---------|------|------|------|
| `/business/wecom/chat-archive/sync` | POST | æ‰‹åŠ¨åŒæ­¥èŠå¤©è®°å½• | `wecom:chat-archive:sync` |
| `/business/wecom/chat-archive/queryPage` | POST | åˆ†é¡µæŸ¥è¯¢èŠå¤©è®°å½• | `wecom:chat-archive:query` |
| `/business/wecom/chat-archive/search` | POST | å…¨æ–‡æœç´¢èŠå¤©è®°å½• | `wecom:chat-archive:query` |
| `/business/wecom/chat-archive/detail/{msgId}` | GET | è·å–æ¶ˆæ¯è¯¦æƒ… | `wecom:chat-archive:query` |
| `/business/wecom/chat-archive/syncStatus` | GET | è·å–åŒæ­¥çŠ¶æ€ | `wecom:chat-archive:query` |

#### 3.3.2 æˆå‘˜ç®¡ç†API

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | æƒé™ |
|---------|------|------|------|
| `/business/wecom/user/sync` | POST | åŒæ­¥æˆå‘˜ä¿¡æ¯ | `wecom:user:sync` |
| `/business/wecom/user/queryPage` | POST | åˆ†é¡µæŸ¥è¯¢æˆå‘˜ | `wecom:user:query` |
| `/business/wecom/user/detail/{userId}` | GET | è·å–æˆå‘˜è¯¦æƒ… | `wecom:user:query` |

#### 3.3.3 éƒ¨é—¨ç®¡ç†API

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | æƒé™ |
|---------|------|------|------|
| `/business/wecom/department/sync` | POST | åŒæ­¥éƒ¨é—¨ä¿¡æ¯ | `wecom:dept:sync` |
| `/business/wecom/department/tree` | GET | è·å–éƒ¨é—¨æ ‘ | `wecom:dept:query` |

### 3.4 é…ç½®æ–‡ä»¶

**application.yml**:
```yaml
# ä¼ä¸šå¾®ä¿¡é…ç½®
wecom:
  # ä¼ä¸šID
  corpid: ww1234567890abcdef

  # ä¼šè¯å­˜æ¡£é…ç½®
  chat-archive:
    # ä¼šè¯å­˜æ¡£Secret
    secret: your_chat_archive_secret_here

    # RSAç§é’¥è·¯å¾„
    private-key: classpath:wecom/private.pem

    # æ¯æ¬¡æ‹‰å–æ¶ˆæ¯æ•°é‡
    batch-size: 1000

    # æ˜¯å¦å¯ç”¨å®šæ—¶åŒæ­¥
    schedule-enabled: true

    # å®šæ—¶åŒæ­¥cronè¡¨è¾¾å¼ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    schedule-cron: "0 */5 * * * ?"

  # åª’ä½“æ–‡ä»¶é…ç½®
  media:
    # å­˜å‚¨ç±»å‹ï¼šoss/minio/local
    storage-type: oss

    # OSSé…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰
    oss:
      endpoint: https://oss-cn-hangzhou.aliyuncs.com
      access-key-id: your_access_key_id
      access-key-secret: your_access_key_secret
      bucket-name: wecom-chat-files
      base-path: chat-archive/
```

---

## 4. å‰ç«¯æ¶æ„è®¾è®¡

### 4.1 ç›®å½•ç»“æ„ï¼ˆä¸¥æ ¼éµå¾ªå››ç›®å½•å¯¹åº”åŸåˆ™ï¼‰

```
smart-admin-web-typescript/src/
â”œâ”€â”€ api/business/wecom/
â”‚   â”œâ”€â”€ chat-archive-api.ts                    # ä¼šè¯å­˜æ¡£API
â”‚   â”œâ”€â”€ chat-archive-model.ts                  # ä¼šè¯å­˜æ¡£Model
â”‚   â”œâ”€â”€ user-api.ts                            # æˆå‘˜API
â”‚   â”œâ”€â”€ user-model.ts                          # æˆå‘˜Model
â”‚   â”œâ”€â”€ department-api.ts                      # éƒ¨é—¨API
â”‚   â””â”€â”€ department-model.ts                    # éƒ¨é—¨Model
â”‚
â”œâ”€â”€ constants/business/wecom/
â”‚   â”œâ”€â”€ chat-archive-const.ts                  # ä¼šè¯å­˜æ¡£å¸¸é‡ï¼ˆSmartEnumï¼‰
â”‚   â”œâ”€â”€ user-const.ts                          # æˆå‘˜å¸¸é‡
â”‚   â””â”€â”€ department-const.ts                    # éƒ¨é—¨å¸¸é‡
â”‚
â”œâ”€â”€ components/business/wecom/
â”‚   â”œâ”€â”€ ChatMessageList.vue                    # èŠå¤©æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶
â”‚   â”œâ”€â”€ ChatMessageItem.vue                    # å•æ¡æ¶ˆæ¯é¡¹ç»„ä»¶
â”‚   â”œâ”€â”€ ChatMediaPreview.vue                   # åª’ä½“æ–‡ä»¶é¢„è§ˆç»„ä»¶
â”‚   â”œâ”€â”€ ChatSearchForm.vue                     # æœç´¢è¡¨å•ç»„ä»¶
â”‚   â”œâ”€â”€ UserSelector.vue                       # ç”¨æˆ·é€‰æ‹©å™¨
â”‚   â””â”€â”€ DepartmentTree.vue                     # éƒ¨é—¨æ ‘ç»„ä»¶
â”‚
â””â”€â”€ views/business/wecom/
    â”œâ”€â”€ chat-archive-list.vue                  # èŠå¤©è®°å½•æŸ¥è¯¢é¡µé¢
    â”œâ”€â”€ user-list.vue                          # æˆå‘˜ç®¡ç†é¡µé¢
    â””â”€â”€ department-list.vue                    # éƒ¨é—¨ç®¡ç†é¡µé¢
```

### 4.2 æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 4.2.1 chat-archive-list.vue (èŠå¤©è®°å½•æŸ¥è¯¢é¡µé¢)

```vue
<!--
  ä¼ä¸šå¾®ä¿¡èŠå¤©è®°å½•æŸ¥è¯¢é¡µé¢

  @Author:    wangxiao
  @Date:      2025-10-04
  @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
-->
<template>
  <div class="chat-archive-page">
    <!-- æœç´¢ç­›é€‰åŒº -->
    <a-card title="æŸ¥è¯¢æ¡ä»¶" class="search-card">
      <ChatSearchForm
        ref="searchFormRef"
        @search="handleSearch"
        @reset="handleReset"
      />
    </a-card>

    <!-- èŠå¤©è®°å½•åˆ—è¡¨ -->
    <a-card title="èŠå¤©è®°å½•" class="message-list-card">
      <template #extra>
        <a-space>
          <a-button type="primary" @click="handleSync">
            <template #icon><SyncOutlined /></template>
            åŒæ­¥æ¶ˆæ¯
          </a-button>
          <a-button @click="handleExport">
            <template #icon><ExportOutlined /></template>
            å¯¼å‡º
          </a-button>
        </a-space>
      </template>

      <ChatMessageList
        ref="messageListRef"
        :query-form="queryForm"
      />
    </a-card>
  </div>
</template>

<script setup lang="ts">
// ç»„ä»¶é€»è¾‘...
</script>
```

**åŠŸèƒ½ç‰¹æ€§**:
- æœç´¢ç­›é€‰ï¼šå‘é€è€…ã€æ¥æ”¶è€…ã€ç¾¤èŠã€æ¶ˆæ¯ç±»å‹ã€æ—¶é—´èŒƒå›´ã€å…³é”®è¯
- æ¶ˆæ¯åˆ—è¡¨ï¼šåˆ†é¡µå±•ç¤ºã€è™šæ‹Ÿæ»šåŠ¨ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
- æ“ä½œåŠŸèƒ½ï¼šåŒæ­¥æ¶ˆæ¯ã€å¯¼å‡ºèŠå¤©è®°å½•

#### 4.2.2 ChatMessageList.vue (èŠå¤©æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶)

```vue
<!--
  èŠå¤©æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶

  @Author:    wangxiao
  @Date:      2025-10-04
  @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
-->
<template>
  <div class="chat-message-list">
    <a-spin :spinning="loading">
      <!-- è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ– -->
      <a-virtual-list
        :data="messages"
        :height="800"
        :item-height="100"
      >
        <template #default="{ item }">
          <ChatMessageItem :message="item" />
        </template>
      </a-virtual-list>

      <!-- åˆ†é¡µ -->
      <a-pagination
        v-model:current="pagination.current"
        v-model:page-size="pagination.pageSize"
        :total="pagination.total"
        :show-size-changer="true"
        :show-total="total => `å…± ${total} æ¡`"
        @change="handlePageChange"
      />
    </a-spin>
  </div>
</template>

<script setup lang="ts">
// ç»„ä»¶é€»è¾‘...
</script>
```

**åŠŸèƒ½ç‰¹æ€§**:
- è™šæ‹Ÿæ»šåŠ¨ï¼šä¼˜åŒ–å¤§é‡æ¶ˆæ¯çš„æ¸²æŸ“æ€§èƒ½
- åˆ†é¡µåŠ è½½ï¼šæ”¯æŒå‰ç«¯åˆ†é¡µå’Œåç«¯åˆ†é¡µ
- åŠ è½½æ›´å¤šï¼šæ»šåŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½

#### 4.2.3 ChatMessageItem.vue (å•æ¡æ¶ˆæ¯é¡¹ç»„ä»¶)

```vue
<!--
  å•æ¡æ¶ˆæ¯é¡¹ç»„ä»¶

  @Author:    wangxiao
  @Date:      2025-10-04
  @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
-->
<template>
  <div class="chat-message-item" :class="messageClass">
    <!-- æ¶ˆæ¯å¤´éƒ¨ -->
    <div class="message-header">
      <a-avatar :src="userAvatar" />
      <span class="user-name">{{ message.fromUserName }}</span>
      <span class="message-time">{{ formatTime(message.msgTime) }}</span>
    </div>

    <!-- æ¶ˆæ¯å†…å®¹ - æ ¹æ®ç±»å‹æ¸²æŸ“ -->
    <div class="message-content">
      <!-- æ–‡æœ¬æ¶ˆæ¯ -->
      <div v-if="message.msgType === 'text'" class="text-message">
        {{ contentData.text?.content }}
      </div>

      <!-- å›¾ç‰‡æ¶ˆæ¯ -->
      <div v-else-if="message.msgType === 'image'" class="image-message">
        <a-image
          :src="contentData.image?.file_url"
          :preview="true"
          style="max-width: 200px"
        />
      </div>

      <!-- è§†é¢‘æ¶ˆæ¯ -->
      <div v-else-if="message.msgType === 'video'" class="video-message">
        <video
          :src="contentData.video?.file_url"
          controls
          style="max-width: 300px"
        />
      </div>

      <!-- å…¶ä»–æ¶ˆæ¯ç±»å‹... -->
    </div>
  </div>
</template>

<script setup lang="ts">
// ç»„ä»¶é€»è¾‘...
</script>

<style scoped lang="less">
.chat-message-item {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;

  .message-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }

  .message-content {
    margin-left: 40px;
  }
}
</style>
```

**æ”¯æŒçš„æ¶ˆæ¯ç±»å‹**:
- æ–‡æœ¬æ¶ˆæ¯
- å›¾ç‰‡æ¶ˆæ¯ï¼ˆæ”¯æŒé¢„è§ˆï¼‰
- è§†é¢‘æ¶ˆæ¯ï¼ˆæ”¯æŒæ’­æ”¾ï¼‰
- è¯­éŸ³æ¶ˆæ¯ï¼ˆæ”¯æŒæ’­æ”¾ï¼‰
- æ–‡ä»¶æ¶ˆæ¯ï¼ˆæ”¯æŒä¸‹è½½ï¼‰
- æ’¤å›æ¶ˆæ¯
- é“¾æ¥æ¶ˆæ¯
- åç‰‡æ¶ˆæ¯
- ä½ç½®æ¶ˆæ¯
- å…¶ä»–æ¶ˆæ¯ç±»å‹

### 4.3 å¸¸é‡å®šä¹‰ï¼ˆSmartEnumï¼‰

**chat-archive-const.ts**:
```typescript
/*
 * ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£å¸¸é‡
 *
 * @Author:    wangxiao
 * @Date:      2025-10-04
 * @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
 */
import type { SmartEnum } from '@/types';

/**
 * æ¶ˆæ¯ç±»å‹æšä¸¾
 */
export const MESSAGE_TYPE_ENUM: SmartEnum<string> = {
  TEXT: { value: 'text', desc: 'æ–‡æœ¬æ¶ˆæ¯' },
  IMAGE: { value: 'image', desc: 'å›¾ç‰‡æ¶ˆæ¯' },
  REVOKE: { value: 'revoke', desc: 'æ’¤å›æ¶ˆæ¯' },
  VOICE: { value: 'voice', desc: 'è¯­éŸ³æ¶ˆæ¯' },
  VIDEO: { value: 'video', desc: 'è§†é¢‘æ¶ˆæ¯' },
  CARD: { value: 'card', desc: 'åç‰‡æ¶ˆæ¯' },
  LOCATION: { value: 'location', desc: 'ä½ç½®æ¶ˆæ¯' },
  EMOTION: { value: 'emotion', desc: 'è¡¨æƒ…æ¶ˆæ¯' },
  FILE: { value: 'file', desc: 'æ–‡ä»¶æ¶ˆæ¯' },
  LINK: { value: 'link', desc: 'é“¾æ¥æ¶ˆæ¯' },
  WEAPP: { value: 'weapp', desc: 'å°ç¨‹åºæ¶ˆæ¯' },
};

/**
 * åŒæ­¥çŠ¶æ€æšä¸¾
 */
export const SYNC_STATUS_ENUM: SmartEnum<number> = {
  SUCCESS: { value: 1, desc: 'åŒæ­¥æˆåŠŸ' },
  FAILED: { value: 0, desc: 'åŒæ­¥å¤±è´¥' },
  IN_PROGRESS: { value: 2, desc: 'åŒæ­¥ä¸­' },
};
```

### 4.4 Modelå®šä¹‰

**chat-archive-model.ts**:
```typescript
/*
 * ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£Model
 *
 * @Author:    wangxiao
 * @Date:      2025-10-04
 * @Copyright  å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€ 2025
 */

// æŸ¥è¯¢è¡¨å•
export interface WecomChatQueryForm extends PageParam {
  fromUserId?: string;     // å‘é€è€…UserID
  toUserId?: string;       // æ¥æ”¶è€…UserID
  roomId?: string;         // ç¾¤èŠID
  msgType?: string;        // æ¶ˆæ¯ç±»å‹
  startTime?: number;      // å¼€å§‹æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  endTime?: number;        // ç»“æŸæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  keyword?: string;        // å…³é”®è¯ï¼ˆå…¨æ–‡æœç´¢ï¼‰
}

// æ¶ˆæ¯VO
export interface WecomChatMessageVO {
  id: number;
  msgId: string;
  msgType: string;
  msgTime: number;
  fromUserId: string;
  fromUserName?: string;
  toUserList: string;
  roomId?: string;
  roomName?: string;
  content: string;
  contentText?: string;
  contentData?: MessageContent;  // è§£æåçš„å†…å®¹
  seq: number;
  action?: string;
  mediaUrl?: string;
  mediaSize?: number;
  createTime: string;
}

// æ¶ˆæ¯å†…å®¹ï¼ˆæ ¹æ®msgTypeä¸åŒï¼Œè§£æcontentå­—æ®µï¼‰
export interface MessageContent {
  text?: { content: string };
  image?: { sdkfileid: string; file_url?: string; filesize: number };
  video?: { sdkfileid: string; file_url?: string; play_length: number };
  voice?: { sdkfileid: string; file_url?: string; play_length: number };
  file?: { filename: string; sdkfileid: string; file_url?: string };
  // å…¶ä»–ç±»å‹...
}
```

---

## 5. æ•°æ®åŒæ­¥æœºåˆ¶

### 5.1 åŒæ­¥æµç¨‹è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®šæ—¶åŒæ­¥ä»»åŠ¡è§¦å‘                            â”‚
â”‚              (æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œå¯é…ç½®)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤1: è·å–ä¸Šæ¬¡åŒæ­¥çš„seq                                    â”‚
â”‚  - æŸ¥è¯¢ t_wecom_sync_status è¡¨                               â”‚
â”‚  - last_seq = ä¸Šæ¬¡åŒæ­¥çš„æœ€å¤§seqï¼ˆé»˜è®¤0ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤2: æ‹‰å–å¢é‡æ¶ˆæ¯                                         â”‚
â”‚  - è°ƒç”¨ Finance.GetChatData(sdk, seq, limit)                â”‚
â”‚  - limit = 1000ï¼ˆæ¯æ¬¡æ‹‰å–1000æ¡ï¼‰                            â”‚
â”‚  - å¾ªç¯æ‹‰å–ï¼Œç›´åˆ°æ²¡æœ‰æ›´å¤šæ¶ˆæ¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤3: è§£å¯†æ¶ˆæ¯                                             â”‚
â”‚  - æå– encrypt_random_key å’Œ encrypt_chat_msg               â”‚
â”‚  - è°ƒç”¨ Finance.DecryptData() è§£å¯†                          â”‚
â”‚  - è§£æJSONå¾—åˆ°åŸå§‹æ¶ˆæ¯å†…å®¹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤4: è§£ææ¶ˆæ¯å†…å®¹                                         â”‚
â”‚  - æå– msgid, msgtype, msgtime, from, tolist ç­‰å­—æ®µ        â”‚
â”‚  - å¯¹äºæ–‡æœ¬æ¶ˆæ¯ï¼Œæå– content_text ç”¨äºå…¨æ–‡æœç´¢              â”‚
â”‚  - å¯¹äºåª’ä½“æ¶ˆæ¯ï¼Œæå– sdkfileid                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤5: å¤„ç†åª’ä½“æ–‡ä»¶ï¼ˆå¼‚æ­¥ï¼‰                                 â”‚
â”‚  - åˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼ˆimage/video/voice/fileï¼‰                    â”‚
â”‚  - è°ƒç”¨ Finance.GetMediaData() ä¸‹è½½æ–‡ä»¶                     â”‚
â”‚  - ä¸Šä¼ åˆ°OSSï¼Œè·å–è®¿é—®URL                                    â”‚
â”‚  - æ›´æ–°æ¶ˆæ¯è®°å½•çš„ media_url å­—æ®µ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤6: ä¿å­˜åˆ°æ•°æ®åº“                                         â”‚
â”‚  - æ’å…¥ t_wecom_chat_message è¡¨                              â”‚
â”‚  - ä½¿ç”¨ msgId ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œé¿å…é‡å¤                         â”‚
â”‚  - æ‰¹é‡æ’å…¥ï¼ˆæ¯1000æ¡æäº¤ä¸€æ¬¡ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤7: æ›´æ–°åŒæ­¥çŠ¶æ€                                         â”‚
â”‚  - æ›´æ–° t_wecom_sync_status.last_seq                         â”‚
â”‚  - è®°å½• last_sync_time, sync_count                           â”‚
â”‚  - å¦‚æœå¤±è´¥ï¼Œè®°å½• error_msg                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å¢é‡åŒæ­¥ç­–ç•¥

**æ ¸å¿ƒæ€è·¯**: åˆ©ç”¨`seq`åºåˆ—å·å®ç°å¢é‡åŒæ­¥

```java
/**
 * å¢é‡åŒæ­¥å®ç° @author wangxiao
 */
@Transactional(rollbackFor = Exception.class)
public ResponseDTO<Integer> syncChatMessages() {
    // 1. è·å–ä¸Šæ¬¡åŒæ­¥çš„seq
    WecomSyncStatusEntity lastStatus = syncStatusDao.getLastStatus();
    long currentSeq = lastStatus != null ? lastStatus.getLastSeq() : 0;

    int totalCount = 0;
    boolean hasMore = true;

    while (hasMore) {
        // 2. æ‹‰å–æ¶ˆæ¯ï¼ˆæ¯æ¬¡1000æ¡ï¼‰
        String jsonData = financeManager.getChatData(currentSeq, 1000);
        JSONObject jsonObject = JSON.parseObject(jsonData);
        JSONArray chatDataArray = jsonObject.getJSONArray("chatdata");

        if (chatDataArray == null || chatDataArray.isEmpty()) {
            hasMore = false;
            break;
        }

        // 3. æ‰¹é‡å¤„ç†æ¶ˆæ¯
        List<WecomChatMessageEntity> messageList = new ArrayList<>();
        for (int i = 0; i < chatDataArray.size(); i++) {
            JSONObject item = chatDataArray.getJSONObject(i);

            // è§£å¯†å’Œè§£æ
            WecomChatMessageEntity message = processMessage(item);
            messageList.add(message);

            // æ›´æ–°seq
            currentSeq = item.getLong("seq");
        }

        // 4. æ‰¹é‡æ’å…¥æ•°æ®åº“
        chatMessageDao.insertBatch(messageList);
        totalCount += messageList.size();

        // 5. å¼‚æ­¥å¤„ç†åª’ä½“æ–‡ä»¶
        messageList.stream()
            .filter(msg -> needDownloadMedia(msg.getMsgType()))
            .forEach(msg -> mediaManager.downloadAndUpload(
                extractSdkFileId(msg), msg.getMsgId(), msg.getMsgType()));
    }

    // 6. æ›´æ–°åŒæ­¥çŠ¶æ€
    updateSyncStatus(currentSeq, totalCount, true, null);

    return ResponseDTO.ok(totalCount);
}
```

### 5.3 åª’ä½“æ–‡ä»¶å¼‚æ­¥å¤„ç†

**æ ¸å¿ƒæ€è·¯**: å…ˆä¿å­˜æ¶ˆæ¯è®°å½•ï¼Œåª’ä½“æ–‡ä»¶å¼‚æ­¥ä¸‹è½½å’Œä¸Šä¼ 

```java
/**
 * å¼‚æ­¥ä¸‹è½½å¹¶ä¸Šä¼ åª’ä½“æ–‡ä»¶ @author wangxiao
 */
@Async("wecomExecutor")
public CompletableFuture<String> downloadAndUpload(
        String sdkFileId, String msgId, String msgType) {

    try {
        // 1. ä¸‹è½½æ–‡ä»¶
        byte[] fileData = financeManager.getMediaData(sdkFileId, "");

        // 2. ç”Ÿæˆå­˜å‚¨è·¯å¾„
        String filePath = generateFilePath(msgId, msgType);

        // 3. ä¸Šä¼ åˆ°OSS
        String ossUrl = ossService.upload(fileData, filePath);

        // 4. æ›´æ–°æ¶ˆæ¯è®°å½•çš„media_url
        chatMessageDao.updateMediaUrl(msgId, ossUrl, fileData.length);

        return CompletableFuture.completedFuture(ossUrl);
    } catch (Exception e) {
        log.error("ä¸‹è½½åª’ä½“æ–‡ä»¶å¤±è´¥ï¼ŒmsgId={}, sdkFileId={}", msgId, sdkFileId, e);
        return CompletableFuture.failedFuture(e);
    }
}
```

### 5.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

| ä¼˜åŒ–é¡¹ | ç­–ç•¥ | æ•ˆæœ |
|-------|------|------|
| **æ‰¹é‡æ’å…¥** | æ¯1000æ¡æ¶ˆæ¯æ‰¹é‡æ’å…¥æ•°æ®åº“ | å‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•° |
| **å¼‚æ­¥å¤„ç†** | åª’ä½“æ–‡ä»¶å¼‚æ­¥ä¸‹è½½å’Œä¸Šä¼  | ä¸é˜»å¡æ¶ˆæ¯åŒæ­¥æµç¨‹ |
| **è¿æ¥æ± ** | ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†å¼‚æ­¥ä»»åŠ¡ | æ§åˆ¶å¹¶å‘æ•°ï¼Œé¿å…èµ„æºè€—å°½ |
| **é™æµæ§åˆ¶** | é™åˆ¶æ¯ç§’APIè°ƒç”¨æ¬¡æ•° | é¿å…è§¦å‘ä¼ä¸šå¾®ä¿¡APIé™æµ |
| **æ–­ç‚¹ç»­ä¼ ** | ä¿å­˜last_seqå®ç°æ–­ç‚¹ç»­ä¼  | åŒæ­¥ä¸­æ–­åå¯ç»§ç»­ |
| **é‡è¯•æœºåˆ¶** | å¤±è´¥æ—¶æŒ‡æ•°é€€é¿é‡è¯• | æé«˜åŒæ­¥æˆåŠŸç‡ |

### 5.5 é”™è¯¯å¤„ç†å’Œç›‘æ§

```java
/**
 * åŒæ­¥å¤±è´¥å¤„ç† @author wangxiao
 */
private void handleSyncError(Exception e, long currentSeq, int totalCount) {
    log.error("åŒæ­¥èŠå¤©è®°å½•å¤±è´¥ï¼Œseq={}, count={}", currentSeq, totalCount, e);

    // 1. è®°å½•å¤±è´¥çŠ¶æ€
    updateSyncStatus(currentSeq, totalCount, false, e.getMessage());

    // 2. å‘é€å‘Šè­¦é€šçŸ¥
    alarmService.sendAlarm("ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯åŒæ­¥å¤±è´¥", e.getMessage());

    // 3. æŒ‡æ•°é€€é¿é‡è¯•
    retryTemplate.execute(context -> {
        return syncChatMessages();
    });
}
```

---

## 6. éƒ¨ç½²æ¶æ„

### 6.1 æœåŠ¡å™¨éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è´Ÿè½½å‡è¡¡ (Nginx)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  WebæœåŠ¡å™¨1        â”‚   â”‚  WebæœåŠ¡å™¨2       â”‚
       â”‚  (å‰ç«¯é™æ€èµ„æº)    â”‚   â”‚  (å‰ç«¯é™æ€èµ„æº)   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚       åº”ç”¨æœåŠ¡å™¨é›†ç¾¤                 â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
       â”‚  â”‚  App1       â”‚  â”‚  App2       â”‚  â”‚
       â”‚  â”‚  (Java17)   â”‚  â”‚  (Java17)   â”‚  â”‚
       â”‚  â”‚  SpringBoot â”‚  â”‚  SpringBoot â”‚  â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                      â”‚
  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  MySQL  â”‚  â”‚  Redis â”‚  â”‚  OSS/MinIO â”‚   â”‚
  â”‚  ä¸»ä»   â”‚  â”‚  é›†ç¾¤  â”‚  â”‚  å¯¹è±¡å­˜å‚¨  â”‚   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   ä¼ä¸šå¾®ä¿¡æœåŠ¡å™¨          â”‚
       â”‚   (ä¼šè¯å­˜æ¡£API)          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Dockeréƒ¨ç½²é…ç½®

**Dockerfile**:
```dockerfile
FROM openjdk:17-jdk-slim

# å®‰è£…åŸç”Ÿåº“ä¾èµ–
RUN apt-get update && apt-get install -y libstdc++6

# å¤åˆ¶åº”ç”¨
COPY target/sa-admin.jar /app/sa-admin.jar
COPY src/main/resources/wecom/libWeWorkFinanceSdk_Java.so /app/lib/

# é…ç½®åº“è·¯å¾„
ENV LD_LIBRARY_PATH=/app/lib:$LD_LIBRARY_PATH

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", "-jar", "/app/sa-admin.jar"]
```

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  # åç«¯åº”ç”¨
  app:
    build: .
    ports:
      - "1024:1024"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - WECOM_CORPID=${WECOM_CORPID}
      - WECOM_SECRET=${WECOM_SECRET}
    volumes:
      - ./logs:/app/logs
    depends_on:
      - mysql
      - redis

  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=smart_admin
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

volumes:
  mysql-data:
  redis-data:
  minio-data:
```

### 6.3 ç›‘æ§å’Œå‘Šè­¦

**ç›‘æ§æŒ‡æ ‡**:
- åŒæ­¥ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€å’Œè€—æ—¶
- æ¶ˆæ¯åŒæ­¥æ•°é‡å’Œå¤±è´¥ç‡
- åª’ä½“æ–‡ä»¶ä¸‹è½½æˆåŠŸç‡
- APIè°ƒç”¨QPSå’Œå“åº”æ—¶é—´
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- æœåŠ¡å™¨CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡

**å‘Šè­¦è§„åˆ™**:
- åŒæ­¥ä»»åŠ¡è¿ç»­3æ¬¡å¤±è´¥ â†’ å‘é€å‘Šè­¦
- æ¶ˆæ¯åŒæ­¥å»¶è¿Ÿè¶…è¿‡1å°æ—¶ â†’ å‘é€å‘Šè­¦
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡>90% â†’ å‘é€å‘Šè­¦
- æœåŠ¡å™¨CPUä½¿ç”¨ç‡>80% â†’ å‘é€å‘Šè­¦

---

## 7. é™„å½•

### 7.1 æ¶ˆæ¯ç±»å‹å®Œæ•´åˆ—è¡¨

| msgtype | è¯´æ˜ | æ˜¯å¦éœ€è¦ä¸‹è½½åª’ä½“ |
|---------|------|-----------------|
| text | æ–‡æœ¬æ¶ˆæ¯ | å¦ |
| image | å›¾ç‰‡æ¶ˆæ¯ | æ˜¯ |
| revoke | æ’¤å›æ¶ˆæ¯ | å¦ |
| agree | åŒæ„ä¼šè¯èŠå¤©å†…å®¹ | å¦ |
| disagree | ä¸åŒæ„ä¼šè¯èŠå¤©å†…å®¹ | å¦ |
| voice | è¯­éŸ³æ¶ˆæ¯ | æ˜¯ |
| video | è§†é¢‘æ¶ˆæ¯ | æ˜¯ |
| card | åç‰‡æ¶ˆæ¯ | å¦ |
| location | ä½ç½®æ¶ˆæ¯ | å¦ |
| emotion | è¡¨æƒ…æ¶ˆæ¯ | å¦ |
| file | æ–‡ä»¶æ¶ˆæ¯ | æ˜¯ |
| link | é“¾æ¥æ¶ˆæ¯ | å¦ |
| weapp | å°ç¨‹åºæ¶ˆæ¯ | å¦ |
| chatrecord | ä¼šè¯è®°å½•æ¶ˆæ¯ | å¦ |
| todo | å¾…åŠæ¶ˆæ¯ | å¦ |
| vote | æŠ•ç¥¨æ¶ˆæ¯ | å¦ |
| collect | å¡«è¡¨æ¶ˆæ¯ | å¦ |
| redpacket | çº¢åŒ…æ¶ˆæ¯ | å¦ |
| meeting | ä¼šè®®é‚€è¯·æ¶ˆæ¯ | å¦ |
| docmsg | åœ¨çº¿æ–‡æ¡£æ¶ˆæ¯ | å¦ |
| markdown | MarkDownæ ¼å¼æ¶ˆæ¯ | å¦ |
| news | å›¾æ–‡æ¶ˆæ¯ | å¦ |
| calendar | æ—¥ç¨‹æ¶ˆæ¯ | å¦ |
| mixed | æ··åˆæ¶ˆæ¯ | å¯èƒ½ |
| meeting_voice_call | éŸ³é¢‘å­˜æ¡£æ¶ˆæ¯ | æ˜¯ |
| voip_doc_share | éŸ³é¢‘å…±äº«æ–‡æ¡£æ¶ˆæ¯ | æ˜¯ |
| external_redpacket | äº’é€šçº¢åŒ…æ¶ˆæ¯ | å¦ |
| sphfeed | è§†é¢‘å·æ¶ˆæ¯ | å¦ |

### 7.2 é”™è¯¯ç å®šä¹‰

| é”™è¯¯ç  | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|-------|------|---------|
| 0 | æˆåŠŸ | - |
| -1 | ç³»ç»Ÿå¤±è´¥ | é‡è¯• |
| 10000 | å‚æ•°é”™è¯¯ | æ£€æŸ¥å‚æ•° |
| 10001 | ç½‘ç»œé”™è¯¯ | é‡è¯• |
| 10002 | æ•°æ®è§£æå¤±è´¥ | æ£€æŸ¥æ•°æ®æ ¼å¼ |
| 10003 | å…¬å¸æœªå¼€å¯ä¼šè¯å­˜æ¡£ | è”ç³»ç®¡ç†å‘˜å¼€é€š |
| 10004 | æœªæ‰¾åˆ°secret | æ£€æŸ¥é…ç½® |
| 10005 | æœªæ‰¾åˆ°ç§é’¥ | æ£€æŸ¥ç§é’¥é…ç½® |
| 10006 | è§£å¯†å¤±è´¥ | æ£€æŸ¥ç§é’¥ç‰ˆæœ¬ |
| 10007 | æ‰¾ä¸åˆ°æ¶ˆæ¯åŠ å¯†ç‰ˆæœ¬ | æ›´æ–°SDK |
| 10008 | è§£æencrypt_keyå‡ºé”™ | æ£€æŸ¥æ¶ˆæ¯æ ¼å¼ |
| 10009 | IPéæ³• | æ·»åŠ æœåŠ¡å™¨IPåˆ°ç™½åå• |
| 10010 | æ•°æ®è¿‡æœŸ | é‡æ–°æ‹‰å– |

### 7.3 æœ€ä½³å®è·µå»ºè®®

1. **æƒé™é…ç½®**:
   - ä»…æˆæƒå¿…è¦çš„ç®¡ç†å‘˜æŸ¥çœ‹ä¼šè¯å­˜æ¡£
   - æ•æ„Ÿå­—æ®µï¼ˆå¦‚æ‰‹æœºå·ã€èº«ä»½è¯ï¼‰éœ€è„±æ•å¤„ç†
   - å®šæœŸå®¡è®¡è®¿é—®æ—¥å¿—

2. **æ€§èƒ½ä¼˜åŒ–**:
   - å®šæœŸå½’æ¡£å†å²æ•°æ®ï¼ˆå¦‚6ä¸ªæœˆå‰çš„æ•°æ®ï¼‰
   - ä½¿ç”¨æ•°æ®åº“åˆ†åŒºè¡¨ä¼˜åŒ–æŸ¥è¯¢
   - çƒ­ç‚¹æ•°æ®ä½¿ç”¨Redisç¼“å­˜

3. **æ•°æ®å¤‡ä»½**:
   - æ¯å¤©è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
   - é‡è¦åª’ä½“æ–‡ä»¶å¯ç”¨OSSå¤šåŒºåŸŸå¤‡ä»½
   - å®šæœŸæµ‹è¯•æ•°æ®æ¢å¤æµç¨‹

4. **åˆè§„è¦æ±‚**:
   - ç­¾ç½²ã€Šä¼šè¯å­˜æ¡£ç¡®è®¤å‡½ã€‹
   - å‘˜å·¥çŸ¥æƒ…å¹¶åŒæ„
   - ä»…ç”¨äºåˆè§„ç›‘ç®¡ï¼Œä¸å¾—æ»¥ç”¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-10-04
**è®¾è®¡äººå‘˜**: wangxiao
**ä¼ä¸š**: å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€
