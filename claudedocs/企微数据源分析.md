---
title: ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£æ•°æ®æ¥æºåˆ†æ
author: wangxiao
company: å­åˆçº¿é«˜ç§‘æ™ºèƒ½ç§‘æŠ€
date: 2025-10-14
permalink: claudedocs/ä¼å¾®æ•°æ®æºåˆ†æ
---

# ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£æ•°æ®æ¥æºåˆ†æ

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ä¼ä¸šå¾®ä¿¡APIç›´æ¥æä¾›çš„æ•°æ®](#ä¼ä¸šå¾®ä¿¡apiç›´æ¥æä¾›çš„æ•°æ®)
3. [éœ€è¦è‡ªè¡Œè®¡ç®—å’Œæ•´ç†çš„æ•°æ®](#éœ€è¦è‡ªè¡Œè®¡ç®—å’Œæ•´ç†çš„æ•°æ®)
4. [æ•°æ®è·å–æµç¨‹](#æ•°æ®è·å–æµç¨‹)
5. [æ•°æ®åŒæ­¥ç­–ç•¥](#æ•°æ®åŒæ­¥ç­–ç•¥)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹ç…§æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆå’Œä¼ä¸šå¾®ä¿¡å®˜æ–¹APIæ–‡æ¡£ï¼Œåˆ†ææ¯ä¸ªå­—æ®µçš„æ•°æ®æ¥æºï¼Œæ˜ç¡®å“ªäº›æ•°æ®å¯ä»¥ç›´æ¥ä»ä¼ä¸šå¾®ä¿¡APIè·å–ï¼Œå“ªäº›éœ€è¦æˆ‘ä»¬è‡ªè¡Œè®¡ç®—å’Œæ•´ç†ã€‚

**å‚è€ƒæ–‡æ¡£**:
- ä¼ä¸šå¾®ä¿¡ä¼šè¯å­˜æ¡£API: https://developer.work.weixin.qq.com/document/path/91774
- è·å–å®¢æˆ·è¯¦æƒ…API: https://developer.work.weixin.qq.com/document/path/92994
- è·å–å®¢æˆ·ç¾¤è¯¦æƒ…API: https://developer.work.weixin.qq.com/document/path/92707
- è·å–éƒ¨é—¨æˆå‘˜è¯¦æƒ…API: https://developer.work.weixin.qq.com/document/path/90196

---

## ä¼ä¸šå¾®ä¿¡APIç›´æ¥æä¾›çš„æ•°æ®

### 1. é…ç½®ç®¡ç†è¡¨ (t_wecom_corp_config)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | ä¼ä¸šIDï¼Œåˆ›å»ºä¼ä¸šæ—¶è·å– |
| corp_name | âœ… ä¼å¾®API | è·å–ä¼ä¸šä¿¡æ¯ | ä¼ä¸šåç§° |
| agent_secret | âš™ï¸ ç®¡ç†å‘˜é…ç½® | ç®¡ç†åå° | åº”ç”¨Secretï¼Œéœ€ç®¡ç†å‘˜æ‰‹åŠ¨é…ç½® |
| chat_secret | âš™ï¸ ç®¡ç†å‘˜é…ç½® | ç®¡ç†åå° | ä¼šè¯å­˜æ¡£Secretï¼Œéœ€å¼€é€šä¼šè¯å­˜æ¡£åŠŸèƒ½åé…ç½® |
| chat_public_key_ver | âš™ï¸ ç®¡ç†å‘˜é…ç½® | ç®¡ç†åå° | RSAå…¬é’¥ç‰ˆæœ¬ï¼Œç®¡ç†åå°è·å– |
| chat_seq | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | æ–­ç‚¹ç»­ä¼  | æ¶ˆæ¯æ‹‰å–æ¸¸æ ‡ï¼Œæ¯æ¬¡æ‹‰å–åæ›´æ–° |
| chat_pull_status | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ç³»ç»ŸçŠ¶æ€ | æ‹‰å–çŠ¶æ€ï¼Œç³»ç»Ÿè¿è¡Œæ—¶ç»´æŠ¤ |
| last_pull_time | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ç³»ç»Ÿæ—¶é—´ | æœ€åæ‹‰å–æ—¶é—´ |
| last_error_msg | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | å¼‚å¸¸å¤„ç† | é”™è¯¯ä¿¡æ¯è®°å½• |

---

### 2. ä¼šè¯ç®¡ç†è¡¨

#### t_wecom_conversation (ä¼šè¯ä¸»è¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| conversation_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | æ¥è‡ªé…ç½® |
| conversation_type | ğŸ“ **è‡ªè¡Œè®¡ç®—** | roomidåˆ¤æ–­ | é€šè¿‡roomidæ˜¯å¦ä¸ºç©ºåˆ¤æ–­ï¼šç©º=å•èŠï¼Œéç©º=ç¾¤èŠ |
| room_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `roomid`å­—æ®µï¼Œç¾¤èŠæ—¶æœ‰å€¼ |
| room_name | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | è°ƒç”¨ç¾¤è¯¦æƒ…APIè·å–ï¼š`GET /cgi-bin/externalcontact/groupchat/get` |
| participant_count | ğŸ“ **è‡ªè¡Œè®¡ç®—** | å…³ç³»è¡¨ç»Ÿè®¡ | `SELECT COUNT(*) FROM t_wecom_conversation_participant WHERE conversation_id=?` |
| customer_count | ğŸ“ **è‡ªè¡Œè®¡ç®—** | å…³ç³»è¡¨ç»Ÿè®¡ | `SELECT COUNT(*) FROM t_wecom_conversation_participant WHERE conversation_id=? AND participant_type=1` |
| last_msg_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | æœ€æ–°æ¶ˆæ¯ | æ¯æ¡æ¶ˆæ¯æ’å…¥æ—¶æ›´æ–° |
| last_msg_type | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | æœ€æ–°æ¶ˆæ¯ | æ¯æ¡æ¶ˆæ¯æ’å…¥æ—¶æ›´æ–° |
| last_msg_content | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | æœ€æ–°æ¶ˆæ¯ | æ¯æ¡æ¶ˆæ¯æ’å…¥æ—¶æ›´æ–°ï¼ˆæå–æ‘˜è¦ï¼‰ |
| last_msg_time | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | æœ€æ–°æ¶ˆæ¯ | æ¯æ¡æ¶ˆæ¯æ’å…¥æ—¶æ›´æ–° |
| last_msg_sender_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | æœ€æ–°æ¶ˆæ¯ | æ¯æ¡æ¶ˆæ¯æ’å…¥æ—¶æ›´æ–° |
| last_msg_sender_name | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | æœ€æ–°æ¶ˆæ¯ | æ¯æ¡æ¶ˆæ¯æ’å…¥æ—¶æ›´æ–° |
| msg_count | ğŸ“ **è‡ªè¡Œè®¡ç®—** | æ¶ˆæ¯ç»Ÿè®¡ | å®šæœŸç»Ÿè®¡æˆ–æ¯æ¬¡æ’å…¥æ—¶å¢é‡æ›´æ–° |

**ä¼šè¯åˆ›å»ºé€»è¾‘**:
```
æ¥æ”¶æ¶ˆæ¯ â†’ åˆ¤æ–­ä¼šè¯ç±»å‹
â”œâ”€ roomidä¸ä¸ºç©º? â†’ ç¾¤èŠ
â”‚   â””â”€ æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨ä¼šè¯ (corp_id + roomid)
â”‚       â”œâ”€ å­˜åœ¨ â†’ ä½¿ç”¨ç°æœ‰ä¼šè¯
â”‚       â””â”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ä¼šè¯
â””â”€ roomidä¸ºç©º? â†’ å•èŠ
    â””â”€ æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨ä¼šè¯ (from + toå‚ä¸æ–¹ç»„åˆ)
        â”œâ”€ å­˜åœ¨ â†’ ä½¿ç”¨ç°æœ‰ä¼šè¯
        â””â”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ä¼šè¯
```

---

#### t_wecom_conversation_participant (ä¼šè¯å‚ä¸æ–¹å…³ç³»è¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| conversation_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | å…³è”ä¼šè¯ | åˆ›å»ºä¼šè¯æ—¶ç”Ÿæˆ |
| participant_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `from`å­—æ®µæˆ–`tolist`æ•°ç»„ä¸­çš„å€¼ |
| participant_type | ğŸ“ **è‡ªè¡Œåˆ¤æ–­** | IDç±»å‹è¯†åˆ« | é€šè¿‡IDæ ¼å¼åˆ¤æ–­ï¼šä»¥`wm`å¼€å¤´=å®¢æˆ·(external_userid)ï¼Œå¦åˆ™=å‘˜å·¥(userid) |
| participant_name | âœ… ä¼å¾®API | æˆå‘˜/å®¢æˆ·è¯¦æƒ… | å‘˜å·¥ï¼šè·å–æˆå‘˜APIï¼›å®¢æˆ·ï¼šè·å–å¤–éƒ¨è”ç³»äººè¯¦æƒ…API |
| relation_start_time | âœ… ä¼å¾®API + ğŸ“ è‡ªè¡Œç»´æŠ¤ | ç¾¤èŠ=ç¾¤API, å•èŠ=é¦–æ¡æ¶ˆæ¯æ—¶é—´ | ç¾¤èŠä»ç¾¤è¯¦æƒ…APIè·å–å…¥ç¾¤æ—¶é—´ï¼›å•èŠä½¿ç”¨é¦–æ¡æ¶ˆæ¯æ—¶é—´ |
| relation_end_time | âœ… ä¼å¾®API + ğŸ“ è‡ªè¡Œç»´æŠ¤ | ç¾¤å˜æ›´é€šçŸ¥ | ç›‘å¬ç¾¤æˆå‘˜å˜æ›´äº‹ä»¶ï¼ˆé€€ç¾¤/åˆ å¥½å‹ï¼‰ |
| is_active | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | relation_end_timeåˆ¤æ–­ | relation_end_timeä¸ºNULL=æ´»è·ƒï¼Œå¦åˆ™=å·²ç»“æŸ |

**å‚ä¸æ–¹è¯†åˆ«é€»è¾‘**:
```
ä¼å¾®APIè¿”å›çš„IDæ ¼å¼ï¼š
- å‘˜å·¥UserID: é€šå¸¸æ˜¯å­—æ¯æ•°å­—ç»„åˆï¼Œå¦‚ "ZhangSan", "rocky"
- å®¢æˆ·ExternalUserID: å›ºå®šæ ¼å¼ "wm" + éšæœºå­—ç¬¦ï¼Œå¦‚ "wm9aOJEQAA9NK4WrSkDlxwOjur5wbh3g"

åˆ¤æ–­é€»è¾‘:
if (id.startsWith("wm")) {
    participant_type = 1; // å®¢æˆ·
} else {
    participant_type = 2; // å‘˜å·¥
}
```

---

### 3. æ¶ˆæ¯ç®¡ç†è¡¨

#### t_wecom_message (æ¶ˆæ¯ä¸»è¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| message_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| msg_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `msgid`å­—æ®µï¼Œå”¯ä¸€æ ‡è¯† |
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | æ¥è‡ªé…ç½® |
| seq | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `seq`å­—æ®µï¼ŒSDKè¿”å›çš„åºå· |
| msg_type | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `msgtype`å­—æ®µï¼štext/image/voice/video/fileç­‰ |
| msg_action | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `action`å­—æ®µï¼šsend/recall/switch |
| from_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `from`å­—æ®µ |
| from_type | ğŸ“ **è‡ªè¡Œåˆ¤æ–­** | IDç±»å‹è¯†åˆ« | åŒparticipant_typeåˆ¤æ–­é€»è¾‘ |
| from_name | âœ… ä¼å¾®API | æˆå‘˜/å®¢æˆ·è¯¦æƒ… | æ ¹æ®from_idæŸ¥è¯¢å§“å |
| to_list | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `tolist`å­—æ®µï¼ŒJSONæ•°ç»„ |
| room_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `roomid`å­—æ®µ |
| msg_time | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `msgtime`å­—æ®µï¼ŒUTCæ—¶é—´æˆ³ï¼ˆéœ€è½¬æ¢ï¼‰ |
| msg_content | âœ… ä¼å¾®API + ğŸ“ æå– | æ¶ˆæ¯ä½“ | æ–‡æœ¬ï¼š`text.content`ï¼›å…¶ä»–ï¼šä»raw_contentæå–æ‘˜è¦ |
| raw_content | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | å®Œæ•´çš„æ¶ˆæ¯JSONï¼ˆè§£å¯†åï¼‰ |
| public_key_ver | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `publickey_ver`å­—æ®µ |

**ä¼å¾®APIæ¶ˆæ¯ä½“ç¤ºä¾‹**:
```json
{
  "msgid": "CAQQluDa4QUY0On2rYSAgAMgzPrShAE=",
  "action": "send",
  "from": "rocky",
  "tolist": ["wm9aOJEQAA9NK4WrSkDlxwOjur5wbh3g"],
  "roomid": "",
  "msgtime": 1672887257478,
  "msgtype": "text",
  "seq": 1000012345,
  "text": {
    "content": "ä½ å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ"
  }
}
```

---

#### t_wecom_message_conversation (æ¶ˆæ¯ä¼šè¯å…³è”è¡¨) â­æ ¸å¿ƒ

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| msg_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `msgid`å­—æ®µ |
| message_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | å…³è”æ¶ˆæ¯è¡¨ | æ’å…¥æ¶ˆæ¯åè·å– |
| conversation_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | å…³è”ä¼šè¯è¡¨ | æ ¹æ®from/tolist/roomidæŸ¥è¯¢æˆ–åˆ›å»º |
| from_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `from`å­—æ®µï¼ˆå†—ä½™ï¼‰ |
| to_id | ğŸ“ **è‡ªè¡Œè®¡ç®—** | æ¶ˆæ¯ä½“æå– | **æ ¸å¿ƒå­—æ®µ**ï¼šå•èŠ=tolist[0]ï¼Œç¾¤èŠ=roomid |
| route_type | ğŸ“ **è‡ªè¡Œè®¡ç®—** | roomidåˆ¤æ–­ | roomidä¸ºç©º=1(å•èŠ)ï¼Œå¦åˆ™=2(ç¾¤èŠ) |

**to_idè®¡ç®—é€»è¾‘** â­â­â­:
```java
// ç¾¤èŠæ¶ˆæ¯
if (!roomid.isEmpty()) {
    to_id = roomid;  // ç¾¤èŠæ—¶ï¼Œto_id = roomid
    route_type = 2;
    // ç”Ÿæˆ1æ¡å…³è”è®°å½•
}
// å•èŠæ¶ˆæ¯
else {
    to_id = tolist[0];  // å•èŠæ—¶ï¼Œto_id = æ¥æ”¶æ–¹UserID
    route_type = 1;
    // ç”Ÿæˆ1æ¡å…³è”è®°å½•
}

// ç¾¤å‘æ¶ˆæ¯ï¼ˆå¤šä¸ªæ¥æ”¶è€…ï¼‰
if (tolist.length > 1) {
    for (String to : tolist) {
        to_id = to;  // æ¯ä¸ªæ¥æ”¶è€…ä¸€æ¡å…³è”è®°å½•
        route_type = 1;
        // ç”ŸæˆNæ¡å…³è”è®°å½•
    }
}
```

**æ•°æ®æµè½¬ç¤ºä¾‹**:
```
åœºæ™¯1ï¼šç¾¤èŠæ¶ˆæ¯
ä¼å¾®API â†’ {"from":"rocky", "roomid":"room123", "tolist":[...]}
â†’ 1æ¡å…³è”è®°å½•: to_id="room123", route_type=2

åœºæ™¯2ï¼šå•èŠæ¶ˆæ¯
ä¼å¾®API â†’ {"from":"rocky", "tolist":["zhangsan"], "roomid":""}
â†’ 1æ¡å…³è”è®°å½•: to_id="zhangsan", route_type=1

åœºæ™¯3ï¼šç¾¤å‘æ¶ˆæ¯
ä¼å¾®API â†’ {"from":"rocky", "tolist":["zhangsan","lisi","wangwu"], "roomid":""}
â†’ 3æ¡å…³è”è®°å½•:
   - to_id="zhangsan", route_type=1
   - to_id="lisi", route_type=1
   - to_id="wangwu", route_type=1
```

---

#### t_wecom_message_media (ä¼šè¯åª’ä½“æ–‡ä»¶è¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| media_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| message_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | å…³è”æ¶ˆæ¯è¡¨ | æ’å…¥æ¶ˆæ¯åè·å– |
| msg_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `msgid`å­—æ®µ |
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | æ¥è‡ªé…ç½® |
| media_type | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `msgtype`å­—æ®µï¼ˆimage/voice/video/file/emotionï¼‰ |
| sdk_file_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `image.sdkfileid` æˆ– `voice.sdkfileid` ç­‰ |
| md5sum | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `image.md5sum` æˆ– `file.md5sum` ç­‰ |
| file_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | æ–‡ä»¶ä¸‹è½½å | ä¸‹è½½æ–‡ä»¶åæ’å…¥t_fileè¡¨è·å– |
| thumbnail_file_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ç¼©ç•¥å›¾ä¸‹è½½å | å›¾ç‰‡/è§†é¢‘æœ‰ç¼©ç•¥å›¾ |
| file_name | âœ… ä¼å¾®API + ğŸ“ ç”Ÿæˆ | æ¶ˆæ¯ä½“æˆ–ç”Ÿæˆ | æ–‡ä»¶ï¼š`file.filename`ï¼›å…¶ä»–ï¼šè‡ªè¡Œç”Ÿæˆï¼ˆå¦‚`image_20250108.jpg`ï¼‰ |
| file_ext | âœ… ä¼å¾®API + ğŸ“ æå– | æ¶ˆæ¯ä½“æˆ–æå– | æ–‡ä»¶ï¼š`file.fileext`ï¼›å…¶ä»–ï¼šä»sdkfileidæˆ–æ–‡ä»¶åæå– |
| file_size | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `image.filesize` æˆ– `file.filesize` ç­‰ |
| duration | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `voice.play_length` æˆ– `video.play_length`ï¼ˆç§’ï¼‰ |
| width | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `image.width` æˆ– `video.width` |
| height | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `image.height` æˆ– `video.height` |
| download_status | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ä¸‹è½½æµç¨‹ | 0-å¾…ä¸‹è½½ 1-ä¸‹è½½ä¸­ 2-å·²ä¸‹è½½ 3-å¤±è´¥ |
| download_time | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ä¸‹è½½å®Œæˆæ—¶é—´ | ç³»ç»Ÿæ—¶é—´ |
| download_error_msg | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ä¸‹è½½å¼‚å¸¸ | é”™è¯¯ä¿¡æ¯è®°å½• |

**ä¼å¾®APIåª’ä½“æ¶ˆæ¯ç¤ºä¾‹**:
```json
// å›¾ç‰‡æ¶ˆæ¯
{
  "msgtype": "image",
  "image": {
    "sdkfileid": "CtYBMzA5NDcwMjAxNDAzMjMz...",
    "md5sum": "50de8e5ae8ffe4f1df7a93841f71993a",
    "filesize": 70961,
    "width": 1920,
    "height": 1080
  }
}

// è¯­éŸ³æ¶ˆæ¯
{
  "msgtype": "voice",
  "voice": {
    "sdkfileid": "CtYBMzA5NDcwMjAxNDAzMjMz...",
    "md5sum": "a1b2c3d4e5f6...",
    "filesize": 50000,
    "play_length": 30  // 30ç§’
  }
}

// æ–‡ä»¶æ¶ˆæ¯
{
  "msgtype": "file",
  "file": {
    "filename": "é¡¹ç›®æ–‡æ¡£.pdf",
    "fileext": "pdf",
    "sdkfileid": "CtYBMzA5NDcwMjAxNDAzMjMz...",
    "md5sum": "e5b6d8e3f2a9c7d1b4e8f9a1c2d3e4f5",
    "filesize": 2048576
  }
}
```

**åª’ä½“æ–‡ä»¶ä¸‹è½½æµç¨‹**:
```
1. è§£ææ¶ˆæ¯ï¼Œæå–sdkfileid
2. è°ƒç”¨ä¼å¾®APIä¸‹è½½æ–‡ä»¶: GET /cgi-bin/media/get?access_token=ACCESS_TOKEN&sdkfileid={sdkfileid}
3. ä¿å­˜æ–‡ä»¶åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆæˆ–äº‘å­˜å‚¨ï¼‰
4. æ’å…¥t_fileè¡¨ï¼Œè·å–file_id
5. æ›´æ–°t_wecom_message_mediaçš„file_idå’Œdownload_status
```

---

### 4. å‚ä¸æ–¹ä¿¡æ¯è¡¨

#### t_wecom_staff (å‘˜å·¥è¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| staff_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | æ¥è‡ªé…ç½® |
| wecom_user_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“ | `from`å­—æ®µæˆ–`tolist`ä¸­çš„å‘˜å·¥ID |
| name | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `GET /cgi-bin/user/get?userid={userid}` â†’ `name`å­—æ®µ |
| alias | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `alias`å­—æ®µ |
| mobile | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `mobile`å­—æ®µ |
| position | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `position`å­—æ®µ |
| gender | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `gender`å­—æ®µï¼š0-æœªå®šä¹‰ 1-ç”· 2-å¥³ |
| avatar | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `avatar`å­—æ®µï¼ˆå¤´åƒURLï¼‰ |
| department | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `department`å­—æ®µï¼ˆJSONæ•°ç»„ï¼‰ |
| status | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `status`å­—æ®µï¼š1-å·²æ¿€æ´» 2-å·²ç¦ç”¨ 4-æœªæ¿€æ´» 5-å·²ç¦»èŒ |
| enable_chat_archive_flag | âœ… ä¼å¾®API | è·å–æˆå‘˜è¯¦æƒ… | `enable_msgaudit`å­—æ®µï¼ˆæ˜¯å¦å¼€å¯ä¼šè¯å­˜æ¡£ï¼‰ |
| has_conversation_flag | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ä¼šè¯ç»Ÿè®¡ | æ˜¯å¦æœ‰ä¼šè¯è®°å½•ï¼ˆæŸ¥è¯¢æ˜¯å¦æœ‰å‚ä¸çš„ä¼šè¯ï¼‰ |

**ä¼å¾®API - è·å–æˆå‘˜IDåˆ—è¡¨** (æ¨èé¦–é€‰):
```bash
POST https://qyapi.weixin.qq.com/cgi-bin/user/list_id?access_token=ACCESS_TOKEN
Content-Type: application/json
{}

å“åº”ç¤ºä¾‹:
{
  "errcode": 0,
  "errmsg": "ok",
  "dept_user": [
    {"userid": "HuJie", "department": 11},
    {"userid": "WangXiao", "department": 43},
    {"userid": "ZhangSan", "department": 1}
  ]
}
```

**ä¼˜åŠ¿**:
- âœ… é€šè®¯å½•åŒæ­¥åŠ©æ‰‹Secretå¯ç”¨
- âœ… ä¸€æ¬¡æ€§è·å–æ‰€æœ‰æˆå‘˜UserIDå’Œéƒ¨é—¨ä¿¡æ¯
- âœ… ä¸éœ€è¦åˆ›å»ºè‡ªå»ºåº”ç”¨æƒé™

**é™åˆ¶**:
- âš ï¸ åªè¿”å›UserIDå’Œéƒ¨é—¨ID,ä¸åŒ…å«å§“åç­‰è¯¦ç»†ä¿¡æ¯
- âš ï¸ éœ€è¦é…åˆ `/user/get` APIè·å–è¯¦ç»†ä¿¡æ¯

---

**ä¼å¾®API - è·å–æˆå‘˜è¯¦æƒ…**:
```bash
GET https://qyapi.weixin.qq.com/cgi-bin/user/get?access_token=ACCESS_TOKEN&userid=zhangsan

å“åº”ç¤ºä¾‹:
{
  "errcode": 0,
  "errmsg": "ok",
  "userid": "zhangsan",
  "name": "å¼ ä¸‰",
  "alias": "jackzhang",
  "mobile": "13800000000",
  "position": "äº§å“ç»ç†",
  "gender": "1",
  "avatar": "http://wx.qlogo.cn/xxx",
  "department": [1, 2],
  "status": 1,
  "enable_msgaudit": 1
}
```

**æƒé™è¦æ±‚**:
- âš ï¸ éœ€è¦è‡ªå»ºåº”ç”¨Secretæˆ–æœ‰å®Œæ•´é€šè®¯å½•ç®¡ç†æƒé™çš„Secret
- âŒ é€šè®¯å½•åŒæ­¥åŠ©æ‰‹Secretä¸æ”¯æŒæ­¤API

---

#### t_wecom_staff_customer_relation (å‘˜å·¥-å®¢æˆ·å…³ç³»è¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| relation_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | æ¥è‡ªé…ç½® |
| wecom_staff_user_id | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user`æ•°ç»„ä¸­çš„`userid` |
| wecom_external_user_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“æˆ–åˆ—è¡¨ | `external_userid` |
| staff_remark | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].remark`ï¼ˆå‘˜å·¥å¤‡æ³¨åï¼‰ |
| staff_description | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].description` |
| add_way | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].add_way`ï¼ˆæ·»åŠ æ¥æºï¼‰ |
| add_time | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].createtime`ï¼ˆæ—¶é—´æˆ³ï¼Œéœ€è½¬æ¢ï¼‰ |
| state | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].state`ï¼ˆæ¥æºæ¸ é“å‚æ•°ï¼‰ |
| remark_corp_name | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].remark_corp_name` |
| remark_mobiles | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].remark_mobiles`ï¼ˆJSONæ•°ç»„ï¼‰ |
| tags | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].tags`ï¼ˆJSONæ•°ç»„ï¼ŒåŒ…å«ä¼ä¸šæ ‡ç­¾å’Œä¸ªäººæ ‡ç­¾ï¼‰ |
| relation_status | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `follow_user[].status`ï¼ˆ0-å·²åˆ é™¤ 1-æ­£å¸¸ï¼‰ |

**ä¼å¾®API - è·å–å®¢æˆ·è¯¦æƒ…**:
```bash
POST https://qyapi.weixin.qq.com/cgi-bin/externalcontact/get?access_token=ACCESS_TOKEN&external_userid=woAJ2GCAAAXtWyujaWJHDDGi0mACAAAA

å“åº”ç¤ºä¾‹:
{
  "errcode": 0,
  "errmsg": "ok",
  "external_contact": {
    "external_userid": "woAJ2GCAAAXtWyujaWJHDDGi0mACAAAA",
    "name": "æå››",
    "type": 1,
    "gender": 1,
    "avatar": "http://wx.qlogo.cn/xxx",
    "corp_name": "XXç§‘æŠ€å…¬å¸",
    "corp_full_name": "XXç§‘æŠ€æœ‰é™å…¬å¸"
  },
  "follow_user": [
    {
      "userid": "rocky",
      "remark": "æéƒ¨é•¿",
      "description": "XXé¡¹ç›®è´Ÿè´£äºº",
      "createtime": 1672887257,
      "add_way": 1,
      "state": "channel_001",
      "remark_corp_name": "XXç§‘æŠ€",
      "remark_mobiles": ["13800000000"],
      "tags": [
        {
          "group_name": "å®¢æˆ·åˆ†ç±»",
          "tag_name": "VIPå®¢æˆ·",
          "tag_id": "etAJ2GCAAAXtWyujaWJHDDGi0mACHAAA",
          "type": 1
        },
        {
          "group_name": "æˆ‘çš„åˆ†ç±»",
          "tag_name": "é‡ç‚¹è·Ÿè¿›",
          "type": 2
        }
      ],
      "status": 1
    },
    {
      "userid": "zhangsan",
      "remark": "é‡‡è´­ç»ç†",
      "createtime": 1672900000,
      "add_way": 2,
      "tags": [
        {
          "group_name": "æˆ‘çš„åˆ†ç±»",
          "tag_name": "æ½œåœ¨å®¢æˆ·",
          "type": 2
        }
      ],
      "status": 1
    }
  ]
}
```

**é‡è¦è¯´æ˜**:
- åŒä¸€ä¸ªå®¢æˆ·è¢«å¤šä¸ªå‘˜å·¥æ·»åŠ æ—¶ï¼Œ`follow_user`æ•°ç»„ä¼šæœ‰å¤šä¸ªå…ƒç´ 
- æ¯ä¸ªå‘˜å·¥å¯¹åŒä¸€å®¢æˆ·çš„å¤‡æ³¨ã€æ ‡ç­¾ã€æ·»åŠ æ–¹å¼éƒ½æ˜¯ç‹¬ç«‹çš„
- éœ€è¦éå†`follow_user`æ•°ç»„ï¼Œä¸ºæ¯ä¸ªå‘˜å·¥-å®¢æˆ·å…³ç³»åˆ›å»ºä¸€æ¡è®°å½•

---

#### t_wecom_customer (å®¢æˆ·è¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| customer_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | æ¥è‡ªé…ç½® |
| wecom_external_user_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“æˆ–åˆ—è¡¨ | `external_userid` |
| name | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `external_contact.name` |
| type | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `external_contact.type`ï¼ˆ1-å¾®ä¿¡ç”¨æˆ· 2-ä¼å¾®ç”¨æˆ·ï¼‰ |
| gender | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `external_contact.gender`ï¼ˆ0-æœªçŸ¥ 1-ç”· 2-å¥³ï¼‰ |
| avatar | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `external_contact.avatar` |
| corp_name | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `external_contact.corp_name` |
| corp_full_name | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `external_contact.corp_full_name` |
| description | âœ… ä¼å¾®API | è·å–å®¢æˆ·è¯¦æƒ… | `external_contact.description` |
| has_conversation_flag | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ä¼šè¯ç»Ÿè®¡ | æ˜¯å¦æœ‰ä¼šè¯è®°å½•ï¼ˆæŸ¥è¯¢æ˜¯å¦æœ‰å‚ä¸çš„ä¼šè¯ï¼‰ |

**é‡è¦è¯´æ˜**:
- å®¢æˆ·åŸºç¡€ä¿¡æ¯ï¼ˆnameã€typeã€genderã€avatarã€corp_nameç­‰ï¼‰æ˜¯ä¼ä¸šçº§å…±äº«çš„
- å‘˜å·¥çº§çš„æ•°æ®ï¼ˆå¤‡æ³¨ã€æ ‡ç­¾ã€æ·»åŠ æ–¹å¼ç­‰ï¼‰å­˜å‚¨åœ¨å…³ç³»è¡¨ `t_wecom_staff_customer_relation`

---

#### t_wecom_group (ç¾¤èŠè¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| group_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | æ¥è‡ªé…ç½® |
| wecom_chat_id | âœ… ä¼å¾®API | æ¶ˆæ¯ä½“æˆ–åˆ—è¡¨ | `roomid` æˆ– `chat_id` |
| name | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.name` |
| wecom_owner_id | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.owner` |
| group_create_time | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.create_time`ï¼ˆæ—¶é—´æˆ³ï¼Œéœ€è½¬æ¢ï¼‰ |
| notice | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.notice` |
| member_version | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.member_version` |
| total_member | âœ… ä¼å¾®API + ğŸ“ è®¡ç®— | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.member_list.length` |
| staff_num | ğŸ“ **è‡ªè¡Œè®¡ç®—** | æˆå‘˜åˆ—è¡¨ç»Ÿè®¡ | ç»Ÿè®¡`member_list`ä¸­type=1çš„æ•°é‡ |
| customer_num | ğŸ“ **è‡ªè¡Œè®¡ç®—** | æˆå‘˜åˆ—è¡¨ç»Ÿè®¡ | ç»Ÿè®¡`member_list`ä¸­type=2çš„æ•°é‡ |
| member_list | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.member_list`ï¼ˆJSONæ•°ç»„ï¼‰ |
| admin_list | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.admin_list`ï¼ˆJSONæ•°ç»„ï¼‰ |
| group_status | âœ… ä¼å¾®API | è·å–å®¢æˆ·ç¾¤è¯¦æƒ… | `group_chat.status`ï¼ˆ0-å·²è§£æ•£ 1-æ­£å¸¸ï¼‰ |
| has_conversation_flag | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ä¼šè¯ç»Ÿè®¡ | æ˜¯å¦æœ‰ä¼šè¯è®°å½• |

**ä¼å¾®API - è·å–å®¢æˆ·ç¾¤è¯¦æƒ…**:
```bash
POST https://qyapi.weixin.qq.com/cgi-bin/externalcontact/groupchat/get?access_token=ACCESS_TOKEN
{
  "chat_id": "wrOgQhDgAAMYQiS5ol9G7gK9JVQUAA",
  "need_name": 1
}

å“åº”ç¤ºä¾‹:
{
  "errcode": 0,
  "errmsg": "ok",
  "group_chat": {
    "chat_id": "wrOgQhDgAAMYQiS5ol9G7gK9JVQUAA",
    "name": "é”€å”®å›¢é˜Ÿ-å®¢æˆ·ç¾¤",
    "owner": "rocky",
    "create_time": 1672887257,
    "notice": "æ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„å®¢æˆ·ç¾¤",
    "member_version": "1",
    "member_list": [
      {
        "userid": "rocky",
        "type": 1,  // 1-ä¼ä¸šæˆå‘˜ 2-å¤–éƒ¨è”ç³»äºº
        "join_time": 1672887257,
        "join_scene": 1,
        "invitor": {
          "userid": "zhangsan"
        },
        "group_nickname": "äº§å“ç»ç†-Rocky",
        "name": "Rocky"
      },
      {
        "userid": "woAJ2GCAAAXtWyujaWJHDDGi0mACAAAA",
        "type": 2,  // å¤–éƒ¨è”ç³»äºº
        "unionid": "ozynqsyj6j",
        "join_time": 1672887300,
        "join_scene": 1,
        "group_nickname": "æéƒ¨é•¿",
        "name": "æå››"
      }
    ],
    "admin_list": [
      {
        "userid": "rocky"
      }
    ],
    "status": 1
  }
}
```

---

### 5. è¾…åŠ©åŠŸèƒ½è¡¨

#### t_wecom_export_task (æ¶ˆæ¯å¯¼å‡ºä»»åŠ¡è¡¨)

| å­—æ®µ | æ•°æ®æ¥æº | API/æ–¹å¼ | è¯´æ˜ |
|------|----------|---------|------|
| task_id | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | è‡ªå¢ä¸»é”® | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |
| corp_id | âœ… ä¼å¾®API | ä¼ä¸šé…ç½® | æ¥è‡ªé…ç½® |
| task_name | ğŸ“ **ç”¨æˆ·è¾“å…¥** | å‰ç«¯è¡¨å• | ç”¨æˆ·å¡«å†™ |
| export_type | ğŸ“ **ç”¨æˆ·é€‰æ‹©** | å‰ç«¯è¡¨å• | ç”¨æˆ·é€‰æ‹©ï¼š1-HTML 2-PDF 3-Excel 4-JSON |
| export_scope | ğŸ“ **ç”¨æˆ·é€‰æ‹©** | å‰ç«¯è¡¨å• | ç”¨æˆ·é€‰æ‹©ï¼š1-å•ä¸ªä¼šè¯ 2-å¤šä¸ªä¼šè¯ 3-æŒ‰æ¡ä»¶ |
| filter_condition | ğŸ“ **ç”¨æˆ·è¾“å…¥** | å‰ç«¯è¡¨å• | ç”¨æˆ·å¡«å†™çš„ç­›é€‰æ¡ä»¶ï¼ˆJSONï¼‰ |
| task_status | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ä»»åŠ¡æµç¨‹ | 1-å¾…å¤„ç† 2-å¤„ç†ä¸­ 3-å·²å®Œæˆ 4-å¤±è´¥ |
| progress_percent | ğŸ“ **è‡ªè¡Œè®¡ç®—** | ä»»åŠ¡è¿›åº¦ | (processed_msg_count / total_msg_count) * 100 |
| total_msg_count | ğŸ“ **è‡ªè¡Œè®¡ç®—** | æ¶ˆæ¯ç»Ÿè®¡ | æ ¹æ®ç­›é€‰æ¡ä»¶ç»Ÿè®¡æ¶ˆæ¯æ€»æ•° |
| processed_msg_count | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | ä»»åŠ¡è¿›åº¦ | å·²å¤„ç†çš„æ¶ˆæ¯æ•° |
| file_path | ğŸ“ **è‡ªè¡Œç”Ÿæˆ** | æ–‡ä»¶å­˜å‚¨ | å¯¼å‡ºæ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ |
| file_url | ğŸ“ **è‡ªè¡Œç”Ÿæˆ** | æ–‡ä»¶å­˜å‚¨ | å¯¼å‡ºæ–‡ä»¶çš„è®¿é—®URL |
| file_size | ğŸ“ **è‡ªè¡Œè®¡ç®—** | æ–‡ä»¶ä¿¡æ¯ | å¯¼å‡ºæ–‡ä»¶çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| error_msg | ğŸ“ **è‡ªè¡Œç»´æŠ¤** | å¼‚å¸¸å¤„ç† | ä»»åŠ¡å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯ |
| expire_time | ğŸ“ **è‡ªè¡Œè®¡ç®—** | è¿‡æœŸç­–ç•¥ | create_time + 7å¤©ï¼ˆå¯é…ç½®ï¼‰ |
| create_user_id | ğŸ“ **å½“å‰ç”¨æˆ·** | ç™»å½•ä¿¡æ¯ | å½“å‰ç™»å½•ç”¨æˆ·ID |

---

## éœ€è¦è‡ªè¡Œè®¡ç®—å’Œæ•´ç†çš„æ•°æ®

### 1. ä¼šè¯ç›¸å…³çš„è®¡ç®—å­—æ®µ

#### ä¼šè¯ç±»å‹åˆ¤æ–­
```java
// é€šè¿‡roomidåˆ¤æ–­ä¼šè¯ç±»å‹
if (StringUtils.isNotEmpty(roomid)) {
    conversation_type = 2;  // ç¾¤èŠ
} else {
    conversation_type = 1;  // å•èŠ
}
```

#### å‚ä¸æ–¹æ•°é‡å’Œå®¢æˆ·æ•°é‡
```java
// ç»Ÿè®¡ä¼šè¯çš„å‚ä¸æ–¹æ•°é‡
int participantCount = conversationParticipantDao.countByConversationId(conversationId);

// ç»Ÿè®¡ä¼šè¯çš„å®¢æˆ·æ•°é‡
int customerCount = conversationParticipantDao.countByConversationIdAndType(
    conversationId,
    ParticipantType.CUSTOMER
);

// æ›´æ–°ä¼šè¯è¡¨
conversationDao.updateCounts(conversationId, participantCount, customerCount);
```

#### æœ€åä¸€æ¡æ¶ˆæ¯ä¿¡æ¯
```java
// æ¯æ¬¡æ’å…¥æ¶ˆæ¯æ—¶ï¼Œæ›´æ–°ä¼šè¯è¡¨çš„æœ€åæ¶ˆæ¯å­—æ®µ
public void updateLastMessage(Long conversationId, WecomMessage message) {
    ConversationUpdateForm updateForm = new ConversationUpdateForm();
    updateForm.setConversationId(conversationId);
    updateForm.setLastMsgId(message.getMsgId());
    updateForm.setLastMsgType(message.getMsgType());
    updateForm.setLastMsgContent(extractMsgContentPreview(message));  // æå–æ‘˜è¦
    updateForm.setLastMsgTime(message.getMsgTime());
    updateForm.setLastMsgSenderId(message.getFromId());
    updateForm.setLastMsgSenderName(message.getFromName());

    conversationDao.updateLastMessage(updateForm);
}
```

---

### 2. æ¶ˆæ¯ä¼šè¯å…³è”è¡¨çš„to_idè®¡ç®— â­â­â­

```java
/**
 * æ¶ˆæ¯è·¯ç”±å¤„ç†ï¼šåˆ›å»ºæ¶ˆæ¯ä¸ä¼šè¯çš„å…³è”è®°å½•
 * @author wangxiao
 */
public void routeMessage(WecomMessage message) {
    String roomid = message.getRoomId();
    List<String> tolist = message.getToList();

    // åœºæ™¯1ï¼šç¾¤èŠæ¶ˆæ¯
    if (StringUtils.isNotEmpty(roomid)) {
        // æŸ¥è¯¢æˆ–åˆ›å»ºç¾¤èŠä¼šè¯
        Long conversationId = findOrCreateGroupConversation(roomid);

        // åˆ›å»º1æ¡å…³è”è®°å½•
        WecomMessageConversation route = new WecomMessageConversation();
        route.setMsgId(message.getMsgId());
        route.setMessageId(message.getMessageId());
        route.setConversationId(conversationId);
        route.setFromId(message.getFromId());
        route.setToId(roomid);  // ç¾¤èŠæ—¶ï¼Œto_id = roomid
        route.setRouteType(RouteType.GROUP_CHAT);

        messageConversationDao.insert(route);
    }
    // åœºæ™¯2ï¼šå•èŠæˆ–ç¾¤å‘æ¶ˆæ¯
    else {
        for (String toUserId : tolist) {
            // æŸ¥è¯¢æˆ–åˆ›å»ºå•èŠä¼šè¯
            Long conversationId = findOrCreateSingleConversation(
                message.getFromId(),
                toUserId
            );

            // ä¸ºæ¯ä¸ªæ¥æ”¶è€…åˆ›å»º1æ¡å…³è”è®°å½•
            WecomMessageConversation route = new WecomMessageConversation();
            route.setMsgId(message.getMsgId());
            route.setMessageId(message.getMessageId());
            route.setConversationId(conversationId);
            route.setFromId(message.getFromId());
            route.setToId(toUserId);  // å•èŠæ—¶ï¼Œto_id = æ¥æ”¶æ–¹UserID
            route.setRouteType(RouteType.SINGLE_CHAT);

            messageConversationDao.insert(route);
        }
    }
}
```

---

### 3. å‚ä¸æ–¹ç±»å‹åˆ¤æ–­

```java
/**
 * åˆ¤æ–­å‚ä¸æ–¹ç±»å‹
 * @param participantId å‚ä¸æ–¹ID
 * @return 1-å®¢æˆ· 2-å‘˜å·¥
 */
public int identifyParticipantType(String participantId) {
    // ä¼å¾®å¤–éƒ¨è”ç³»äººIDå›ºå®šæ ¼å¼ï¼šwm + éšæœºå­—ç¬¦
    if (participantId.startsWith("wm")) {
        return ParticipantType.CUSTOMER;  // 1-å®¢æˆ·
    } else {
        return ParticipantType.STAFF;  // 2-å‘˜å·¥
    }
}
```

---

### 4. åª’ä½“æ–‡ä»¶åç”Ÿæˆ

```java
/**
 * ç”Ÿæˆåª’ä½“æ–‡ä»¶å
 * @param message æ¶ˆæ¯å¯¹è±¡
 * @param mediaType åª’ä½“ç±»å‹
 * @return æ–‡ä»¶å
 */
public String generateMediaFileName(WecomMessage message, String mediaType) {
    // æ–‡ä»¶æ¶ˆæ¯ç›´æ¥ä½¿ç”¨åŸæ–‡ä»¶å
    if ("file".equals(mediaType)) {
        JSONObject rawContent = message.getRawContent();
        return rawContent.getJSONObject("file").getString("filename");
    }

    // å…¶ä»–åª’ä½“ç±»å‹ç”Ÿæˆæ–‡ä»¶åï¼šç±»å‹_æ—¥æœŸæ—¶é—´.æ‰©å±•å
    String timestamp = DateUtil.format(message.getMsgTime(), "yyyyMMdd_HHmmss");
    String ext = getFileExtension(mediaType);

    return String.format("%s_%s.%s", mediaType, timestamp, ext);
}

private String getFileExtension(String mediaType) {
    switch (mediaType) {
        case "image": return "jpg";
        case "voice": return "amr";
        case "video": return "mp4";
        case "emotion": return "gif";
        default: return "dat";
    }
}
```

---

### 5. ç¾¤èŠæˆå‘˜ç»Ÿè®¡

```java
/**
 * ç»Ÿè®¡ç¾¤èŠæˆå‘˜æ•°é‡
 * @param memberList ç¾¤æˆå‘˜åˆ—è¡¨ï¼ˆä»ä¼å¾®APIè·å–ï¼‰
 * @return [æ€»æˆå‘˜æ•°, å‘˜å·¥æ•°, å®¢æˆ·æ•°]
 */
public int[] countGroupMembers(List<GroupMember> memberList) {
    int totalMember = memberList.size();
    int staffNum = 0;
    int customerNum = 0;

    for (GroupMember member : memberList) {
        if (member.getType() == 1) {
            staffNum++;  // ä¼ä¸šæˆå‘˜
        } else if (member.getType() == 2) {
            customerNum++;  // å¤–éƒ¨è”ç³»äºº
        }
    }

    return new int[]{totalMember, staffNum, customerNum};
}
```

---

### 6. ä¼šè¯æŸ¥è¯¢å’Œåˆ›å»ºé€»è¾‘

```java
/**
 * æŸ¥è¯¢æˆ–åˆ›å»ºå•èŠä¼šè¯
 * @param userId1 å‚ä¸æ–¹1
 * @param userId2 å‚ä¸æ–¹2
 * @return ä¼šè¯ID
 */
public Long findOrCreateSingleConversation(String userId1, String userId2) {
    // 1. æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨ä¼šè¯
    List<Long> conversationIds = conversationParticipantDao.findConversationsByParticipants(
        Arrays.asList(userId1, userId2)
    );

    if (!conversationIds.isEmpty()) {
        return conversationIds.get(0);
    }

    // 2. ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ä¼šè¯
    WecomConversation conversation = new WecomConversation();
    conversation.setCorpId(corpId);
    conversation.setConversationType(ConversationType.SINGLE_CHAT);
    conversation.setRoomId(null);
    conversation.setParticipantCount(2);

    // åˆ¤æ–­æ˜¯å¦ä¸ºå¤–éƒ¨ä¼šè¯ï¼ˆæœ‰å®¢æˆ·å‚ä¸ï¼‰
    int customerCount = 0;
    if (userId1.startsWith("wm")) customerCount++;
    if (userId2.startsWith("wm")) customerCount++;
    conversation.setCustomerCount(customerCount);

    conversationDao.insert(conversation);
    Long conversationId = conversation.getConversationId();

    // 3. åˆ›å»ºå‚ä¸æ–¹å…³ç³»
    createParticipantRelation(conversationId, userId1);
    createParticipantRelation(conversationId, userId2);

    return conversationId;
}

/**
 * æŸ¥è¯¢æˆ–åˆ›å»ºç¾¤èŠä¼šè¯
 * @param roomId ç¾¤èŠID
 * @return ä¼šè¯ID
 */
public Long findOrCreateGroupConversation(String roomId) {
    // 1. æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨ä¼šè¯
    WecomConversation conversation = conversationDao.findByRoomId(corpId, roomId);

    if (conversation != null) {
        return conversation.getConversationId();
    }

    // 2. ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ä¼šè¯
    // è°ƒç”¨ä¼å¾®APIè·å–ç¾¤è¯¦æƒ…
    GroupChatDetail groupDetail = wecomApiService.getGroupChatDetail(roomId);

    conversation = new WecomConversation();
    conversation.setCorpId(corpId);
    conversation.setConversationType(ConversationType.GROUP_CHAT);
    conversation.setRoomId(roomId);
    conversation.setRoomName(groupDetail.getName());

    // ç»Ÿè®¡æˆå‘˜æ•°é‡
    int[] counts = countGroupMembers(groupDetail.getMemberList());
    conversation.setParticipantCount(counts[0]);
    conversation.setCustomerCount(counts[2]);

    conversationDao.insert(conversation);
    Long conversationId = conversation.getConversationId();

    // 3. åˆ›å»ºå‚ä¸æ–¹å…³ç³»
    for (GroupMember member : groupDetail.getMemberList()) {
        createParticipantRelation(conversationId, member.getUserid());
    }

    return conversationId;
}
```

---

## æ•°æ®è·å–æµç¨‹

### 1. æ¶ˆæ¯æ‹‰å–å’Œå¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ‹‰å–æ¶ˆæ¯                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¼å¾®ä¼šè¯å­˜æ¡£æä¾›SDKæ–¹å¼æ‹‰å–æ¶ˆæ¯:                         â”‚
â”‚ - ä½¿ç”¨ä¼å¾®æä¾›çš„SDKè¿›è¡Œæ¶ˆæ¯æ‹‰å–                          â”‚
â”‚ - SDKè‡ªåŠ¨ç®¡ç†seqæ¸¸æ ‡å’Œæ¶ˆæ¯æ¥æ”¶                           â”‚
â”‚ - è¿”å›: åŠ å¯†çš„æ¶ˆæ¯åˆ—è¡¨                                   â”‚
â”‚                                                          â”‚
â”‚ æ³¨æ„: ä¸æ˜¯é€šè¿‡REST APIç›´æ¥æ‹‰å–,è€Œæ˜¯ä½¿ç”¨SDKæ–¹å¼          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è§£å¯†æ¶ˆæ¯                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è°ƒç”¨ wx-finance API: /api/decrypt/full             â”‚
â”‚ æˆ–ä½¿ç”¨ä¼å¾®SDKè§£å¯†ï¼ˆæœ¬åœ°éƒ¨ç½²ï¼‰                       â”‚
â”‚ è¿”å›: è§£å¯†åçš„JSONæ¶ˆæ¯ä½“                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è§£ææ¶ˆæ¯ä½“                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æå–é€šç”¨å­—æ®µ: msgid, from, tolist, roomid, msgtime â”‚
â”‚ æ ¹æ®msgtypeæå–ç‰¹å®šå­—æ®µ                             â”‚
â”‚ åˆ¤æ–­æ¶ˆæ¯ç±»å‹å’Œä¼šè¯ç±»å‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è¡¥å……å‚ä¸æ–¹ä¿¡æ¯                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ£€æŸ¥from_idæ˜¯å¦å·²å­˜åœ¨äºå‘˜å·¥/å®¢æˆ·è¡¨                  â”‚
â”‚ ä¸å­˜åœ¨åˆ™è°ƒç”¨APIè·å–è¯¦æƒ…å¹¶å…¥åº“:                      â”‚
â”‚ - å‘˜å·¥: /cgi-bin/user/get                           â”‚
â”‚ - å®¢æˆ·: /cgi-bin/externalcontact/get                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æŸ¥è¯¢æˆ–åˆ›å»ºä¼šè¯                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•èŠ: æ ¹æ®from+toå‚ä¸æ–¹ç»„åˆæŸ¥è¯¢ä¼šè¯                â”‚
â”‚ ç¾¤èŠ: æ ¹æ®roomidæŸ¥è¯¢ä¼šè¯                            â”‚
â”‚ ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ä¼šè¯ + åˆ›å»ºå‚ä¸æ–¹å…³ç³»                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ’å…¥æ¶ˆæ¯è®°å½•                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ’å…¥ t_wecom_message                                â”‚
â”‚ å¦‚æœæœ‰åª’ä½“æ–‡ä»¶ï¼Œæ’å…¥ t_wecom_message_media         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. åˆ›å»ºæ¶ˆæ¯ä¼šè¯å…³è”è®°å½• â­æ ¸å¿ƒ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ’å…¥ t_wecom_message_conversation                   â”‚
â”‚ å•èŠ: 1æ¡è®°å½• (to_id = æ¥æ”¶æ–¹UserID)               â”‚
â”‚ ç¾¤èŠ: 1æ¡è®°å½• (to_id = roomid)                      â”‚
â”‚ ç¾¤å‘: Næ¡è®°å½• (æ¯ä¸ªæ¥æ”¶è€…ä¸€æ¡)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. æ›´æ–°ä¼šè¯è¡¨æœ€åæ¶ˆæ¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ›´æ–° t_wecom_conversation çš„ last_msg_* å­—æ®µ       â”‚
â”‚ å¢é‡æ›´æ–° msg_count                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. æ›´æ–°é…ç½®è¡¨æ¸¸æ ‡                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ›´æ–° t_wecom_corp_config çš„ chat_seq               â”‚
â”‚ ç”¨äºä¸‹æ¬¡æ–­ç‚¹ç»­ä¼                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. åª’ä½“æ–‡ä»¶ä¸‹è½½æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æµ‹åª’ä½“æ¶ˆæ¯                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ msgtype in (image, voice, video, file, emotion)    â”‚
â”‚ æå– sdkfileid                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆ›å»ºåª’ä½“æ–‡ä»¶è®°å½•                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ’å…¥ t_wecom_message_media                          â”‚
â”‚ download_status = 0 (å¾…ä¸‹è½½)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å¼‚æ­¥ä¸‹è½½æ–‡ä»¶                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ›´æ–° download_status = 1 (ä¸‹è½½ä¸­)                   â”‚
â”‚ è°ƒç”¨ä¼å¾®API: /cgi-bin/media/get?access_token=ACCESS_TOKEN&sdkfileid={sdkfileid} â”‚
â”‚ æˆ–ä½¿ç”¨ wx-finance API: /api/media/download         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ä¿å­˜æ–‡ä»¶åˆ°å­˜å‚¨                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœ¬åœ°å­˜å‚¨: /data/wecom/media/{date}/{filename}      â”‚
â”‚ æˆ–äº‘å­˜å‚¨: OSS/COS/S3                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ’å…¥æ–‡ä»¶å­˜å‚¨è®°å½•                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ’å…¥ t_file (SmartAdminæ–‡ä»¶è¡¨)                      â”‚
â”‚ è·å– file_id                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ›´æ–°åª’ä½“æ–‡ä»¶è®°å½•                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ›´æ–° t_wecom_message_media:                         â”‚
â”‚ - file_id = xxx                                     â”‚
â”‚ - download_status = 2 (å·²ä¸‹è½½)                      â”‚
â”‚ - download_time = NOW()                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. å¼‚å¸¸å¤„ç†                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸‹è½½å¤±è´¥:                                            â”‚
â”‚ - download_status = 3 (å¤±è´¥)                        â”‚
â”‚ - download_error_msg = "é”™è¯¯ä¿¡æ¯"                   â”‚
â”‚ - å®šæ—¶ä»»åŠ¡é‡è¯• (æœ€å¤š3æ¬¡)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. å‚ä¸æ–¹ä¿¡æ¯åŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é¦–æ¬¡æ¶ˆæ¯è§¦å‘åŒæ­¥                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§£ææ¶ˆæ¯è·å–å‚ä¸æ–¹ID (from, tolist)                â”‚
â”‚ æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºæ•°æ®åº“                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è°ƒç”¨ä¼å¾®APIè·å–è¯¦æƒ…                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‘˜å·¥: GET /cgi-bin/user/get?userid=xxx              â”‚
â”‚ å®¢æˆ·: POST /cgi-bin/externalcontact/get             â”‚
â”‚       {"external_userid": "xxx"}                    â”‚
â”‚ ç¾¤èŠ: POST /cgi-bin/externalcontact/groupchat/get   â”‚
â”‚       {"chat_id": "xxx"}                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è§£æAPIå“åº”                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‘˜å·¥: æå– name, mobile, position, avatarç­‰         â”‚
â”‚ å®¢æˆ·: æå– name, type, gender, avatarç­‰             â”‚
â”‚       è§£æ follow_user æ•°ç»„ (å‘˜å·¥-å®¢æˆ·å…³ç³»)        â”‚
â”‚ ç¾¤èŠ: æå– name, owner, member_listç­‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ’å…¥æˆ–æ›´æ–°æ•°æ®åº“                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ t_wecom_staff / t_wecom_customer / t_wecom_group    â”‚
â”‚ t_wecom_staff_customer_relation (å®¢æˆ·çš„follow_user) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å®šæœŸå…¨é‡åŒæ­¥ (å¯é€‰)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨ï¼‰:                                â”‚
â”‚ - åŒæ­¥å‘˜å·¥åˆ—è¡¨: /cgi-bin/user/list                  â”‚
â”‚ - åŒæ­¥å®¢æˆ·åˆ—è¡¨: /cgi-bin/externalcontact/list       â”‚
â”‚ - åŒæ­¥ç¾¤èŠåˆ—è¡¨: /cgi-bin/externalcontact/groupchat/ â”‚
â”‚                  list                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®åŒæ­¥ç­–ç•¥

### 1. æ¶ˆæ¯æ‹‰å–ç­–ç•¥

**å®æ—¶æ‹‰å–** (æ¨è):
- å®šæ—¶ä»»åŠ¡æ¯10ç§’æ‹‰å–ä¸€æ¬¡
- ä½¿ç”¨ `chat_seq` æ¸¸æ ‡å®ç°æ–­ç‚¹ç»­ä¼ 
- æ‹‰å–æ•°é‡: æ¯æ¬¡1000æ¡ï¼ˆä¼å¾®APIé™åˆ¶ï¼‰

```java
@Scheduled(fixedDelay = 10000)  // æ¯10ç§’æ‰§è¡Œä¸€æ¬¡
public void pullMessages() {
    WecomCorpConfig config = configDao.getEnabledConfig();
    Long chatSeq = config.getChatSeq();

    // è°ƒç”¨ä¼å¾®APIæ‹‰å–æ¶ˆæ¯
    List<WecomMessage> messages = wecomApiService.pullMessages(chatSeq, 1000);

    // æ‰¹é‡å¤„ç†æ¶ˆæ¯
    for (WecomMessage message : messages) {
        processMessage(message);
    }

    // æ›´æ–°æ¸¸æ ‡
    if (!messages.isEmpty()) {
        Long maxSeq = messages.stream()
            .map(WecomMessage::getSeq)
            .max(Long::compareTo)
            .orElse(chatSeq);

        configDao.updateChatSeq(maxSeq);
    }
}
```

**å†å²æ¶ˆæ¯æ‹‰å–**:
- é¦–æ¬¡å¼€é€šä¼šè¯å­˜æ¡£åï¼Œæ‹‰å–å†å²æ¶ˆæ¯
- åˆ†æ‰¹æ‹‰å–ï¼Œé¿å…APIé™æµ
- æ¯æ‰¹1000æ¡ï¼Œé—´éš”1ç§’

---

### 2. å‚ä¸æ–¹ä¿¡æ¯åŒæ­¥ç­–ç•¥

**æŒ‰éœ€åŒæ­¥** (é¦–é€‰):
- æ¶ˆæ¯å¤„ç†æ—¶æ£€æµ‹æ–°å‚ä¸æ–¹
- è°ƒç”¨APIè·å–è¯¦æƒ…åå…¥åº“
- ä¼˜ç‚¹: å®æ—¶æ€§å¥½ï¼ŒAPIè°ƒç”¨å°‘

**å®šæœŸå…¨é‡åŒæ­¥** (è¾…åŠ©):
- æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
- åŒæ­¥æ‰€æœ‰å‘˜å·¥ã€å®¢æˆ·ã€ç¾¤èŠä¿¡æ¯
- æ›´æ–°ç°æœ‰è®°å½•ï¼Œæ’å…¥æ–°è®°å½•
- ä¼˜ç‚¹: æ•°æ®å®Œæ•´æ€§å¥½ï¼Œè¡¥é½é—æ¼

```java
@Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹
public void syncAllContacts() {
    // 1. åŒæ­¥å‘˜å·¥
    syncAllStaff();

    // 2. åŒæ­¥å®¢æˆ·
    syncAllCustomers();

    // 3. åŒæ­¥ç¾¤èŠ
    syncAllGroups();
}
```

---

### 3. åª’ä½“æ–‡ä»¶ä¸‹è½½ç­–ç•¥

**å¼‚æ­¥ä¸‹è½½** (æ¨è):
- æ¶ˆæ¯å¤„ç†æ—¶åªåˆ›å»ºåª’ä½“è®°å½•ï¼Œä¸ç«‹å³ä¸‹è½½
- åå°å®šæ—¶ä»»åŠ¡æ‰«æå¾…ä¸‹è½½æ–‡ä»¶
- æ§åˆ¶å¹¶å‘æ•°é‡ï¼Œé¿å…å ç”¨è¿‡å¤šå¸¦å®½

```java
@Scheduled(fixedDelay = 30000)  // æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
public void downloadMediaFiles() {
    // æŸ¥è¯¢å¾…ä¸‹è½½çš„åª’ä½“æ–‡ä»¶ï¼ˆé™åˆ¶å¹¶å‘æ•°é‡ï¼‰
    List<WecomMessageMedia> mediaList = mediaDao.findPendingDownload(10);

    // å¹¶å‘ä¸‹è½½
    mediaList.parallelStream().forEach(media -> {
        try {
            downloadMediaFile(media);
        } catch (Exception e) {
            log.error("ä¸‹è½½åª’ä½“æ–‡ä»¶å¤±è´¥: {}", media.getSdkFileId(), e);
            updateDownloadStatus(media.getMediaId(), 3, e.getMessage());
        }
    });
}
```

**ä¸‹è½½å¤±è´¥é‡è¯•**:
- æœ€å¤šé‡è¯•3æ¬¡
- é‡è¯•é—´éš”: 1åˆ†é’Ÿã€5åˆ†é’Ÿã€30åˆ†é’Ÿ
- 3æ¬¡å¤±è´¥åæ ‡è®°ä¸ºæ°¸ä¹…å¤±è´¥

---

### 4. ç¼“å­˜ç­–ç•¥

**çƒ­ç‚¹æ•°æ®ç¼“å­˜**:
```java
// ä¼šè¯åˆ—è¡¨ç¼“å­˜ (5åˆ†é’Ÿ)
@Cacheable(value = "wecom:conv:list", key = "#userId + ':' + #page", expire = 300)
public PageResult<ConversationVO> getConversationList(String userId, int page);

// å‘˜å·¥ä¿¡æ¯ç¼“å­˜ (30åˆ†é’Ÿ)
@Cacheable(value = "wecom:staff", key = "#userId", expire = 1800)
public WecomStaff getStaffByUserId(String userId);

// å®¢æˆ·ä¿¡æ¯ç¼“å­˜ (30åˆ†é’Ÿ)
@Cacheable(value = "wecom:customer", key = "#externalUserId", expire = 1800)
public WecomCustomer getCustomerByExternalUserId(String externalUserId);
```

**ç¼“å­˜å¤±æ•ˆç­–ç•¥**:
- æ–°æ¶ˆæ¯åˆ°è¾¾: æ¸…é™¤å¯¹åº”ä¼šè¯çš„åˆ—è¡¨ç¼“å­˜
- å‚ä¸æ–¹ä¿¡æ¯æ›´æ–°: æ¸…é™¤å¯¹åº”çš„å‘˜å·¥/å®¢æˆ·ç¼“å­˜
- å…¨é‡åŒæ­¥å: æ¸…é™¤æ‰€æœ‰å‚ä¸æ–¹ç¼“å­˜

---

## æ€»ç»“

### ä¼å¾®APIç›´æ¥æä¾›çš„æ•°æ®ï¼ˆâœ…ï¼‰

**æ¶ˆæ¯æ ¸å¿ƒå­—æ®µ**:
- `msgid`, `action`, `from`, `tolist`, `roomid`, `msgtime`, `msgtype`
- æ¶ˆæ¯å†…å®¹: `text.content`, `image.sdkfileid`, `file.filename` ç­‰
- å®Œæ•´çš„æ¶ˆæ¯JSONï¼ˆraw_contentï¼‰

**å‚ä¸æ–¹åŸºç¡€ä¿¡æ¯**:
- å‘˜å·¥: `name`, `mobile`, `position`, `avatar`, `department`, `status`
- å®¢æˆ·: `name`, `type`, `gender`, `avatar`, `corp_name`
- ç¾¤èŠ: `name`, `owner`, `create_time`, `member_list`, `admin_list`

**å‘˜å·¥-å®¢æˆ·å…³ç³»**:
- `remark`, `description`, `add_way`, `add_time`, `tags`, `status`

---

### éœ€è¦è‡ªè¡Œè®¡ç®—å’Œæ•´ç†çš„æ•°æ®ï¼ˆğŸ“ï¼‰

**ä¼šè¯ç®¡ç†**:
- `conversation_id` (è‡ªå¢ä¸»é”®)
- `conversation_type` (é€šè¿‡roomidåˆ¤æ–­)
- `participant_count` (ç»Ÿè®¡å…³ç³»è¡¨)
- `customer_count` (ç»Ÿè®¡å…³ç³»è¡¨)
- `last_msg_*` (æ¯æ¡æ¶ˆæ¯æ›´æ–°)
- `msg_count` (å¢é‡æˆ–å®šæœŸç»Ÿè®¡)

**æ¶ˆæ¯ä¼šè¯å…³è”** â­æ ¸å¿ƒ:
- `to_id` (å•èŠ=tolist[0], ç¾¤èŠ=roomid)
- `route_type` (roomidåˆ¤æ–­)
- ç¾¤å‘æ¶ˆæ¯ç”Ÿæˆå¤šæ¡å…³è”è®°å½•

**å‚ä¸æ–¹å…³ç³»**:
- `participant_type` (é€šè¿‡IDæ ¼å¼åˆ¤æ–­)
- `relation_start_time` (é¦–æ¡æ¶ˆæ¯æ—¶é—´æˆ–ç¾¤API)
- `relation_end_time` (é€€ç¾¤/åˆ å¥½å‹äº‹ä»¶)
- `is_active` (relation_end_timeåˆ¤æ–­)

**åª’ä½“æ–‡ä»¶**:
- `file_name` (æ–‡ä»¶æ¶ˆæ¯ç›´æ¥ç”¨ï¼Œå…¶ä»–ç”Ÿæˆ)
- `file_ext` (ä»æ–‡ä»¶åæˆ–sdkfileidæå–)
- `file_id` (ä¸‹è½½åæ’å…¥t_fileè·å–)
- `download_status` (ä¸‹è½½æµç¨‹ç»´æŠ¤)

**ç³»ç»ŸçŠ¶æ€**:
- `chat_seq` (æ¶ˆæ¯æ‹‰å–æ¸¸æ ‡)
- `chat_pull_status` (æ‹‰å–çŠ¶æ€)
- `has_conversation_flag` (ä¼šè¯ç»Ÿè®¡)

---

### å…³é”®è®¾è®¡å†³ç­–

1. **æ¶ˆæ¯ä¼šè¯è§£è€¦** â­â­â­:
   - æ¶ˆæ¯è¡¨ä¸å­˜å‚¨conversation_id
   - é€šè¿‡å…³è”è¡¨å»ºç«‹å¤šå¯¹å¤šå…³ç³»
   - to_idå†—ä½™å­—æ®µå®ç°æé€ŸæŸ¥è¯¢

2. **æŒ‰éœ€åŒæ­¥ + å®šæœŸå…¨é‡**:
   - é¦–æ¬¡é‡åˆ°æ–°å‚ä¸æ–¹æ—¶è°ƒç”¨API
   - å®šæœŸå…¨é‡åŒæ­¥ä¿è¯æ•°æ®å®Œæ•´æ€§

3. **å¼‚æ­¥ä¸‹è½½åª’ä½“æ–‡ä»¶**:
   - æ¶ˆæ¯å¤„ç†ä¸é˜»å¡äºæ–‡ä»¶ä¸‹è½½
   - åå°ä»»åŠ¡æ‰¹é‡ä¸‹è½½ï¼Œæ§åˆ¶å¹¶å‘

4. **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**:
   - çƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼ˆä¼šè¯åˆ—è¡¨ã€å‚ä¸æ–¹ä¿¡æ¯ï¼‰
   - ç²¾å‡†å¤±æ•ˆï¼ˆæ–°æ¶ˆæ¯ã€ä¿¡æ¯æ›´æ–°ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-14
**ç»´æŠ¤äºº**: wangxiao